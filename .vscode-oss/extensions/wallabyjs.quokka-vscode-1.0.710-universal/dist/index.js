/*
 * quokka-vscode - v1.0.710
 * Copyright (c) 2017-2025 WallabyJs - All Rights Reserved.
 */

!function e(t,i,s){process.env.WALLABY_PRODUCTION=!0;var o="function"==typeof require&&require;module.exports=function n(a,r){if(!i[a]){if(!t[a]){var l="function"==typeof require&&require;if(!r&&l)return l(a,!0);if(o)return o(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var d=i[a]={exports:{}};t[a][0].call(d.exports,function(e){var i=t[a][1][e];return n(i||e)},d,d.exports,e,t,i,s)}return i[a].exports}(s[0])}({1:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,n){function a(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,r)}l((s=s.apply(e,t||[])).next())})};let o=e("os"),n=e("fs"),a=e("path"),r=e("vscode"),l=e("./lib/compositeDisposable").default;const c=e("./lib/startViewPanel");class d{activate(t){return s(this,void 0,void 0,function*(){r.window.registerWebviewPanelSerializer&&r.window.registerWebviewPanelSerializer(c.viewType,{deserializeWebviewPanel(e){return s(this,void 0,void 0,function*(){c.revive(e,t)})}});let i=this;i._disposables=new l;let o=e(t.globalState.get("corePath")),n={context:t,coreClient:o,deactivate:()=>i.deactivate(),version:d._getVersion()},a=e("./lib/controller");i._controller=new a(n),i._controller.activate(),i._disposables.add(()=>i._controller.deactivate())})}static _getVersion(){let e=1,t=0;try{let i=r.version.split(".");e=parseInt(i[0],10),t=parseInt(i[1],10)}catch(e){}return{major:e,minor:t}}deactivate(){this._disposables.dispose()}}i.activate=(e=>{let t=new d;e.subscriptions.push({dispose:()=>t.deactivate()});const i=d._getVersion();if(i.major<=1&&i.minor<18){const e=process.exit,i=function(){t.deactivate(),e.apply(process,arguments)},s=process.exit=function(){i.apply(null,arguments)};process.on("SIGINT",function(){s.apply(null,arguments)}),process.on("SIGTERM",function(){s.apply(null,arguments)}),process.on("exit",function(){s.apply(null,arguments)})}try{let t=r.workspace.getConfiguration();if(t){let i=t.get("quokka.colors",{});i&&Object.keys(i).forEach(t=>{try{if(!t)return;let s=e.asAbsolutePath(a.join("images",t+".svg"));if(!n.existsSync(s))return;const r=('<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="16px" height="16px">'+o.EOL+"  <g>"+o.EOL+'    <rect x="2.5" y="2.5" width="11" height="11" rx="2.5" ry="2.5" style="fill:#62b455;fill-opacity:1;" />'+o.EOL+"  </g>"+o.EOL+"</svg>").replace(/fill:#.[^;]*/,"fill:"+i[t]),l=n.readFileSync(s).toString();r.replace(/\r/g,"")!==l.replace(/\r/g,"")&&n.writeFileSync(s,r)}catch(e){console.error("Failed to set icon "+t+" type to "+i[t]+". "+e.message)}})}}catch(e){}t.activate(e)})},{"./lib/compositeDisposable":6,"./lib/controller":7,"./lib/startViewPanel":12,fs:void 0,os:void 0,path:void 0,vscode:void 0}],2:[function(e,t,i){"use strict";var s=e("vscode"),o=e("path");i.activate=function(t){var i=s.workspace.getConfiguration()&&s.workspace.getConfiguration().get("quokka.debug",!1);i?(global.originalRequire=e,e("ts-node").register({swc:!0,transpileOnly:!0,project:o.join(o.relative(process.cwd(),__dirname),"tsconfig.json"),ignore:["(?:^|/)../","(?:^|/)node_modules/"]}),t.globalState.update("corePath","../wallaby/client")):t.globalState.update("corePath","./wallaby/client"),i?e("./extension").activate(t):"dist"===o.basename(__dirname)?e("./extension").activate(t):(global.originalRequire=e,e("./dist/index").activate(t))}},{"./extension":1,path:void 0,"ts-node":void 0,vscode:void 0}],3:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,n){function a(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,r)}l((s=s.apply(e,t||[])).next())})};Object.defineProperty(i,"__esModule",{value:!0}),i.InteractiveExamples=void 0;const o=e("path"),n=e("fs"),a=e("os"),r=e("https");i.InteractiveExamples=class{constructor(){this.examples=[],this.disposable=void 0,this.disposed=!1,this.configPath=o.join(a.homedir(),".quokka","examples.json"),this.examplesPath=o.join(a.homedir(),".quokka","interactive-examples")}httpGet(e){return s(this,void 0,void 0,function*(){return new Promise((t,i)=>{r.get(e,{headers:{"User-Agent":"Quokka-VSCode-Extension"}},e=>s(this,void 0,void 0,function*(){if(e.statusCode&&e.statusCode>=300&&e.statusCode<400&&e.headers.location)try{const s=yield this.httpGet(e.headers.location);t(s)}catch(e){i(e)}else{let i=Buffer.alloc(0);e.on("data",e=>{i=Buffer.concat([i,e])}),e.on("end",()=>{t(i)})}})).on("error",e=>{i(e)})})})}deleteOldExamplesFolder(){const e=function(t){n.existsSync(t)&&(n.readdirSync(t).forEach(function(i){var s=o.join(t,i);n.lstatSync(s).isDirectory()?e(s):n.unlinkSync(s)}),n.rmdirSync(t))};e(this.examplesPath)}getExampleMetaInformation(){let e=[];const t=this.examplesPath,i=function(s){n.existsSync(s)&&n.readdirSync(s).forEach(function(a){var r=o.join(s,a);if(n.lstatSync(r).isDirectory())i(r);else if("meta.json"===a)try{const i=JSON.parse(n.readFileSync(r).toString());e=[...e,...i.map(e=>(e.folder=o.relative(t,s),e.label=e.title,delete e.title,e))]}catch(e){}})};return i(this.examplesPath),e}initialize(){return s(this,void 0,void 0,function*(){try{if(n.existsSync(this.configPath)){const e=JSON.parse(n.readFileSync(this.configPath).toString());this.examples=e.examples,this.nextCheckTime=e.nextCheckTime,this.sha=e.sha,this.date=e.date}}catch(e){console.error(e)}if(!this.nextCheckTime||(new Date).getTime()>this.nextCheckTime){const t="https://api.github.com/repos/wallabyjs/interactive-examples/commits"+(this.date?"?since"+this.date:"");try{const i=yield this.httpGet(t),s=JSON.parse(i.toString());if(s.length&&this.sha!==s[0].sha){const t=yield this.httpGet("https://github.com/wallabyjs/interactive-examples/archive/master.zip");new(e("adm-zip"))(t).extractAllTo(o.join(a.homedir(),".quokka"),!0),this.deleteOldExamplesFolder(),n.renameSync(o.join(a.homedir(),".quokka","interactive-examples-master"),this.examplesPath),this.examples=this.getExampleMetaInformation(),this.sha=s[0].sha,this.date=s[0].commit.committer.date,this.nextCheckTime=(new Date).getTime()+864e5,n.writeFileSync(this.configPath,JSON.stringify({examples:this.examples,nextCheckTime:this.nextCheckTime,sha:this.sha,date:this.date}))}}catch(e){console.error(e)}}})}getExamples(){return this.examples||[]}getContent(e){try{return n.readFileSync(o.join(this.examplesPath,e.folder,e.fileName)).toString()}catch(e){return""}}getLanguage(e){return"ts"===e.type?"TypeScript":"JavaScript"}getRelativeFilePath(e){return o.join(e.folder,e.fileName)}dispose(){this.disposable&&this.disposable.dispose(),this.disposed=!0}}},{"adm-zip":void 0,fs:void 0,https:void 0,os:void 0,path:void 0}],4:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SalesEvent=void 0;const s=e("path"),o=e("fs"),n=e("os"),a=e("vscode"),r=e("./licenseReader"),l=s.join(n.homedir(),".quokka","state.json"),c=[{saleName:"Wallaby 10th Birthday Sale",discount:40,start:new Date(Date.UTC(2025,0,22,0,0,0,0)).getTime(),end:new Date(Date.UTC(2025,0,29,0,0,0,0)).getTime()}];class d{constructor(e,t){this.disposable=void 0,this.disposed=!1,this.gift=void 0;const i=c.reduce((e,t)=>((void 0===e.start||e.start>t.start)&&(e.start=t.start),(void 0===e.end||e.end<t.end)&&(e.end=t.end),e),{start:void 0,end:void 0});this.start=new Date(i.start),this.end=new Date(i.end),this.nextCheckTime=void 0,this.buildDate=e||new Date,this.gift=t,this.setup()}setup(){if(a.env.remoteName)return;const e=r.LicenseReader.getLicenseDetails(this.buildDate);e&&!e.newInstall&&"activated"!==e.state&&new Date<=this.end&&(this.nextCheckTime=this.getNextCheckTime(),this.nextCheckTime<this.end&&(this.checkAndShowMessage(),this.disposable=a.window.onDidChangeActiveTextEditor(()=>{this.checkAndShowMessage()})))}saleInProgress(){const e=new Date;return e>this.start&&e<this.end}checkAndShowMessage(){const e=r.LicenseReader.getLicenseDetails(this.buildDate);if(!e||"activated"!==e.state&&"activating"!==e.state){const t=new Date,i=()=>!this.disposed&&t>this.start&&t<this.end&&this.nextCheckTime&&t>=this.nextCheckTime;i()&&(this.nextCheckTime=this.getNextCheckTime(),i()&&this.showMessageAndHandleUserResponse(e))}else this.setNextCheckTimeToEndDate(),this.dispose()}discountAmount(){const e=(new Date).getTime(),t=c.find(t=>e>=t.start&&e<t.end);return t?t.discount:0}showMessageAndHandleUserResponse(e){const t=this.nextCheckTime;this.nextCheckTime=this.setNextCheckTime();const i="expiring"===e.state,s=(new Date).getTime(),o=c.find(e=>s>=e.start&&s<e.end);if(!o)return;if(i&&o.discount<=30)return;const n=(i?"Renew":"Get")+` Quokka.js Pro 🚀 today with our limited time ${o.discount}% ${o.saleName?o.saleName+" ":""}discount!`;try{const e=d.readStateFile();t.getTime()>c[0].start||e.lastUrlOpen&&e.lastUrlOpen>c[0].start&&!e.th?(d.updateStateFile({th:(new Date).getTime()}),a.window.showInformationMessage("We saw you recently looked at Quokka 'PRO' and prepared a short 🎁 treasure hunt 🎁 for you!",{title:"Start Adventure",gift:!0},{title:"Don't show again",dontShow:!0}).then(e=>this.handleUserResponse(e))):a.window.showInformationMessage(n,{title:"Buy License",url:a.Uri.parse("https://wallabyjs.com/store/personal/?referrer=qsp#select-quokka")},{title:"Read More",url:a.Uri.parse("https://quokkajs.com/pro/?referrer=qsp")},{title:"Don't show again",dontShow:!0}).then(e=>this.handleUserResponse(e))}catch(e){}}handleUserResponse(e){e&&(e.dontShow?(this.setNextCheckTimeToEndDate(),this.dispose()):e.url?(this.setLastUrlOpenedTime(),a.commands.executeCommand("vscode.open",e.url)):e.gift&&(this.setNextCheckTimeToEndDate(),this.dispose(),this.gift&&this.gift()))}static updateStateFile(e){let t;try{t=Object.assign(Object.assign({},JSON.parse(o.readFileSync(l).toString())),e)}catch(i){t=Object.assign({},e)}try{o.writeFileSync(l,JSON.stringify(t))}catch(e){}}static readStateFile(){try{return JSON.parse(o.readFileSync(l).toString())}catch(e){return{}}}setNextCheckTimeToEndDate(){d.updateStateFile({nextCheck:this.end})}setLastUrlOpenedTime(){if(new Date>=this.start){const e=new Date,t=new Date(e.setDate(e.getDate()+1));d.updateStateFile({lastUrlOpen:(new Date).getTime(),nextCheck:t})}}deleteStateConfig(){try{o.existsSync(l)&&o.unlinkSync(l)}catch(e){}}dispose(){this.disposable&&this.disposable.dispose(),this.disposed=!0}setNextCheckTime(){const e=new Date,t=new Date(e.setDate(e.getDate()+1));return d.updateStateFile({nextCheck:t}),t}getNextCheckTime(){try{if(o.existsSync(l)){const e=o.readFileSync(l).toString(),t=JSON.parse(e);return t.nextCheck?new Date(t.nextCheck):(d.updateStateFile({nextCheck:this.start}),this.start)}return d.updateStateFile({nextCheck:this.start}),this.start}catch(e){return this.deleteStateConfig(),this.setNextCheckTimeToEndDate(),this.end}}}i.SalesEvent=d},{"./licenseReader":8,fs:void 0,os:void 0,path:void 0,vscode:void 0}],5:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.checkForOffers=function(e){o&&e(o);if(n.push(e),n.length>1)return;const t=JSON.stringify({product:"quokka"}),i={hostname:"x55r2pae4l.execute-api.us-east-1.amazonaws.com",port:443,path:"/Prod/checkOffers",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(t)}},r=s.request(i,e=>{let t="";e.on("data",e=>{t+=e}),e.on("end",()=>{200===e.statusCode&&(o=JSON.parse(t),a())})});r.on("error",e=>{console.error(e),o={},a()}),r.write(t),r.end()};const s=e("https");let o;const n=[];function a(){n.forEach(e=>{try{e(o)}catch(e){}}),n.length=0}},{https:void 0}],6:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});i.default=class{constructor(){this._disposables=[]}add(e){"function"==typeof e?this._disposables.push({dispose:e}):this._disposables.push(e)}dispose(){this._disposables.forEach(e=>e.dispose())}}},{}],7:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,n){function a(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,r)}l((s=s.apply(e,t||[])).next())})};const o=e("path"),n=e("fs"),a=e("os"),r=e("vscode"),l=e("crypto"),c=global._,d=e("./SalesEvent"),u=e("./InteractiveExamples"),h=global.EventEmitter,p=e("./valueExplorer"),_=e("./traceExplorer"),g=e("./recentFilesExplorer"),m=e("./compositeDisposable").default,v=e("./outputBuilder"),f=e("./startViewPanel"),{loadTheme:k,loadConfiguration:S,setTheme:w}=e("./preferences"),{IntegratedWebviewViewProvider:y}=e("./webview"),C=r.workspace,b=r.window,x=300,T=3500,D="quokka",E="const chest = require('quokka-treasure-chest')",P="​",L=new RegExp("(\\s|^){\\s*{","gm"),O=new RegExp("(?<!>\\s*)^\\s*{\\s*{\\s*$","gm"),q=new RegExp("}\\s*}","gm"),N=["showOutput","focusOutput","createFile","newJavaScript","newTypeScript","newRecentInteractive","makeQuokkaFromExistingFile","runOnSave","runOnce","toggle","createJavaScriptFile","createTypeScriptFile",,"openStartView","showInstrumentedFile","stopCurrent","stopAll","installMissingPackageToProject","installMissingPackageToQuokka","installQuokkaPlugin","goToLineInQuokkaFile","showLicense","switchToPro","switchToCommunity","selectWorkspaceFolder","addImport","addRequire","showValue","copyValue","showLineValues","showLineTimings","copyExpressionPath","copyExpressionData","profile","clearValue","clearFileValues","enableShowValueOnSelection","disableShowValueOnSelection","enableShowSingleInlineValue","disableShowSingleInlineValue","viewRecentFiles","runRecentFile","removeRecentFiles","disableAutoLog","enableAutoLog","revealInValueExplorer","stopShowingOutputCodeLens","editSessionSettings","debug","debugAutoPlay","playTraceNextStep","playTracePrevStep","playTraceNextStepOut","playTracePrevStepOut","playTraceNextStepOver","playTracePrevStepOver","playTraceForwardToSelection","playTraceBackwardToSelection","playTraceForwardToBreakpoint","playTraceBackwardToBreakpoint","viewCallStack","hideCallStack","openCallStackFrame","revealTraceStep","stopTraceNavigation","autoPlayCode","pauseCodeExecution","viewCodeStory","share","allowFileSnapsExecution","insertSnapOutput","deleteSnapOutput","stopFileSnapsDiscovery","startFileSnapsDiscovery","selectAction","showLogs","hoverCopy","exploreEntity","showQuokkaRemotePort"],A=new Set(["javascript","javascriptreact","typescript","typescriptreact","vue","svelte"]),R={javascript:".js",javascriptreact:".js",plaintext:".js",typescript:".ts",typescriptreact:".tsx",vue:".vue",svelte:".svelte"},F={".js":"javascriptreact",".jsx":"javascriptreact",".ts":"typescript",".tsx":"typescriptreact",".vue":"vue",".svelte":"svelte"},I={automatic:0,onsave:1,once:2,snapsOnly:3},V=" Quokka",j=new Set(["`","'",'"',")","}","]"]);let B=0;class M extends h{constructor(e){super();let t=this;this._state=e,this._context=e.context,this._deactivator=e.deactivate,this._Session=e.coreClient.Session,this._utils=e.coreClient.utils,this._buildDate=new Date(e.coreClient.bd),this._outputDocumentSelector={language:"quokka-output"},this._setupVersionSpecificComponents(e.version),this._statusBarItem=b.createStatusBarItem(r.StatusBarAlignment.Right),this._statusBarItem.show(),this._resetStatusBar(),this._disposables=new m,this._syncSettings(),c.each(N,e=>t._disposables.add(r.commands.registerCommand(`quokka.${e}`,(...i)=>{try{return t[e](...i)}catch(e){console.error(e)}}))),r.commands.executeCommand("setContext","quokka.isLiveShareClient",!1),this._initializeCoverageDecorationTypes(),t._disposables.add(r.workspace.onDidChangeConfiguration(e=>{t._reInitializeCoverageDecorationTypes(),t._activeSessions.forEach(e=>{var t;return null===(t=e.output)||void 0===t?void 0:t.refreshHeaderCommands()}),this._setPreferences(),e.affectsConfiguration("quokka.rollBackToPreviousGenerationUI")&&this.stopAll()})),this._debugOutputChannel={appendLine:(e,t)=>{console.log("%c "+e,"color: "+("error"===t?"red":"darkgreen"))}},this._activeSessions=[],this._activeSession=null,this._activeLicenseSession=null,r.commands.executeCommand("setContext","quokka.hasActiveSession",!1),t._disposables.add(C.onDidChangeTextDocument(e=>{if(e&&e.document&&"quokka-output"===e.document.languageId){const t=b.visibleTextEditors.find(t=>t.document===e.document);t&&(t.selection=new r.Selection(0,0,0,0))}})),t._disposables.add(C.onDidOpenTextDocument(e=>{if(e&&e.uri&&"output"===e.uri.scheme){const t=(e,t)=>{if("quokka-output"===e.languageId)return;const i=e.lineAt(0);if(i&&i.text&&i.text.length)return 0===i.text.indexOf(P);t&&t()};t(e,()=>{const i=C.onDidChangeTextDocument(s=>{s.document===e&&(i.dispose(),t(s.document)&&r.languages.setTextDocumentLanguage(e,"quokka-output"))})})&&r.languages.setTextDocumentLanguage(e,"quokka-output")}})),t._disposables.add(b.onDidChangeActiveTextEditor(e=>{let i=!1;if(e){var s=this._activeSessions.find(t=>e.document===t.textDocument);s?(this._checkAndSyncSession(s)||this._updateStatusBarForActiveSession(s,!1),r.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!0),i=!0,delete s.activeLineNumber,delete s.activeLineNumberCapturedInCodeStoryViewer,s.activeLineNumber=e.selection&&e.selection.active.line,s.activeLineNumberCapturedInCodeStoryViewer=s.traceExplorer.isCodeStoryViewer(e),t._setInlineValuesFileContext(s.hasRemovableMessages),t._setShowValueOnSelectionEnabledContext(s.showValueOnSelection),t._setShowSingleInlineValueEnabledContext(s.showSingleInlineValue),t._setAutoLogEnabledContext(s.autoLog)):this._registerBackgroundSession(e)}i||r.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!1)})),this._setupEnvironment(),r.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!1),this._recentFilesExplorer=new g(this._quokkaFolder),this._disposables.add(this._recentFilesExplorer),this.on("started",()=>{this._liveShareClientActive()||r.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!0)}),this._previousInlineValuesLineContext=!1,this._previousInlineValuesFileContext=!1,this._automaticRestartActiveTextEditorHandle=void 0,(this._automaticRestart||this._automaticStartRegex)&&b.visibleTextEditors.forEach(e=>{this._checkForAutomaticStart(e)});const i=()=>{this._automaticRestart=r.workspace.getConfiguration().get("quokka.automaticRestart"),this._automaticStartRegex=r.workspace.getConfiguration().get("quokka.automaticStartRegex"),this._showValueOnMultilineSelection=r.workspace.getConfiguration().get("quokka.showValueOnMultilineSelection",!1);try{this._automaticStartRegex&&(this._automaticStartRegex=new RegExp(this._automaticStartRegex))}catch(e){this._automaticStartRegex=""}!this._automaticRestart&&!this._automaticStartRegex||this._automaticRestartActiveTextEditorHandle?this._automaticRestart||this._automaticStartRegex||!this._automaticRestartActiveTextEditorHandle||(this._automaticRestartActiveTextEditorHandle.dispose(),this._automaticRestartActiveTextEditorHandle=void 0):this._automaticRestartActiveTextEditorHandle=b.onDidChangeActiveTextEditor(e=>{this._checkForAutomaticStart(e)}),this._renderDecorationsForAllLines="All lines"===r.workspace.getConfiguration().get("quokka.textDecorationRenderScope","All lines"),this._activeSessions.forEach(e=>{!this._renderDecorationsForAllLines&&this._pro?e.selectedLines||(e.selectedLines=new Set):e.selectedLines&&delete e.selectedLines})};this._disposables.add(()=>{var e;this._automaticRestartActiveTextEditorHandle&&this._automaticRestartActiveTextEditorHandle.dispose(),null===(e=this._overviewWebviewRegistration)||void 0===e||e.dispose()}),i(),r.workspace.onDidChangeConfiguration&&this._disposables.add(r.workspace.onDidChangeConfiguration(()=>{i()})),this._updatePreviousGenerationUIAvailability(),this._prevGenGuiEnabled&&this._setupLiveSharing(),r.commands.executeCommand("setContext","quokka.debug",r.workspace.getConfiguration()&&r.workspace.getConfiguration().get("quokka.debug",!1)),this._reportTelemetry(),this._backgroundSessions=[],this._filesWithSnapsDiscoveryPaused=new Set,this._filesWithSnapsDiscoveryDisabled=new Set,this._resetStatusBar(),this._registerBackgroundSession(b.activeTextEditor),this._disposables.add(r.window.tabGroups.onDidChangeTabs(e=>{e.closed.length&&!r.window.tabGroups.all.flatMap(e=>e.tabs).length&&this._resetStatusBar()}))}_updatePreviousGenerationUIAvailability(){let e=C.getConfiguration().get("quokka.rollBackToPreviousGenerationUI",!1);this._setContext("quokka.prevGenGuiEnabled",e),this._prevGenGuiEnabled=e}_reportTelemetry(){return s(this,void 0,void 0,function*(){const t=o.join(a.homedir(),".quokka",".qts");if(n.existsSync(o.dirname(t))&&!n.existsSync(t))try{const i=e("querystring"),s=e("http"),l=e("uuid"),c=r.workspace.getConfiguration().get("quokka.showStartViewOnFeatureRelease",!0),d=this._context.globalStorageUri.fsPath,u=o.dirname(d),h=o.join(u,"state.vscdb");let p="dndUnknown";if(n.existsSync(h))try{const t=e("sql.js"),i=n.readFileSync(h);p="dndFalse";const s=new((yield t()).Database)(i).prepare("SELECT value FROM ItemTable WHERE key = 'notifications.doNotDisturbMode';");if(s.step()){p="true"===s.getAsObject().value?"dndTrue":"dndFalse"}}catch(e){}const _=`vscode.${this._pro?"pro":"community"}.${p}.${c?"featureNotify":"featureDoNotNotify"}`,g=o.join(a.homedir(),".quokka",".qid");let m;try{m=n.readFileSync(g).toString()}catch(e){m=l.v4();try{n.writeFileSync(g,m)}catch(e){}}const v="UA-58409118-8",f=i.stringify({v:1,tid:v,cid:m,t:"event",ec:_,ea:_,el:_}),k={hostname:"www.google-analytics.com",path:"/collect",method:"POST",headers:{"Content-Length":f.length}},S=s.request(k,function(e){e.on("data",()=>{}),e.on("end",()=>{})});S.on("error",()=>{}),S.write(f),S.end()}catch(e){}finally{n.writeFileSync(t,"")}})}_syncSettings(){const e="quokka.syncSettings";if(this._context.globalState.setKeysForSync([e]),r.workspace.getConfiguration().get("quokka.syncSettings",!0))try{const t="~/.quokka/.vscode.settings",i=[t,"~/.quokka/.qid","~/.quokka/.qlc","~/.quokka/config.json","~/.quokka/notifications.json","~/.quokka/startPage.json","~/.quokka/user.data","~/.quokka/user.id","~/.wallaby/.ol"];let s=a.homedir();s.endsWith(o.sep)||(s+=o.sep);const r=e=>{try{if(e=e.replace("~",s),n.existsSync(e))return n.readFileSync(e,"utf8")}catch(e){}},l=(e,t)=>{try{e=e.replace("~",s),n.existsSync(o.dirname(e))||n.mkdirSync(o.dirname(e),{recursive:!0}),n.writeFileSync(e,t,"utf8")}catch(e){}},c=()=>i.map(e=>({fileName:e,content:r(e)})),d=()=>{l(t,(new Date).getTime().toString()),this._context.globalState.update(e,c())},u=e=>{e.forEach(({fileName:e,content:t})=>{void 0!==t&&l(e,t)})},h=this._context.globalState.get(e);if(h){const e=parseInt(r(t)||"0",10),i=parseInt(h.find(e=>e.fileName===t).content,10);e<i?u(h):e>i?d():JSON.stringify(h)!==JSON.stringify(c())&&d()}else d()}catch(e){}}static _hash(e){return l.createHash("md5").update(e).digest("hex").substr(0,16)}_checkForAutomaticStart(e){if(e&&e.document&&"file"===e.document.uri.scheme){const t=o.extname(e.document.uri.fsPath);if(!F[t])return;const i=this._activeSessions.find(t=>t.textDocument===e.document);if(this._automaticStartRegex)try{return void(!i&&this._automaticStartRegex.test(e.document.uri.fsPath)&&this.makeQuokkaFromExistingFile())}catch(e){}this._automaticRestart&&(i&&i.mode===I.automatic?this._context.workspaceState.update("quokka:runningstate:"+M._hash(e.document.uri.fsPath),1):this._context.workspaceState.get("quokka:runningstate:"+M._hash(e.document.uri.fsPath))&&this.makeQuokkaFromExistingFile())}}_createOutputChannel(){return b.createOutputChannel("Quokka")}_showOutput(){return s(this,arguments,void 0,function*(e=!0){this.outputChannel?(this.outputChannel.hide(),this.outputChannel.show(!0)):this._activeSession.ui&&(yield r.commands.executeCommand("quokka.output.focus",{preserveFocus:e}))})}_initializeCoverageDecorationTypes(){const e=new r.ThemeColor("editorCodeLens.foreground"),t=e,i=e;this._coverageDecorationTypes={1:this._createCoverageDecorationType("notCovered","log"),2:this._createCoverageDecorationType("covered","log"),3:this._createCoverageDecorationType("partiallyCovered","log"),4:this._createCoverageDecorationType("errorSource","error"),5:this._createCoverageDecorationType("errorPath","log"),6:this._createCoverageDecorationType("notCovered","system"),7:this._createCoverageDecorationType("covered","system"),8:this._createCoverageDecorationType("partiallyCovered","system"),9:this._createCoverageDecorationType("errorSource","error"),10:this._createCoverageDecorationType("errorPath","system"),systemLog:b.createTextEditorDecorationType({isWholeLine:!0,rangeBehavior:1,light:{after:this._getThemableDecorationRenderOptions("system","light")},dark:{after:this._getThemableDecorationRenderOptions("system","dark")}}),watchExpression:b.createTextEditorDecorationType({borderStyle:"solid",borderRadius:"2px",borderWidth:"1px",rangeBehavior:1,light:{borderColor:"rgba(214, 179, 59, 1)",after:{color:t}},dark:{borderColor:"rgba(214, 179, 59, 1)",after:{color:i}}})},this._coverageOverrideState=this._currentCoverageOverrideState()}_currentCoverageOverrideState(){const e=r.workspace.getConfiguration();return JSON.stringify([e.get("quokka.lightTheme.log.decorationAttachmentRenderOptions",{}),e.get("quokka.lightTheme.error.decorationAttachmentRenderOptions",{}),e.get("quokka.darkTheme.log.decorationAttachmentRenderOptions",{}),e.get("quokka.darkTheme.error.decorationAttachmentRenderOptions",{})])}_reInitializeCoverageDecorationTypes(){this._coverageOverrideState!==this._currentCoverageOverrideState()&&(this._activeSessions.forEach(e=>{this._clearDecorations(e)}),this._initializeCoverageDecorationTypes(),this._activeSessions.forEach(e=>{this._updateDocuments(e,e.documentUpdates)}))}_liveShareUrlMatches(e,t){if(e.path.startsWith("/~untitled")&&t.path.startsWith("/~untitled")){const t=e.path.split("/"),i=e.path.split("/");return t[t.length-1]===i[i.length-1]}return 0===e.scheme.localeCompare(t.scheme)&&0===e.path.localeCompare(t.path)}_setupLiveSharing(){return s(this,void 0,void 0,function*(){let t,i,o,n;try{t=e("vsls"),i=yield t.getApi(),o="quokkajs"}catch(e){n=e}if(!i)return void this._debugOutputChannel.appendLine("Quokka.js Live Share integration disabled, VSLS not found."+(n?" "+n.message:""));if(this._liveShare={api:i},this._liveShare.server=yield i.shareService(o),this._liveShare.client=yield i.getSharedService(o),!this._liveShare.server||!this._liveShare.client)return this._debugOutputChannel.appendLine('Could not create a shared service. You have to set "liveshare.features" to "experimental" in your user settings in order to use live sharing.'),void delete this._liveShare;this._disposables.add(()=>i&&i.unshareService(o));const a=()=>c.uniq(this._activeSessions.map(e=>({file:e.liveShareFileName,language:e.textDocument.languageId,originalFile:e.textDocument.uri,fileName:e.fileName,documentUpdates:e.documentUpdates,stats:e.stats,mode:e.mode,headerData:e.headerData,liveConsoleOutput:e.allLiveConsoleOutput,status:e.status}))),l=e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.document.uri));if(t){this._start(e.document,e,t.mode);const i=h(t.file);this.processStarted(i),i.output.setHeaderData(t.headerData),i.headerData=t.headerData,t.documentUpdates[t.file.path]=t.documentUpdates[t.fileName],delete t.documentUpdates[t.fileName],this._updateDocuments(i,t.documentUpdates),i.stats=t.stats,i.status=t.status,this.processStats(i),i.liveConsoleOutput=t.liveConsoleOutput,i.liveConsoleOutput&&i.liveConsoleOutput.length&&this._displayLiveConsoleOutput(i,i.liveConsoleOutput),this._liveShare.activeServerSessions=this._liveShare.activeServerSessions.filter(e=>e!==t)}};this._liveShare.api.onDidChangePeers(e=>s(this,void 0,void 0,function*(){this._liveShareServerActive()&&e.added.length&&(this._liveShare.serverAllowed||this._activeSessions.length&&(b.showWarningMessage("You have not given permission to run Quokka.js in your Live Share Session. All Quokka.js instances have been stopped."),this.stopAll(!0)))})),this._context.subscriptions.push(this._liveShare.server.onDidChangeIsServiceAvailable(e=>s(this,void 0,void 0,function*(){e?(this._activeSessions.forEach(e=>{e.liveShareFileName=this._getLiveShareFileName(e.textDocument.uri)}),this._liveShare.disposable=new m,this._liveShare.disposable.add(()=>delete this._liveShare.serverAllowed),this._liveShare.serverAllowed=!1,this._activeSessions.length&&this._showLiveShareWarningMessage()):(this._liveShare.disposable&&this._liveShare.disposable.dispose(),delete this._liveShare.disposable)})));const d=e=>s(this,void 0,void 0,function*(){e?(r.commands.executeCommand("setContext","quokka.isLiveShareClient",!0),r.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!1),this._liveShare.disposable=new m,this._liveShare.disposable.add(()=>delete this._liveShare.activeServerSessions),this._liveShare.disposable.add(b.onDidChangeActiveTextEditor(e=>l(e))),this._liveShare.activeServerSessions=yield this._liveShare.client.request("init",[])):(r.commands.executeCommand("setContext","quokka.isLiveShareClient",!0),this._liveShare.disposable&&this._liveShare.disposable.dispose(),delete this._liveShare.disposable)});this._liveShare.client.isServiceAvailable&&d(!0),this._context.subscriptions.push(this._liveShare.client.onDidChangeIsServiceAvailable(d));const u=e=>b.visibleTextEditors.find(t=>this._liveShareUrlMatches(e,t.document.uri)),h=e=>this._activeSessions.find(t=>{if(e.path.startsWith("/~untitled")&&t.fileName.startsWith("/~untitled")){const i=e.path.split("/"),s=t.fileName.split("/");return i[i.length-1]===s[s.length-1]}return t.fileName===e.path});this._liveShare.server.onRequest("init",()=>a()),this._liveShare.client.onNotify("busy",e=>{const t=h(e.file);t&&this.processSessionBusy(t)}),this._liveShare.client.onNotify("stopped",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file));t&&this._liveShare.activeServerSessions.filter(e=>e!==t);const i=h(e.file);i&&this._stop(i)}),this._liveShare.client.onNotify("started",e=>{const t=u(e.file);if(!t){return void(this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file))||this._liveShare.activeServerSessions.push({file:e.file,originalFile:e.originalFile,fileName:e.fileName,documentUpdates:{},stats:void 0,status:void 0,mode:e.data.mode,headerData:null}))}this._start(t.document,t,e.data.mode);const i=h(e.file);this.processStarted(i)}),this._liveShare.client.onNotify("stats",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file));t&&(t.stats=e.data,delete t.status,delete t.liveConsoleOutput,delete t.allLiveConsoleOutput);const i=h(e.file);i&&(i.stats=e.data,delete i.status,delete i.liveConsoleOutput,delete i.allLiveConsoleOutput,this.processStats(i))}),this._liveShare.client.onNotify("documentUpdates",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(e.file,t.file));t&&(t.documentUpdates=e.data);const i=h(e.file);i&&(e.data[i.fileName]=e.data[e.fileName],delete e.data[e.fileName],this._updateDocuments(i,e.data))}),this._liveShare.client.onNotify("consoleOutput",e=>{const t=h(e.file);t&&this._displayLiveConsoleOutput(t,e.data)}),this._liveShare.client.onNotify("configChanged",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(e.file,t.file));t&&(t.headerData=e.data);const i=h(e.file);i&&(i.output.setHeaderData(e.data),i.headerData=e.data)})})}_changePro(e){this._pro=e,r.commands.executeCommand("setContext","quokka.isPro",!!e)}_checkCountry(){const t=parseInt(this._context.globalState.get("quokka.lastCountryCheck","0"),10),i=Date.now();if(i-t>5184e6){e("./checkOffers").checkForOffers(e=>{e&&e.country&&(this._context.globalState.update("quokka.country",e.country),this._context.globalState.update("quokka.lastCountryCheck",i.toString()))})}}_setupEnvironment(){this._quokkaFolder=o.join(a.homedir(),".quokka"),this._wallabyFolder=o.join(a.homedir(),".wallaby"),this._lkp=o.join(this._quokkaFolder,".qlc"),this._ol=o.join(this._wallabyFolder,".ol");try{n.existsSync(this._quokkaFolder)||n.mkdirSync(this._quokkaFolder)}catch(e){}try{n.existsSync(this._wallabyFolder)||n.mkdirSync(this._wallabyFolder)}catch(e){}const e=this._loadQuokkaConfig();this._changePro(!0===e.pro),this._checkCountry(),this._salesEvent=new d.SalesEvent(this._buildDate,()=>this._treasureHunt()),this._interactiveExamples=new u.InteractiveExamples,this._interactiveExamples.initialize(),f.setController(this),!0!==e.pro&&!1!==e.pro?f.createOrShow(this._context,{type:"firstInstall"}):f.showWhatsNewIfRequired(this._context)}_quokkaConfigPath(){return o.join(this._quokkaFolder,"config.json")}_loadQuokkaConfig(){const e=this._quokkaConfigPath();let t,i={};try{t=n.readFileSync(e).toString(),i=JSON.parse(t)}catch(e){t&&b.showWarningMessage("Looks like your quokka config.json file has invalid syntax, it should be a valid JSON file.")}return i}_saveQuokkaConfig(e){n.writeFileSync(this._quokkaConfigPath(),JSON.stringify(e))}_getThemableDecorationRenderOptions(e,t){const i=e,s=r.workspace.getConfiguration().get(`quokka.${t}Theme.${i}.decorationAttachmentRenderOptions`,{color:"light"===t?"error"===i?"#c80000":"log"===i?"#0000ff":new r.ThemeColor("editorCodeLens.foreground"):"error"===i?"#fe536a":"log"===i?"rgba(86, 156, 214, 1)":new r.ThemeColor("editorCodeLens.foreground"),margin:"1.2em"}),o={};return Object.keys(s).forEach(e=>{null!==s[e]&&(o[e]=s[e])}),delete o.contentText,delete o.contentIconPath,o}_createCoverageDecorationType(e,t){return b.createTextEditorDecorationType({isWholeLine:!0,rangeBehavior:1,gutterIconPath:this._context.asAbsolutePath(o.join("images",e+".svg")).split("\\").join("/"),light:{after:this._getThemableDecorationRenderOptions(t,"light")},dark:{after:this._getThemableDecorationRenderOptions(t,"dark")}})}addImport(e){b.activeTextEditor&&M._addCode(b.activeTextEditor,new r.Position(0,0),`import ${e} from '${e}';\n`)}addRequire(e){b.activeTextEditor&&M._addCode(b.activeTextEditor,new r.Position(0,0),`const ${e} = require('${e}');\n`)}static _addCode(e,t,i){const s=new r.WorkspaceEdit;s.insert(e.document.uri,t,i),r.workspace.applyEdit(s)}newJavaScript(){this.createJavaScriptFile()}newTypeScript(){this.createTypeScriptFile()}newRecentInteractive(e){this._runIfAllowed(()=>{const t=[...e?["JavaScript","TypeScript"]:[],{label:"Recent Files",recent:!0},...this._interactiveExamples.getExamples()];b.showQuickPick(t).then(e=>{if(!e)return;if(e.recent)return this.viewRecentFiles();let t="",i=e;e.label?(i=this._interactiveExamples.getLanguage(e),t=this._interactiveExamples.getContent(e),this._createLanguageFile(i,t,o.join("interactive-examples",this._interactiveExamples.getRelativeFilePath(e)))):this._createLanguageFile(i,t)})})}createFile(){this.newRecentInteractive(!0)}profile(){this._activeSession&&b.showQuickPick([{label:"Open profile in Chrome Dev Tools",target:"devtools"},{label:"Open profile in VS Code",target:"editor"}]).then(e=>{e&&e.target&&this._activeSession.runTests({profileRun:e.target,file:this._activeSession.fileName})})}editSessionSettings(){if(!this._activeSession)return;const e=this._activeSession,t=e.showValueOnSelection,i=e.showSingleInlineValue,s=[];e.autoLog?s.push({label:"$(symbol-boolean) Toggle Auto Log (Disable)",command:"quokka.disableAutoLog"}):(s.push({label:"$(symbol-boolean) Toggle Auto Log (Enable)",command:"quokka.enableAutoLog"}),t?s.push({label:"$(symbol-boolean) Toggle Show Expression Value on Selection (Disable)",command:"quokka.disableShowValueOnSelection"}):s.push({label:"$(symbol-boolean) Toggle Show Expression Value on Selection (Enable)",command:"quokka.enableShowValueOnSelection"}),i?s.push({label:"$(symbol-boolean) Show All Selected Values",command:"quokka.disableShowSingleInlineValue"}):s.push({label:"$(symbol-boolean) Show Last Selected Value Only",command:"quokka.enableShowSingleInlineValue"})),b.showQuickPick(s).then(t=>{t&&t.command&&(r.commands.executeCommand(t.command),b.showTextDocument(e.textDocument,{preserveFocus:!1}))})}debug({fromTheStart:e=!1}={fromTheStart:!1}){this._activeSession&&(e&&this.stopTraceNavigation(),this._activeSession.runTests({initialTraceRun:!0,file:this._activeSession.fileName,line:e?void 0:this._activeSession.activeLineNumber+1}))}debugAutoPlay(){this._activeSession&&(this._activeSession.runTests({initialTraceRun:!0,file:this._activeSession.fileName,line:this._activeSession.activeLineNumber+1}),this._activeSession.traceExplorer.autoPlayCodeOnStart())}playTraceNextStep(e={}){this._requestTrace(e)}playTraceNextStepOver(){this._requestTrace({over:!0})}playTraceNextStepOut(){this._requestTrace({out:!0})}playTracePrevStep(){this._requestTrace({back:!0})}playTracePrevStepOver(){this._requestTrace({back:!0,over:!0})}playTracePrevStepOut(){this._requestTrace({back:!0,out:!0})}playTraceForwardToSelection(){this._playTraceToSelection()}playTraceBackwardToSelection(){this._playTraceToSelection({back:!0})}playTraceForwardToBreakpoint(){this._requestTrace({breakpoints:this._getBreakpoints()})}playTraceBackwardToBreakpoint(){this._requestTrace({back:!0,breakpoints:this._getBreakpoints()})}_playTraceToSelection(e={}){const t=this._activeSession;if(!t)return;const i=b.activeTextEditor;if(i){if(e.line=t.activeLineNumber+1,e.file=t.fileName,t.traceExplorer.isCodeStoryViewer(i)||t.activeLineNumberCapturedInCodeStoryViewer){const i=t.traceExplorer.getOriginalLocationByCodeStoryLine(e.line);if(!i)return;e.line=i.line,e.file=i.file,e.frame=i.step}this._requestTrace(e)}}_getBreakpoints(e){return e||(e=this._activeSession),r.debug.breakpoints&&e&&e.textDocument?r.debug.breakpoints.filter(t=>t.enabled&&t.location&&t.location.range&&t.location.uri&&t.location.uri.toString()===e.textDocument.uri.toString()).map(t=>({line:t.location.range.start.line+1,file:e.fileName})):[]}_requestTrace(e={}){this._activeSession&&this._activeSession.traceExplorer.requestTrace(e).then(t=>this._processTraceNavigation(this._activeSession,t,!1,e.preserveTimelineSelection))}showOutput(){this._activeSession&&this._showOutput()}focusOutput(){return s(this,void 0,void 0,function*(){this._activeSession&&(this._overviewWebviewViewHandle.webviewView?yield this._showOutput(!1):(yield this._showOutput(),yield new Promise(e=>setTimeout(e,300)),yield this._showOutput(!1)))})}createJavaScriptFile(){this._runIfAllowed(()=>this._createLanguageFile("JavaScript"))}createTypeScriptFile(){this._runIfAllowed(()=>this._createLanguageFile("TypeScript"))}makeQuokkaFromExistingFile(){this._runIfAllowed(()=>this._runFromExistingFile(I.automatic))}toggle(){const e=b.activeTextEditor;if(!e)return;const t=e.document;t&&(this._activeSessions.find(e=>e.textDocument===t)?this.stopCurrent():this.makeQuokkaFromExistingFile())}share(){return s(this,void 0,void 0,function*(){const e=this._activeSession;if(!e)return;const t=this._context.secrets;let i=yield t.get("quokka.codeClipEditorId");i||(i=l.randomBytes(32).toString("hex"),yield t.store("quokka.codeClipEditorId",i));const s=r.workspace.getConfiguration(),o=()=>{r.window.withProgress({location:r.ProgressLocation.Notification,title:"Sharing Quokka",cancellable:!1},t=>{const s=B++;let o;return e.tasks||(e.tasks={}),e.tasks[s]=((i,n)=>{switch(i){case"completion":delete e.tasks[s],o();break;case"failure":delete e.tasks[s],o(),setTimeout(()=>b.showErrorMessage(n),1e3);break;case"progress":t.report({message:n})}}),t.report({message:"Preparing"}),e.shareCodeClip(i,s),new Promise(e=>o=e)})};if(s.get("quokka.codeClipAutoUpload",!1))o();else{const t=yield b.showWarningMessage("Are you sure that you want to share the code and its output on codeclip.io?",{title:"Yes",allow:!0},{title:"No",allow:!1},{title:"Always Yes",allow:!0,always:!0});t&&t.allow&&(t.always&&s.update("quokka.codeClipAutoUpload",!0,!0),this._activeSession===e&&o())}})}runOnSave(){this._pro?this._runIfAllowed(()=>this._runFromExistingFile(I.onsave)):this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession)}runOnce(){this._pro?this._runIfAllowed(()=>{const e=b.activeTextEditor;if(!e)return;const t=e.document;if(!t)return;const i=this._activeSessions.find(e=>e.textDocument===t);i&&i.mode===I.once?i.changes.length?this._processDocumentContentChange(i,t,[],!0):i.runTests({file:i.fileName}):this._runFromExistingFile(I.once)}):this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession)}stopCurrent(){const e=b.activeTextEditor,t=e&&e.document&&this._activeSessions.find(t=>t.textDocument===e.document)||this._activeSession;t&&this._stop(t,{setAutomaticStateOff:!0})}stopAll(e){this._activeSessions.slice().forEach(t=>this._stop(t,{setAutomaticStateOff:!e}))}showInstrumentedFile(){this._activeSession&&this._activeSession.requestInstrumentedFile({path:this._activeSession.fileName},e=>{var t,i;this._prevGenGuiEnabled?(null===(t=this._activeSession.output)||void 0===t||t.clearAndRenderHeader(),null===(i=this._activeSession.output)||void 0===i||i.appendConsoleMessage({text:e,type:"warn"})):C.openTextDocument({language:"javascript",content:e}).then(e=>b.showTextDocument(e))})}installMissingPackageToProject(){this._installPackage(!0)}installMissingPackageToQuokka(){this._installPackage()}installQuokkaPlugin(e,t){this._installPackage(!1,e,t)}showValue(){this._showValue("show",!0)}copyValue(){this._showValue("copy")}showLineValues(){this._showLineValues("show")}showLineTimings(){this._showLineValues("time")}clearValue(){this._clearValues("one")}clearFileValues(){this._clearValues("file")}enableShowValueOnSelection(){this._toggleShowValueOnSelection()}disableShowValueOnSelection(){this._toggleShowValueOnSelection()}enableShowSingleInlineValue(){this._toggleShowSingleInlineValue()}disableShowSingleInlineValue(){this._toggleShowSingleInlineValue()}viewRecentFiles(){return this._recentFilesExplorer.show(this._projectRoot())}runRecentFile(e){const t=o.extname(e.path),i=F[t];i&&(e.runInParentProject?(this._context.globalState.update("quokka:runRecentFile",Object.assign(Object.assign({},e),{runInParentProject:!1})),r.commands.executeCommand("vscode.openFolder",r.Uri.file(e.projectRoot),!0)):e.scratchFile?this._createLanguageFile(i,e.content,e.clone?null:e.id):C.openTextDocument(e.resolvedPath).then(e=>b.showTextDocument(e).then(t=>this._start(e,t,I.automatic))))}removeRecentFiles(e){return s(this,arguments,void 0,function*({files:e,reloadRecentFilesView:t}){if(yield this._recentFilesExplorer.removeRecentFiles(e),t)return this._recentFilesExplorer.show(this._projectRoot())})}_toggleAutoLog(){if(this._liveShareClientActive())return;const e=this._activeSession;e&&e.toggleAutoLog()}disableAutoLog(){this._toggleAutoLog()}enableAutoLog(){this._toggleAutoLog()}revealInValueExplorer(e){if(this._liveShareClientActive())return;const t=this._activeSession;if(!t)return;let i=1;e?e.loc&&(i=parseInt((e.loc+"").split(":")[0],10)):i=t.activeLineNumber+1,this._valueExplorer.reveal(t.id,i)}stopShowingOutputCodeLens(){return s(this,void 0,void 0,function*(){yield r.workspace.getConfiguration().update("quokka.showCodeLensInOutputChannel",!1,!0),this._activeSessions.forEach(e=>{var t;return null===(t=e.output)||void 0===t?void 0:t.refreshHeaderCommands()})})}_getLogpoints(e){return this._filterBreakpoints(e,r.debug.breakpoints).map(e=>({id:e.id,range:[e.location.range.start.line+1,e.location.range.start.character,e.location.range.end.line+1,e.location.range.end.character],inline:0!==e.location.range.start.character}))}_filterBreakpoints(e,t){const i=e.textDocument.lineCount;return e&&e.textDocument&&t?t.filter(t=>this._breakpointQualifies(e,i,t)):[]}_breakpointQualifies(e,t,i){return i.enabled&&i.location&&i.location.range&&i.location.uri&&i.location.uri.toString()===e.textDocument.uri.toString()&&i.location.range.start.line<t}_pushBreakpointInfo(e,t,i){const s=t.textDocument.lineCount;[...i.added,...i.removed].some(e=>this._breakpointQualifies(t,s,e))&&t.setLogpoints([{path:t.fileName,logpoints:this._getLogpoints(t)}])}_showValue(e,t,i){const s=b.activeTextEditor;if(this._liveShareClientActive())return;const o=this._activeSession;if(!o||!o.textDocument)return;const n=(null===i||void 0===i?void 0:i.selection)||(null===s||void 0===s?void 0:s.selection);if(!n||!n.end)return;let a=n.start.line+1,l=n.end.line+1,c=(null===i||void 0===i?void 0:i.document)||(null===s||void 0===s?void 0:s.document);if(!c)return;if(o.traceExplorer.isCodeStoryViewer(s)){this._playTraceToSelection({preserveTimelineSelection:!0,playToExactFrame:!0});const e=o.traceExplorer.getOriginalLocationByCodeStoryLine(a);if(!e)return;const t=l-a;l=(a=e.line)+t}else if(c!==o.textDocument)return;const d=o.textDocument.getText();return o.evaluateExpressionInEditor(o.fileName,d,[a,n.start.character,l,n.end.character],e),t&&this._scheduleOnResultsAvailable(o.fileName,n.end,()=>r.commands.executeCommand("editor.action.showHover")),!0}_showLineValues(e){const t=b.activeTextEditor;if(!t)return;if(this._liveShareClientActive())return;const i=this._activeSession;if(!i||!i.textDocument)return;const s=t.selection;if(!s)return;const o=[];for(let e=s.start.line;e<=s.end.line;e++){let s=e+1;if(i.traceExplorer.isCodeStoryViewer(t)){this._playTraceToSelection({preserveTimelineSelection:!0,playToExactFrame:!0});const e=i.traceExplorer.getOriginalLocationByCodeStoryLine(s);if(!e)return;s=e.line}else if(t.document!==i.textDocument)return;o.push([s,0,s,i.textDocument.lineAt(e).text.length])}const n=i.textDocument.getText();i.evaluateExpressionInEditor(i.fileName,n,{ranges:o},e)}_clearValues(e){const t=this._activeSession;if(!t)return;const i={};if(t.messages&&("file"===e||"one"===e)){const s=b.activeTextEditor;if(!s)return;if(i.path=t.fileName,"one"===e){const e=s.selection;if(!e||!e.active)return;const o=s.selection.active.line;if(i.line=o+1,!t.messages[o]||!t.messages[o].removable)return}if("file"===e&&!t.hasRemovableMessages)return;t.removeLogs(i)}}_toggleShowSingleInlineValue(){if(this._liveShareClientActive())return;const e=this._activeSession;e&&e.toggleShowSingleInlineValue()}_toggleShowValueOnSelection(){if(this._liveShareClientActive())return;const e=this._activeSession;e&&e.toggleShowValueOnSelection()}_scheduleOnResultsAvailable(e,t,i,s){this._runOnResultsAvailable={fileName:e,selectionEnd:t,action:i,opts:s}}_runScheduledActionOnResultsAvailable(){var e;if(!this._runOnResultsAvailable)return;let t,i;if(null===(e=this._runOnResultsAvailable.opts)||void 0===e?void 0:e.doNotCheckActiveEditor)t=this._runOnResultsAvailable.fileName,i=this._runOnResultsAvailable.selectionEnd;else{const e=b.activeTextEditor;if(!e)return;const s=this._activeSession;if(!s||!s.textDocument||e.document!==s.textDocument)return;const o=e.selection;if(!o||!o.end)return;t=s.fileName,i=o.end}if(t&&t===this._runOnResultsAvailable.fileName&&i===this._runOnResultsAvailable.selectionEnd)try{this._runOnResultsAvailable.action()}finally{delete this._runOnResultsAvailable}}copyExpressionPath(e){e&&e.copyExpressionPath()}copyExpressionData(e){e&&e.copyExpressionData()}goToLineInQuokkaFile(e,{reveal:t=!0,select:i=!0,focus:s=!0}={reveal:!0,select:!0,focus:!0}){if(!this._activeSession)return;if(!e)return b.showTextDocument(this._activeSession.textDocument,{preserveFocus:!s});let o,n;return c.isArray(e)?(o=e[0]-1,n=e[1]):(e=e.split(","),o=e[0]&&parseInt(e[0],10)-1||0,n=e[1]&&parseInt(e[1],10)||0),b.showTextDocument(this._activeSession.textDocument,{preserveFocus:!s}).then(e=>{if(o>=e.document.lineCount)return;const s=e.document.lineAt(o);n<s.firstNonWhitespaceCharacterIndex&&(n=s.firstNonWhitespaceCharacterIndex);const a=s.range.end.character;if(n>a&&(n=a),!t)return e;const l=new r.Position(o,n);return e.revealRange(new r.Range(l,l)),i?(e.selection=new r.Selection(l,l),e):e})}openStartView(){f.createOrShow(this._context)}_installPackage(e,t,i){if(this._activeSession)if(t)this._activeSession.status="progress",this._updateStatusBarForActiveSession(this._activeSession),this._activeSession.runTests({file:this._activeSession.fileName,installPackage:{name:t,plugin:{editConfig:!0,name:i||t}}});else{if(e&&!this._projectRoot())return void b.showWarningMessage("Cannot install a package into project because quokka is running outside of an opened project.");if(!this._pro)return void this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession);if(!this._activeSession.stats||!this._activeSession.stats.errors)return void b.showWarningMessage("No missing packages to install.");const t=c.find(this._activeSession.stats.errors,e=>e.missingPackage);if(!t||!t.missingPackage)return void b.showWarningMessage("No missing packages to install.");this._activeSession.status="progress",this._updateStatusBarForActiveSession(this._activeSession),this._activeSession.runTests({file:this._activeSession.fileName,installPackage:{name:t.missingPackage,local:e}})}else b.showWarningMessage("Cannot install a package because quokka is not running.")}_setupVersionSpecificComponents(e){const t=e.major,i=e.minor;t>=1&&i>=11&&(this._outputDocumentSelector.scheme="*"),t>=1&&i>=16&&(this._multiFolderWorkspaces=!0)}_createLanguageFile(e,t,i){var s;return(null===(s=b.tabGroups)||void 0===s?void 0:s.onDidChangeTabs)||(t=t||" "),e&&C.openTextDocument({language:e.toLowerCase(),content:t}).then(e=>b.showTextDocument(e).then(t=>this._start(e,t,I.automatic,i)))}_stop(e,t){var i,s,o;if(t=t||{setAutomaticStateOff:!1,restarting:!1},e.mode!==I.snapsOnly&&t.setAutomaticStateOff&&"file"===e.textDocument.uri.scheme){this._context.workspaceState.get("quokka:runningstate:"+M._hash(e.textDocument.uri.fsPath))&&this._context.workspaceState.update("quokka:runningstate:"+M._hash(e.textDocument.uri.fsPath),0)}const n=e.editors&&e.editors[0];if(e.disposable&&e.disposable.dispose(),this._activeSessions=this._activeSessions.filter(t=>t.textDocument&&e.textDocument?t.textDocument!==e.textDocument:t!==e),n&&!t.restarting){if("snaps"===t.initiator){const t={recovered:!0,sticky:null===(i=null===e||void 0===e?void 0:e.metadata)||void 0===i?void 0:i.sticky,counters:{stops:(null===(o=null===(s=null===e||void 0===e?void 0:e.metadata)||void 0===s?void 0:s.counters)||void 0===o?void 0:o.stops)||0}};this._registerBackgroundSession(n,t)}else{const e={hibernated:!0};this._registerBackgroundSession(n,e)}this._liveShareClientActive()&&this._resetStatusBar()}else this._resetStatusBar();c.isEmpty(this._activeSessions)&&(this.emit("allSessionStopped"),r.commands.executeCommand("setContext","quokka.hasActiveSession",!1)),this._recentFilesExplorer.reset()}_relativeNormalizedFilePath(e){return this._utils.normalizePath(o.relative(this._projectRoot(),e))}_runFromExistingFile(e){const t=b.activeTextEditor;if(!t)return;const i=t.document;i&&(R[i.languageId]?this._start(i,t,e,this._getFileId(i)):"output"===i.uri.scheme&&"quokka-output"===i.languageId?this._activeSession&&!this._activeSession.isDisposed()&&this._activeSession.editors.length&&this._start(this._activeSession.textDocument,this._activeSession.editors[0],this._activeSession.mode,this._getFileId(this._activeSession.textDocument)):b.showWarningMessage(`Language "${i.languageId}" is not supported`))}_getFileId(e){if(e)try{const t=d.SalesEvent.readStateFile();if((new Date).getTime()-t.th<11232e5)return~e.getText().indexOf(E)?"treasure-hunt":void 0}catch(e){}}_runIfAllowed(e){!this._liveShareServerActive()||this._liveShare.serverAllowed?e():this._showLiveShareWarningMessage(e)}_showLiveShareWarningMessage(e){b.showWarningMessage("When sharing outside read-only mode, the Quokka.js extension will execute CODE WRITTEN BY OTHERS ON YOUR COMPUTER. Select 'Allow' to continue executing Quokka.js during your Live Share Session.",{title:"Allow",allow:!0},{title:"Deny",allow:!1}).then(t=>{this._liveShare.serverAllowed=!(!t||!t.allow),this._liveShare.serverAllowed?e&&e():this._activeSessions.length&&(b.showInformationMessage("All Quokka.js instances have been stopped."),this.stopAll(!0))})}_liveShareClientActive(){return!!(this._liveShare&&this._liveShare.client&&this._liveShare.client.isServiceAvailable)}_liveShareServerActive(){return!!(this._liveShare&&this._liveShare.server&&this._liveShare.server.isServiceAvailable)}_getLiveShareFileName(e){return"file"===e.scheme?this._liveShare.api.convertLocalUriToShared(e):"untitled"===e.scheme?r.Uri.parse(`vsls:${"/~untitled/"+r.workspace.asRelativePath(e,!1)}`):void 0}_sendToLiveShareClients(e,t,i){this._liveShareServerActive()&&this._liveShare.server.notify(e,{file:t.liveShareFileName,originalFile:t.textDocument.uri,fileName:t.fileName,data:i})}_start(e,t,i,a,l){var d,u,h,g;this._updateConfigurationFromSettings(),M._checkConfigurationSettings();const f=this._liveShareClientActive();if(!0!==l&&!f&&!C.isTrusted){switch(r.workspace.getConfiguration().get("quokka.untrustedWorkspaceBehavior","Prompt to allow")){case"Prompt to allow":return void b.showWarningMessage("You are running in an untrusted workspace. Are you sure you want to start Quokka.js and execute files in this workspace?","Yes","No","Open Settings").then(s=>{"Open Settings"===s?r.commands.executeCommand("workbench.action.openSettings","quokka.untrustedWorkspaceBehavior"):"Yes"===s&&this._start(e,t,i,a,!0)});case"Never allow":return void b.showErrorMessage("Cannot start Quokka.js as it is currently configured to not allow starting in untrusted workspaces.","Open Settings").then(e=>{"Open Settings"===e&&r.commands.executeCommand("workbench.action.openSettings","quokka.untrustedWorkspaceBehavior")})}}const k=f?{}:new this._Session;if(!f){const t=this._backgroundSessions.find(t=>t.document===e);this._backgroundSessions=this._backgroundSessions.filter(e=>e!==t),t&&i===I.snapsOnly&&(k.metadata=t.metadata),null===t||void 0===t||t.disposable.dispose()}if(f)k.isDisposed=(()=>!1),k.stop=(()=>{});else{const t=this._activeSessions.find(t=>t.textDocument===e);t&&this._stop(t,{restarting:!0})}const S=new m;if(this._activeSession&&(null===(d=this._activeSession.output)||void 0===d||d.disableChannel()),S.add(()=>{this._sendToLiveShareClients("stopped",k)}),S.add(()=>{var e;null===(e=this._valueExplorer)||void 0===e||e.remove(k)}),S.add(()=>{delete this._runOnResultsAvailable}),this._watcher||f||(this._watcher=C.createFileSystemWatcher("**/*.*"),this._disposables.add(this._watcher)),!f){S.add(r.languages.registerHoverProvider(e.languageId,{provideHover:(t,i)=>{if(t===e&&k.snaps&&(!k.changeTs||k.changeTs<k.updateTs)){const e=k.snaps.lines[i.line];if(e){const t=[];k.metadata&&!k.metadata.permissive?t.push(this._makeHoverIcon("quokka.allowFileSnapsExecution","Allow snap(s) execution until file is closed","run-all")):e.output?t.push(this._makeHoverIcon("quokka.deleteSnapOutput","Delete snap output","clear-all",i.line)):t.push(this._makeHoverIcon("quokka.insertSnapOutput","Insert snap output","insert",i.line));const s=`<table><tr><td>Quokka Snaps Detected${t.length?"&nbsp;&nbsp;&nbsp;":""}</td><td align='right'>${t.join("&nbsp;&nbsp;")}</td></tr></table>`,o=new r.MarkdownString(s);return o.supportHtml=!0,o.isTrusted=!0,new r.Hover(o)}}}})),S.add(r.languages.registerHoverProvider(e.languageId,{provideHover:(t,i)=>{if(t===e&&!c.isEmpty(k.errors)&&(!k.changeTs||k.changeTs<k.updateTs)){const e=(k.errors[i.line]||{}).hover;if(!e)return;return new r.Hover(e.value)}}}));const t=(e,t,i)=>{const s=this._makeHeaderText("Details",!!t),o=t?`<span style="color:var(--vscode-editorError-foreground);">${i}</span>`:"```\n"+i+"\n```",n=this._getHoverEntryHeaderHtml(s,e,t,k.traceExplorer.traceBeingNavigated())+this._wrapMarkdownInHtmlTable(o)+"\n\n``````\n",a=new r.MarkdownString(n);return a.supportHtml=!0,a.isTrusted=!0,[a]},i={provideHover:(i,s)=>{if(i===e&&!c.isEmpty(k.hoverValues)&&(!k.changeTs||k.changeTs<k.updateTs)){const e=k.hoverValues[s.line]||{};if(!e)return;const i=s.line+1,o=[].concat(e.error?t(i,!0,e.error):[],e.log?t(i,void 0,e.log):[]);return e.error&&e.peek&&delete e.log,new r.Hover(o)}}},o=this;S.add(r.languages.registerHoverProvider(e.languageId,{provideHover(t,n,a){return s(this,void 0,void 0,function*(){var r,l;const c=k.valuePeek&&(null===(r=o._pro)||void 0===r?void 0:r.liveValueDisplay),d=!k.traceExplorer.traceBeingNavigated()&&c;if(t===e&&(!k.changeTs||k.changeTs<k.updateTs)&&!o._prevGenGuiEnabled&&(k.traceExplorer.traceBeingNavigated()||d)&&!k.traceExplorer.isCodeStoryViewer(b.activeTextEditor)){const e=null===(l=b.activeTextEditor)||void 0===l?void 0:l.selection,r=e&&e.contains(n)&&(d?o._isSelectionValidForValuePeek(e):o._isSelectionValidForShowValueInDebugger(k,e));let c=!1;if(!r)try{const e=t.lineAt(n.line);!e.isEmptyOrWhitespace&&e.text.trimEnd().length-1>n.character&&e.firstNonWhitespaceCharacterIndex<=n.character&&(c=!0)}catch(e){}if(r||c)return new Promise(l=>{const c=setTimeout(()=>s(this,void 0,void 0,function*(){let s;const c=new Promise((e,t)=>{s=e});o._showValue(d?"peek":"show",void 0,r?void 0:{selection:{start:n,end:n},document:t})?(o._scheduleOnResultsAvailable(k.fileName,null===e||void 0===e?void 0:e.end,()=>{s()},r?void 0:{doNotCheckActiveEditor:!0}),yield Promise.race([c,new Promise(e=>setTimeout(()=>e(),5e3))]),a.isCancellationRequested?l():l(i.provideHover(t,n))):l()}),r||d?0:1e3);a.onCancellationRequested(()=>{clearTimeout(c),l()})})}return i.provideHover(t,n)})}}));const n=new r.CodeAction("Allow snap(s) execution until file is closed",r.CodeActionKind.Empty);n.command={command:"quokka.allowFileSnapsExecution",title:""};const a=new r.CodeAction("Insert snap output",r.CodeActionKind.Empty);a.command={command:"quokka.insertSnapOutput",title:""};const l=new r.CodeAction("Delete snap output",r.CodeActionKind.Empty);l.command={command:"quokka.deleteSnapOutput",title:""},S.add(r.languages.registerCodeActionsProvider(e.languageId,{provideCodeActions:(t,i)=>{var s;if(t===e&&(!c.isEmpty(k.errors)||k.snaps)&&(!k.changeTs||k.changeTs<k.updateTs)){let e=[];const t=null===(s=k.snaps)||void 0===s?void 0:s.lines[i.start.line];if(t&&(k.metadata&&!k.metadata.permissive?e.push(n):t.output?t.output.range&&e.push(l):e.push(a)),k.errors){const t=(k.errors[i.start.line]||{}).commands;t&&(e=e.concat(t))}return e}}}))}if(k.mode=i,k.disposable=S,k.textDocument=e,k.changes=[],k.fileName=D+R[e.languageId],k.fileId=a,k.documentUpdates={},(i===I.automatic||i===I.snapsOnly)&&!f){const e=e=>{k.textDocument.uri.path!==e.path&&"progress"!==k.status&&k.runTests({file:k.fileName,externalFileChange:!0,externalFileChangePath:e.fsPath})};S.add(this._watcher.onDidCreate(e)),S.add(this._watcher.onDidChange(e)),S.add(this._watcher.onDidDelete(e))}let x;if("file"===e.uri.scheme){const t=e.uri.path.split("/");x=t[t.length-1]}else if("vsls"===e.uri.scheme){const t=e.uri.path.split("/");x=t[t.length-1]}else x=e.uri.path+R[e.languageId];if(k.id=x,"file"===e.uri.scheme)if(this._projectRoot(e.uri.fsPath)){const t=this._relativeNormalizedFilePath(e.uri.fsPath);t&&(k.fileName=t)}else k.localRoot=o.dirname(e.uri.fsPath),k.fileName=o.basename(e.uri.fsPath);else void 0===k.fileId&&this._recentFilesExplorer.findRecentScratchFileIdByContent(e.getText()).then(e=>{k.fileId=e});if(this._liveShareServerActive()&&(k.liveShareFileName=this._getLiveShareFileName(e.uri)),"vsls"===e.uri.scheme&&f&&(k.fileName=e.uri.path),k.editors=[t],k.liveConsoleOutput=[],k.allLiveConsoleOutput=[],k.activeLineNumber=t.selection&&t.selection.active.line,this._activeSessions.push(k),r.commands.executeCommand("setContext","quokka.hasActiveSession",!0),S.add(r.debug.onDidChangeBreakpoints(e=>{this._updateBreakpointsContext(k),this._pushBreakpointInfo(t,k,e)})),(null===(u=b.tabGroups)||void 0===u?void 0:u.onDidChangeTabs)?S.add(b.tabGroups.onDidChangeTabs(()=>{b.tabGroups.all.flatMap(e=>e.tabs).some(t=>{var i,s;return(null===(s=null===(i=t.input)||void 0===i?void 0:i.uri)||void 0===s?void 0:s.fsPath)===e.uri.fsPath})||this._stop(k)})):S.add(C.onDidCloseTextDocument(t=>{e===t&&this._stop(k)})),S.add(C.onDidChangeTextDocument(t=>{const i=this._applyingInlineOutputEdits;this._applyingInlineOutputEdits=!1,e===t.document&&(i||k.mode===I.automatic||k.mode===I.snapsOnly?(this._processDocumentContentChange(k,t.document,t.contentChanges,!0),i&&k.mode===I.onsave&&!this._liveShareClientActive()&&t.document.save()):k.mode===I.once?this._stop(k):(this._resetStatusBar(),this._clearDecorations(k),this._processDocumentContentChange(k,t.document,t.contentChanges,!1)))})),S.add(C.onDidSaveTextDocument(t=>{e===t&&k.mode===I.onsave&&this._processDocumentContentChange(k,t,[],!0)})),S.add(b.onDidChangeActiveTextEditor(i=>{const s=k.editors.includes(i);k.editors=k.editors.filter(e=>b.visibleTextEditors.includes(e)),b.visibleTextEditors.filter(t=>t.document===e).forEach(e=>{k.editors.includes(e)||(k.editors.push(e),this._updateDocuments(k,k.documentUpdates),this._highlightActiveTraceStepIfRequired(k,t,{reveal:!k.traceExplorer.isCodeStoryViewer(t)}))}),s&&this._updateDocuments(k,k.documentUpdates),k.editors.length?k.traceExplorer.isActiveCodeStoryViewer(i)&&(this._updateCodeStoryIfRequired(k,i),this._highlightActiveTraceStepIfRequired(k,i,{})):k.traceExplorer.closeCodeStory(!0)})),S.add(b.onDidChangeTextEditorSelection(t=>{if(t&&t.selections&&t.selections.length&&(t.textEditor.document===e||k.traceExplorer.isCodeStoryViewer(t.textEditor))){const e=t.selections[0];if(k.activeLineNumber!==e.active.line){k.activeLineNumber=e.active.line,k.activeLineNumberCapturedInCodeStoryViewer=k.traceExplorer.isCodeStoryViewer(t.textEditor);const i=k.activeLineNumber;this._setInlineValuesLineContext(k.messages&&k.messages[i]&&k.messages[i].removable)}if((this._pro&&k.showValueOnSelection&&(k.mode===I.automatic||k.mode===I.snapsOnly)||k.traceExplorer.traceBeingNavigated()&&this._prevGenGuiEnabled)&&(this._showValueOnMultilineSelection&&(e.start.line!==e.end.line||e.start.line===e.end.line&&e.start.character!==e.end.character)||e.start.line===e.end.line&&e.start.character!==e.end.character||e.start.line===e.end.line-1&&0===e.end.character)&&this._showValue("show"),k.selectedLines){const e=new Set;let i=!1;for(let s=0;s<t.selections.length;s++){const o=t.selections[s];e.add(o.active.line),k.selectedLines.has(o.active.line)||(i=!0)}(i=i||k.selectedLines.size!==e.size)&&(k.selectedLines=e,this._updateDocuments(k,k.documentUpdates))}}})),this._updatePreviousGenerationUIAvailability(),this._prevGenGuiEnabled){this.outputChannel||(this.outputChannel=this._createOutputChannel(),this.outputChannel.append(P)),null===(h=this._overviewWebviewRegistration)||void 0===h||h.dispose(),this._overviewWebviewRegistration=void 0,this._overviewWebviewViewHandle=void 0,this._valueExplorer||(this._valueExplorer=new p(this._context));const e=c.bind(this._absoluteFilePath,this);k.output=new v(this.outputChannel,P,k.fileName,e,this._state.coreClient.dmp,k.disposable,this._outputDocumentSelector,!!this._projectRoot(),this._liveShareClientActive(),k.id,this._compactMessageOutput,()=>k.traceExplorer.traceBeingNavigated(),()=>k.traceExplorer.traceBeingAutoPlayed(),()=>k.hasAnyEnabledBreakpointsInActiveEditor,()=>this._pro,()=>r.workspace.getConfiguration().get("quokka.showCodeLensInOutputChannel",!0),()=>k.isCodeStoryEnabled,()=>k.isProfilingEnabled),this._colorizeOutput?k.output.useMarkup():k.output.disableMarkup()}else{null===(g=this.outputChannel)||void 0===g||g.dispose(),this.outputChannel=void 0,this._valueExplorer=void 0;const e={retainContextWhenHidden:!0};this._overviewWebviewRegistration||(this._overviewWebviewViewHandle={activate:()=>{},remove:()=>{}},this._overviewWebviewRegistration=r.window.registerWebviewViewProvider("quokka.output",new y("quokka.output",this._overviewWebviewViewHandle,this._context,()=>this._activeSession.uiStarted?this._activeSession.ui:void 0,r.workspace.getConfiguration().get("quokka.debug",!1),()=>r.workspace.getConfiguration().get("quokka.debug",!1)?o.resolve(n.realpathSync(this._context.extensionUri.fsPath),this._context.globalState.get("corePath"),".."):o.resolve(n.realpathSync(this._context.extensionUri.fsPath),"./dist/wallaby")),{webviewOptions:e}))}this._pro&&!this._renderDecorationsForAllLines&&(k.selectedLines=new Set(t.selections.map(e=>e.active.line))),k.traceExplorer=new _(this._context,this,k),this._updateBreakpointsContext(k),f||(k.start({localRoot:this._projectRoot()||k.localRoot,quokkaFolder:this._quokkaFolder,client:"VSCode",cv:r.version,fileName:k.fileName,fileId:k.fileId,editorTypeScript:process.mainModule?o.join(process.mainModule.filename,"../../extensions/node_modules/typescript"):void 0,snapsOnlyMode:i===I.snapsOnly,snapsAutoRun:i===I.snapsOnly?k.metadata.permissive:void 0,version:this._prevGenGuiEnabled?"1":"2"}),k.on("uiThemeChanged",e=>{w(e.name),this._setPreferences()}),k.on("uiStarted",e=>s(this,void 0,void 0,function*(){var t,i;if(this._prevGenGuiEnabled)return;if(k.ui=e,k.remotePort=e.port,k.ui){try{const e=yield r.env.asExternalUri(r.Uri.parse(`http://localhost:${k.ui.port}`)),[s,o]=e.authority.split(":");k.ui.port=o?parseInt(o,10):void 0,s&&(k.ui.host=s),e.scheme&&(k.ui.scheme=e.scheme),null===(i=null===(t=this._overviewWebviewViewHandle)||void 0===t?void 0:t.activate)||void 0===i||i.call(t,k.ui)}catch(e){console.error(e)}e.valuePeek&&(k.valuePeek=!0)}k.uiStarted=!0,r.commands.executeCommand("setContext","quokka.remote",!!r.env.remoteName),r.workspace.getConfiguration().get("quokka.showOutputOnStart",!0)&&k.mode!==I.snapsOnly&&(yield this._showOutput())})),k.on("editorAction",e=>{var t,i,s,o;(null===(i=null===(t=e.debugger)||void 0===t?void 0:t.runViaEditor)||void 0===i?void 0:i.start)&&(e.debugger.runViaEditor.story?this.viewCodeStory():this.debug()),e.profile&&this.profile(),e.shareCodeClip&&this.share(),e.viewRecentQuokkaFiles&&this.viewRecentFiles(),(null===(s=e.insertCode)||void 0===s?void 0:s.addImport)&&this.addImport(e.insertCode.addImport.name),(null===(o=e.insertCode)||void 0===o?void 0:o.addRequire)&&this.addRequire(e.insertCode.addRequire.name)}),k.on("reveal",e=>{"editor"===e.target&&r.commands.executeCommand("workbench.action.focusActiveEditorGroup"),"quokka.output"===e.target&&r.commands.executeCommand("quokka.output.focus")}),k.on("notification",e=>this._showNotification(e,k)),k.on("backgroundTaskProgress",e=>{k.tasks&&k.tasks[e.id]&&k.tasks[e.id](e.stage,e.message)}),k.on("busy",()=>{this._sendToLiveShareClients("busy",k),this.processSessionBusy(k)}),k.on("copyToClipboard",e=>{r.env.clipboard.writeText(e.data)}),k.on("stopped",e=>{this._sendToLiveShareClients("stopped",k),this._stop(k),e.deactivate&&(this.stopAll(!0),this._forceDeactivate()),r.commands.executeCommand("setContext","quokka.remote",!1)}),k.on("started",()=>{this._sendToLiveShareClients("started",k,{mode:k.mode}),this.processStarted(k)}),k.on("stats",e=>{var t;if(this._sendToLiveShareClients("stats",k,e),k.stats=e,delete k.status,delete k.liveConsoleOutput,delete k.allLiveConsoleOutput,k.mode===I.snapsOnly){const e=k.metadata;if(void 0===e.sticky&&(e.sticky=!k.stats.noSnapsFound),k.stats.noSnapsFound){if(e.counters.misses++,!e.sticky&&e.counters.misses>20||e.sticky&&e.counters.misses>100)return e.counters.stops++,void this._stop(k,{initiator:"snaps"})}else e.counters.misses=0,e.counters.stops=0}this.processStats(k),e&&e.messages&&(null===(t=this._valueExplorer)||void 0===t||t.update(k,e.messages),this._runScheduledActionOnResultsAvailable())}),k.on("live",()=>{k.fileChangedInEditor(k.fileName,k.textDocument.getText(),void 0,void 0,k.fileId,this._getLogpoints(k)),k.fileOpenedInEditor(k.fileName),k.editors.includes(b.activeTextEditor)&&r.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!0)}),k.on("configChanged",e=>{var t,i,s,o,n,a;this._changePro(e&&e.pro),r.commands.executeCommand("setContext","quokka.isProfilingEnabled",!!(null===(t=e.pro)||void 0===t?void 0:t.profiling)),r.commands.executeCommand("setContext","quokka.isCodeStoryEnabled",!!(null===(i=e.pro)||void 0===i?void 0:i.codeStory)),r.commands.executeCommand("setContext","quokka.isAllowedDebuggerEditAndContinue",!!(null===(s=e.pro)||void 0===s?void 0:s.allowDebuggerEditAndContinue)),null===(o=k.output)||void 0===o||o.setHeaderData(e),k.headerData=e,k.showValueOnSelection=!0===e.showValueOnSelection,k.showSingleInlineValue=!0===e.showSingleInlineValue,k.autoLog=!0===e.autoLog,k.isProfilingEnabled=!!(null===(n=e.pro)||void 0===n?void 0:n.profiling),k.isCodeStoryEnabled=!!(null===(a=e.pro)||void 0===a?void 0:a.codeStory),this._setShowValueOnSelectionEnabledContext(k.showValueOnSelection),this._setShowSingleInlineValueEnabledContext(k.showSingleInlineValue),this._setAutoLogEnabledContext(k.autoLog),this._sendToLiveShareClients("configChanged",k,e)}),k.on("documentUpdates",e=>{delete k.documentUpdates,k.traceExplorer.anyVisibleCodeStoryEditors()&&(k.documentUpdates=e),this._updateDocuments(k,e),k.traceExplorer.traceBeingNavigated()&&k.traceExplorer.forEachVisibleCodeStoryEditor(t=>k.traceExplorer.updateTimelineEditorInlineValueDecorations(t,k.activeLineNumber+1,e)),this._sendToLiveShareClients("documentUpdates",k,e)}),k.on("consoleError",e=>{e&&e.split("\n").forEach(e=>e&&this._debugOutputChannel.appendLine(`[Error] #${k.id} ${e}`,"error")),k.emit("stats",e)}),k.on("consoleLog",e=>{e&&e.split("\n").forEach(e=>e&&this._debugOutputChannel.appendLine(`[Info]  #${k.id} ${e}`))}),k.on("consoleOutput",e=>{this._sendToLiveShareClients("consoleOutput",k,e),this._displayLiveConsoleOutput(k,e)}),k.on("navigationRequested",e=>this._navigate(e.file,e.loc,e.options?{focus:e.options.focus,reveal:!0,select:!0,source:e.options.source}:void 0)),k.on("profileAvailable",e=>{r.commands.executeCommand("vscode.open",r.Uri.file(e.path),-2)}),k.on("traceNavigated",e=>this._processTraceNavigation(k,e)),k.on("traceNavigationReset",()=>this.stopTraceNavigation()),k.on("testTimelineReset",()=>this.closeCodeStory(k)),k.on("valuePeekMaybeChanged",e=>{if(k.valuePeek=e.value,!e.value&&k.hoverValues)for(const[e,t]of Object.entries(k.hoverValues))t.peek&&("error"===t.hoverType?delete t.log:delete k.hoverValues[e])})),k.status="progress",this._updateStatusBarForActiveSession(k),S.add(()=>{var e,t,i,s;if(null===(e=k.output)||void 0===e||e.dispose(),k.traceExplorer.dispose(),k.tasks)for(const e of Object.keys(k.tasks))k.tasks[e]("completion");null===(t=this._overviewWebviewViewHandle)||void 0===t||t.remove(k.ui),k.stop(),this._clearDecorations(k),delete k.editors,delete k.disposable,delete k.output,delete k.ui,delete k.uiStarted,k===this._activeSession&&delete this._activeSession,M._clearIdleSessionTimeout(k),this._debugOutputChannel.appendLine(`[Info]  #${k.id} Quokka.js stopped`),null===(i=this.outputChannel)||void 0===i||i.clear(),null===(s=this.outputChannel)||void 0===s||s.append(P)}),this.emit("started");const T=this._context.workspaceState.get("quokka:runningstate:"+M._hash(k.textDocument.uri.fsPath));return this._automaticRestart&&k.mode===I.automatic?this._context.workspaceState.update("quokka:runningstate:"+M._hash(k.textDocument.uri.fsPath),1):T&&this._context.workspaceState.update("quokka:runningstate:"+M._hash(k.textDocument.uri.fsPath),0),t}_wrapMarkdownInHtmlTable(e){return`<table><tr><td>\n\n${e}\n</td></tr></table>`}_makeHeaderText(e,t){return`<b><small><span style="color:var(${t?"--vscode-editorError-foreground":"--vscode-editorLightBulb-foreground"});">${e}</span></small></b>`}_getHoverEntryHeaderHtml(e,t,i,s){const o=this._makeIcon.bind(this,t),n=[o("Debug","quokka.debug","debug",i&&!s),o("Copy to Clipboard","quokka.hoverCopy","copy",!0,()=>({line:t,copyTarget:i?"error":"log"}))];return this._makeIconHeader(e,[...n,...this._prevGenGuiEnabled?[o("Reveal in Value Explorer","quokka.revealInValueExplorer","list-tree",!i,()=>({loc:t}))]:[o("Explore value","quokka.exploreEntity","list-tree",!i,()=>({line:t}))]].filter(e=>null!==e))}_makeIconHeader(e,t){return`<table width="100%">\n<tr>\n<td>${e||""}&nbsp;&nbsp;</td>\n<td align="right">${t.join("&nbsp;&nbsp;")}</td>\n</tr>\n</table>\n\n`}_makeIcon(e,t,i,s,o,n){if(!o)return null;const a=n?n():{line:e},l=encodeURIComponent(JSON.stringify(a));return`<a href="${r.Uri.parse(`command:${i}?`+l)}" title="${t}"><span class="codicon codicon-${s}"></span></a>`}hoverCopy(e){const t=this._activeSession;if(!t)return;const{line:i,copyTarget:s}=e||{},o=t.hoverValues[i-1];if(o){const e=o[s];e&&r.env.clipboard.writeText(e)}}exploreEntity(e){return s(this,void 0,void 0,function*(){var t;const i=this._activeSession;if(!i||this._prevGenGuiEnabled)return;const{line:s}=e||{line:void 0!==i.activeLineNumber?i.activeLineNumber+1:void 0};void 0!==s&&(this._overviewWebviewViewHandle.webviewView?yield this._showOutput():(yield this._showOutput(),yield new Promise(e=>setTimeout(e,300))),null===(t=i.exploreEntity)||void 0===t||t.call(i,{location:{file:i.fileName,line:s},source:{log:!0}}))})}_setPreferences(e=!1){const t=this._activeSession;if(t&&!this._prevGenGuiEnabled){const e={editor:{theme:k(),settings:S(this._context.extension.extensionKind)}},i=JSON.stringify(e);t._serializedPreferences!==i&&(t._serializedPreferences=i,t.setPreferences(e))}}_isSelectionValidForShowValueInDebugger(e,t){if(e.traceExplorer.traceBeingNavigated()&&(t.start.line===t.end.line&&t.start.character!==t.end.character||t.start.line===t.end.line-1&&0===t.end.character))return!0}_isSelectionValidForValuePeek(e){return e.start.line===e.end.line&&e.start.character!==e.end.character||e.start.line===e.end.line-1&&0===e.end.character}processStats(e){e.stats&&(e.output&&M._outputResults(e.output,e.stats),this._processErrors(e)),this._updateStatusBarForActiveSession(e),M._sessionIsActive(e)}processStarted(e){r.workspace.getConfiguration().get("quokka.showOutputOnStart",!0)&&e.mode!==I.snapsOnly&&(this._liveShareClientActive()?this._liveShare.outputChannelShown||(this._liveShare.outputChannelShown=!0,this._showOutput()):this._showOutput()),this._liveShareClientActive()&&b.showTextDocument(e.textDocument,e.editors&&(e.editors.length||void 0)&&e.editors[0]&&e.editors[0].viewColumn),this._setPreferences(!0)}processSessionBusy(e){clearTimeout(this._statusUpdateTimeout),this._statusUpdateTimeout=setTimeout(()=>{e.status="progress",this._updateStatusBarForActiveSession(e)},x),e.liveConsoleOutput=[],e.allLiveConsoleOutput=[],this._scheduleSessionIdleTimeout(e)}_updateBreakpointsContext(e){e.hasAnyEnabledBreakpointsInActiveEditor=!!this._getBreakpoints(e).length,e===this._activeSession&&this._setContext("quokka.hasAnyEnabledBreakpointsInActiveEditor",e.hasAnyEnabledBreakpointsInActiveEditor),this._activeSessions.forEach(e=>{var t;return null===(t=e.output)||void 0===t?void 0:t.refreshHeaderCommands()})}_forceDeactivate(){this._deactivator(),c.each(N,e=>r.commands.registerCommand(`quokka.${e}`,()=>b.showWarningMessage("Please restart VS Code for a new trial session of Quokka.js 'Pro'.")))}_showNotification(e,t){const i=[];if(~e.text.indexOf("expire")&&"warning"===e.type&&this._suppressExpirationNotifications)return;const s=e=>e&&e.url&&r.commands.executeCommand("vscode.open",e.url);if("expiredLicense"===e.id)if(e.invalidVersion){e.text="You are not licensed to use Quokka PRO features for this version of Quokka. As your 12 months of free Quokka updates have expired, this is likely a result of VS Code updating your Quokka extension automatically.",i.push({title:"Renew",url:r.Uri.parse(f.getLicenseDetails().renewUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"}),i.push({title:"Switch to 'Community'",command:"quokka.switchToCommunity"});const t=new Date(e.expiryDate),o="https://quokkajs.com/docs/previous.html?expirydate="+t.getUTCFullYear()+"-"+(t.getUTCMonth()+1)+"-"+t.getUTCDate();i.push({title:"Help / Downgrade",url:r.Uri.parse(o),command:s})}else{e.text="Your Quokka.js 'Pro' license free upgrades period has expired. If you would like to work with the latest version of Quokka.js 'Pro' and future versions released within the next 12 months, please renew your license. If you have already purchased the new license, please activate it.",i.push({title:"Renew",url:r.Uri.parse(f.getLicenseDetails().renewUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"});const t=()=>{r.workspace.getConfiguration().update("quokka.suppressExpirationNotifications",!0,r.ConfigurationTarget.Global)};i.push({title:"Don't show again",command:t})}else e.expiringSoon?e.trial?(e.text="Your Quokka trial period is almost over and finishes on "+e.expirationDateStringFormatted+". If you would like to continue to use Quokka 'PRO', please visit our website to purchase a license.",i.push({title:"Purchase",url:r.Uri.parse(f.getLicenseDetails().purchaseUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"})):(e.text="Your Quokka license free upgrades period expires on "+e.expirationDateStringFormatted+". If you would like to work with the latest version of Quokka and future versions released within the next 12 months, please visit our website to upgrade your license.",i.push({title:"Renew",url:r.Uri.parse(f.getLicenseDetails().renewUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"}),i.push({title:"What's New",command:()=>{f.createOrShow(this._context,{type:"showAllWhatsNew"})}})):e.suggestProEdition?(i.push({title:"Switch to 'Pro'",command:()=>{this._switchEdition(!0,t),f.createOrShow(this._context,{type:"goToLicenseSection"})}}),i.push({title:"More info",url:r.Uri.parse("https://quokkajs.com/pro?referrer=VSCode"),command:s})):e.logPoints?(i.push({title:"More about Logpoints",url:r.Uri.parse("https://quokkajs.com/whatsnew/logpoints.html?referrer=VSCode"),command:s}),i.push({title:"Turn Show Value On Selection back On",command:()=>{const e=this._loadQuokkaConfig();e.showValueOnSelection=!0,this._saveQuokkaConfig(e)}})):(~e.text.indexOf("continue-trial-link")?i.push({title:"Continue Trial",command:()=>t&&!t.isDisposed()&&t.continueTrial()}):~e.text.indexOf("extended-trial-license-link")&&i.push({title:"Request License",command:"_requestTrialLicense"}),~e.text.indexOf("activate-link")&&i.push({title:"Activate",command:"quokka.showLicense"}),~e.text.indexOf("purchase")&&(i.push({title:"Purchase",url:r.Uri.parse("https://quokkajs.com/pro?referrer=VSCode"),command:s}),i.push({title:"Switch to 'Community'",command:"quokka.switchToCommunity"})));e.allowMuting&&i.push({title:"Don't show again",command:()=>t&&!t.isDisposed()&&t.muteNotification(e.id)}),e.text=e.text.replace(/<br\/><br\/>/g," ").replace(/<br\/>/g," ").replace(/<[^>]*>/g,"");const o=[e.text].concat(i);b["show"+e.type.charAt(0).toUpperCase()+e.type.substr(1)+("info"===e.type?"rmation":"")+"Message"].apply(b,o).then(this._executeCommand),0===e.text.indexOf("Can not start node.js process")&&b.showInformationMessage('You may use the "node" setting to configure the location of node.',{title:"More info",url:r.Uri.parse("https://quokkajs.com/docs/configuration.html#nodejs-version")}).then(e=>{e&&e.url&&r.commands.executeCommand("vscode.open",e.url)})}_checkAndSyncSession(e){var t,i,s,o;return!(!b.visibleTextEditors.find(t=>t.document===e.textDocument)||e===this._activeSession)&&(this._activeSession&&(null===(t=this._activeSession.output)||void 0===t||t.disableChannel(),this._activeSession.traceExplorer.closeCodeStory(!0)),this._activeSession=e,e.ui&&(null===(i=this._overviewWebviewViewHandle)||void 0===i||i.activate(e.ui)),this._liveShareClientActive()||(e.mode===I.snapsOnly?this._setSnapsExecutionAllowed(e.metadata.permissive):this._setSnapsExecutionAllowed(!0)),this._updateBreakpointsContext(e),null===(s=e.output)||void 0===s||s.enableChannel(),null===(o=e.output)||void 0===o||o.render(),this.processStats(e),!0)}_requestTrialLicense(){f.createOrShow(this._context,{type:"trial"})}showLicense(){f.createOrShow(this._context,{type:"activate"})}processLicenseChange(e,t){if(c.isUndefined(e))return;let i="";try{i=JSON.parse(Buffer.from(n.readFileSync(this._ol).toString(),"base64").toString())}catch(e){i={}}let s="";try{s=n.readFileSync(this._lkp).toString()}catch(e){}if(/^[a-zA-Z0-9_+&*-]+(?:\.[a-zA-Z0-9_+&*-]+)*@(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,63}$/.test(e)){try{i.quokkaEmail=e.trim(),i.lastUpdate=(new Date).getTime(),n.writeFileSync(this._ol,Buffer.from(JSON.stringify(i)).toString("base64")),this._activeLicenseSession&&(this._activeLicenseSession.stop(),this._activeLicenseSession=null);const s=new this._Session;s.stop=(()=>{s===this._activeLicenseSession&&(this._activeLicenseSession=null)}),s.start({localRoot:this._projectRoot(),quokkaFolder:this._quokkaFolder,client:"VSCode",cv:r.version,fileName:"quokka.js",editorTypeScript:process.mainModule?o.join(process.mainModule.filename,"../../extensions/node_modules/typescript"):void 0,ol:!0}),s.on("notification",e=>{t({type:"notification",text:e})}),this._activeLicenseSession=s,this.switchToPro()}catch(e){t({type:"error",text:"Unable to save email activation request: "+e.message,items:["Dismiss"]})}return}try{n.unlinkSync(this._ol)}catch(e){}const l=s,d=e||"",u=!!this._parseLicenseKey(l),h=this._parseLicenseKey(d),p=!!h;let _=!1;if(p||!d&&u)try{if(n.writeFileSync(this._lkp,d),h.isBundle){const e=o.join(a.homedir(),".wallaby"),t=o.join(e,"key.lic");n.existsSync(e)||n.mkdirSync(e),n.writeFileSync(t,d)}_=p}catch(e){t({type:"error",text:"Unable to save license key: "+e.message,items:["Dismiss"]}),_=!1}else t({type:"error",text:"The entered license key is not a valid Quokka.js 'Pro' license key.",items:[]});_&&(t({type:"info",text:`Quokka.js 'Pro' is licensed to: ${h.licensee}. Upgrades and updates until: ${h.expiration}.`,items:[]}),this.switchToPro()),this._syncSettings()}_parseLicenseKey(e){if(c.isString(e))try{let t=this._utils.parseKey(e);if(t.licenseeName&&t.expirationDateString&&~t.licensedProduct.indexOf("Quokka"))return{licensee:t.licenseeName,isBundle:0===t.licensedProduct.indexOf("Wallaby.js + Quokka.js"),expiration:t.expirationDateStringFormatted||t.expirationDateString}}catch(e){return}}switchToCommunity(){this._switchEdition(!1,this._activeSession)}switchToPro(){this._switchEdition(!0,this._activeSession)}_treasureHunt(){this._createLanguageFile("JavaScript",`/*_____________________________________________________________________________\n__________  DO YOU HAVE WHAT IT TAKES TO FIND QUOKKA PRO TREASURE?  ___________\n          |                   |                  |                     |\n _________|________________.=""_;=.______________|_____________________|_______\n|                   |  ,-"_,=""     \`"=.|                  |\n|___________________|__"=._o\`"-._        \`"=.______________|___________________\n          |                \`"=._o\`"=._      _\`"=._                     |\n _________|_____________________:=._o "=._."_.-="'"=.__________________|_______\n|                   |    __.--" , ; \`"=._o." ,-"""-._ ".   |\n|___________________|_._"  ,. .\` \` \`\` ,  \`"-._"-._   ". '__|___________________\n          |           |o\`"=._\` , "\` \`; .". ,  "-._"-._; ;              |\n _________|___________| ;\`-.o\`"=._; ." \` '\`."\\\` . "-._ /_______________|_______\n|                   | |o;    \`"-.o\`"=._\`\`  '\` " ,__.--o;   |\n|___________________|_| ;     (#) \`-.o \`"=.\`_.--"_o.-; ;___|___________________\n____/______/______/___|o;._    "      \`".o|o_.--"    ;o;____/______/______/____\n/______/______/______/_"=._o--._        ; | ;        ; ;/______/______/______/_\n____/______/______/______/__"=._o--._   ;o|o;     _._;o;____/______/______/____\n/______/______/______/______/____"=._o._; | ;_.--"o.--"_/______/______/______/_\n____/______/______/______/______/_____"=.o|o_.--""___/______/______/______/____\n/______/______/______/______/______/______/______/______/______/______/______*/\n\n// Welcome to Quokka Pro Treasure Hunt! It only takes a minute to complete,\n// and a very special surprise awaits those who can do it.\n\n// If you get stuck, here's some pointers:\n// Quick Module Install:  https://quokkajs.com/docs/#modules\n// Live Comments:         https://quokkajs.com/docs/#comments\n// Value Explorer:        https://quokkajs.com/docs/#value-explorer\n\n// Good luck and enjoy!\n\n// 1) Fix the error below and install the missing module for the current quokka\n//    file using the link in the Quokka output or in the line hover message\n//    or quick action.\n\n${E}\n\n// 2) So, you have found an old chest, there may be some treasure inside it.\n//    You need to pass a correct string key to the "open" function.\n//    The "open" function returns a clue about how to find the key.\n//    Add Quokka live comment at the end of the line to see the returned value:\n//    chest.open('paste_key_here') //?\n\nchest.open('paste_key_here')\n`,"treasure-hunt")}_switchEdition(e,t){const i=this._loadQuokkaConfig();if(i.pro=e,this._changePro(e),this._saveQuokkaConfig(i),!this._liveShareClientActive()&&t&&!t.isDisposed()){const e=t.textDocument,i=t.editors[0];this.stopAll(!0),!i||t.mode!==I.automatic&&t.mode!==I.snapsOnly&&t.mode!==I.onsave||this._start(e,i,t.mode)}}_processErrors(e){this._liveShareClientActive()||e.stats.errors&&(e.errors={},M._addError(e,M._createLineDataObject(e,e=>e.missingPackage,e=>[{title:`Install "${e.missingPackage}" package for the current quokka file`,command:"installMissingPackageToQuokka"},this._projectRoot()&&{title:`Install "${e.missingPackage}" package into the project`,command:"installMissingPackageToProject"}])),M._addError(e,M._createLineDataObject(e,e=>e.missingBrowserGlobal,e=>[{title:`"${e.missingBrowserGlobal}" looks like a browser global`},{title:"Install and use quokka browser plugin",command:"installQuokkaPlugin",args:["jsdom","jsdom-quokka-plugin"]}])),M._addError(e,M._createLineDataObject(e,e=>e.undefinedName,e=>[{title:`Add "import ${e.undefinedName} from '${e.undefinedName}';"`,command:"addImport",arg:e.undefinedName},{title:`Add "const ${e.undefinedName} = require('${e.undefinedName}');"`,command:"addRequire",arg:e.undefinedName}])))}static _addError(e,t){t&&(e.errors[t.line]=t)}static _createHoverObject(e){return e.filter(e=>!!e).map(e=>e.command?`\n[${e.title}](${encodeURI(`command:quokka.${e.command}${e.arg?"?"+JSON.stringify(e.arg):""}`)})`:e.title).join("\n")}static _createCommands(e){return e.filter(e=>e&&e.command).map(e=>({title:e.title,command:`quokka.${e.command}`,arguments:e.args?e.args:e.arg?[e.arg]:void 0}))}static _createLineDataObject(e,t,i){const s=e.stats.errors.find(t),o=s&&s.stack||[];if(o.length){const t=c.find(o,t=>t.file===e.fileName);if(t&&t.loc&&t.loc.split){const e=i(s);let o=M._createHoverObject(e);return r.MarkdownString&&((o=new r.MarkdownString(o)).isTrusted=!0),{line:parseInt(t.loc.split(":")[0],10)-1,hover:{value:o},commands:M._createCommands(e)}}}}static _checkConfigurationSettings(){try{let e=r.workspace.getConfiguration();if(e){e.get("quokka.suppressGlyphMarginNotifications",!1)||e.get("editor.glyphMargin",!0)||b.showWarningMessage("Quokka.js will not display coverage indicators in the gutter because the `editor.glyphMargin` setting is set to `false`. You can hide this message by setting `quokka.suppressGlyphMarginNotifications` to `false`.")}}catch(e){}}_updateConfigurationFromSettings(){let e="",t=!1;try{var i=this._loadQuokkaConfig();e=i.node,i.useWsl&&(t=i.useWsl)}catch(e){}try{process.env.WALLABY_USE_WSL=t;const i=r.workspace.getConfiguration();if(i){this._suppressExpirationNotifications=i.get("quokka.suppressExpirationNotifications",!1),this._colorizeOutput=i.get("quokka.colorizeOutput",!0),this._compactMessageOutput=i.get("quokka.compactMessageOutput",!1);const t=i.get("quokka.node",e);t?process.env.WALLABY_NODE=t:delete process.env.WALLABY_NODE}}catch(e){}}activate(){let e;this._checkSnapMarkers=c.debounce(c.bind(this._upgradeBackgroundSession,this),1e3),this._onceDocumentStopsChanging=c.debounce(c.bind(this._onceDocumentStopsChanging,this),100),this._onceDocumentStopsChangingWithDelay=c.debounce(c.bind(this._onceDocumentStopsChanging,this),1e3),M._outputResults=c.debounce(c.bind(M._outputResults,this),100),this._executeCommand=c.bind(this._execute,this),this._disposables.add(()=>{var e;if(null===(e=this._statusBarItem)||void 0===e||e.dispose(),this._activeLicenseSession)try{this._activeLicenseSession.stop(),this._activeLicenseSession=null}catch(e){}this._activeSessions.forEach(e=>e.disposable.dispose()),this._activeSessions.length=0,r.commands.executeCommand("setContext","quokka.hasActiveSession",!1)});const t=()=>{try{const i=this._context.globalState.get("quokka:runRecentFile");i&&g.pathToMetadataKey(i.projectRoot)===g.pathToMetadataKey(this._projectRoot())&&(this._context.globalState.update("quokka:runRecentFile",void 0),this.runRecentFile(i))}finally{e=setTimeout(t,1e3)}};t(),this._disposables.add(()=>{clearTimeout(e)})}_projectRoot(e){if(e&&this._multiFolderWorkspaces&&C.workspaceFolders&&C.workspaceFolders.length){const t=c.find(C.workspaceFolders,t=>~e.indexOf(t.uri.fsPath+o.sep));if(t)return this._currectProjectRoot=t.uri.fsPath,this._currectProjectRoot}if(this._currectProjectRoot)if(this._multiFolderWorkspaces&&C.workspaceFolders){const e=c.find(C.workspaceFolders,e=>this._currectProjectRoot===e.uri.fsPath);if(e)return e.uri.fsPath}else if(C.rootPath&&this._currectProjectRoot===C.rootPath)return C.rootPath;return this._multiFolderWorkspaces&&C.workspaceFolders?C.workspaceFolders.length?C.workspaceFolders[0].uri.fsPath:void 0:C.rootPath||""}selectWorkspaceFolder(){this._multiFolderWorkspaces&&C.workspaceFolders&&C.workspaceFolders.length>1&&b.showWorkspaceFolderPick&&b.showWorkspaceFolderPick().then(e=>{e&&(this._currectProjectRoot=e.uri.fsPath)})}deactivate(){this._disposables.dispose()}static _sessionIsActive(e){M._clearIdleSessionTimeout(e)}_sessionIsIdle(e){var t;e.editors&&this._clearDecorations(e),delete e.stats,e.liveConsoleOutput&&!e.liveConsoleOutput.started&&(null===(t=e.output)||void 0===t||t.clearAndRenderHeader())}static _clearIdleSessionTimeout(e){e.idleTimeout&&(clearTimeout(e.idleTimeout),delete e.idleTimeout)}_clearDecorations(e){e.editors.forEach(e=>{c.each(this._coverageDecorationTypes,t=>e.setDecorations(t,[]))})}_scheduleSessionIdleTimeout(e){M._clearIdleSessionTimeout(e),e.idleTimeout=setTimeout(()=>this._sessionIsIdle(e),T)}_displayLiveConsoleOutput(e,t){if(!e.liveConsoleOutput)return;const i=e.liveConsoleOutput.started;e.liveConsoleOutput=e.liveConsoleOutput.concat(t),e.liveConsoleOutput.started=i,e.liveConsoleOutput.started?e.displayLiveConsoleOutputTimeout||this._displayPendingLiveConsoleOutput(e):(e.liveConsoleOutput.started=!0,e.displayLiveConsoleOutputTimeout=setTimeout(()=>{var t;delete e.displayLiveConsoleOutputTimeout,e.liveConsoleOutput&&e.liveConsoleOutput.length&&(null===(t=e.output)||void 0===t||t.clearAndRenderHeader(),this._displayPendingLiveConsoleOutput(e))},150))}_displayPendingLiveConsoleOutput(e){e.allLiveConsoleOutput=e.allLiveConsoleOutput.concat(e.liveConsoleOutput),e.liveConsoleOutput.forEach(t=>{var i;return null===(i=e.output)||void 0===i?void 0:i.appendConsoleMessage(t)}),e.liveConsoleOutput.length=0}_execute(e){if(e&&e.command)return"function"==typeof e.command?e.command(e):~e.command.indexOf("quokka.")?r.commands.executeCommand(e.command):this[e.command]()}_processDocumentContentChange(e,t,i,s){e.isDisposed()||t&&t.uri&&t.uri.scheme&&"file"!==t.uri.scheme&&"untitled"!==t.uri.scheme&&"vsls"!==t.uri.scheme||(i.length&&(e.changeTs=Date.now()),e.changes=e.changes.concat(i),s&&(!this._liveShareClientActive()&&e.mode===I.snapsOnly&&e.metadata.counters.misses>3?this._onceDocumentStopsChangingWithDelay(e,t):this._onceDocumentStopsChanging(e,t)))}_onceDocumentStopsChanging(e,t){if(e.isDisposed()||!e.changes.length||t.isClosed)return;if(this._liveShareClientActive())return;clearTimeout(this._statusUpdateTimeout);const i=t.getText();if(e.mode===I.snapsOnly&&e.snaps){if(e.metadata.permissive)if(1===e.changes.length&&"``"===e.changes[0].text){const t=e.changes[0],i=t.range.start.line+1,s=t.range.start.character,o=e.snaps.lines[t.range.start.line];o&&o.body.range[2]===i&&o.body.range[3]===s?e.preservedCursorPosition={line:t.range.start.line,character:t.range.start.character+1}:delete e.preservedCursorPosition}else delete e.preservedCursorPosition;else{const t=t=>{const i=t.range.start.line+1,s=t.range.start.character+1,o=e.snaps.lines[t.range.start.line];o&&(o.body.range[0]<i&&o.body.range[2]>i||o.body.range[0]===i&&o.body.range[2]!==i&&o.body.range[1]+2<s||o.body.range[0]===i&&o.body.range[2]===i&&o.body.range[1]+2<s&&o.body.range[3]>=s||o.body.range[2]===i&&o.body.range[0]!==i&&o.body.range[3]>=s)&&(this._liveShareServerActive()?b.showInformationMessage("Please use the code action or the command to active the snap."):(e.allowToRunSnaps(),e.metadata.permissive=!0,this._setSnapsExecutionAllowed(!0)))};if(1===e.changes.length&&0===e.changes[0].rangeLength&&" "===e.changes[0].text){const i=e.changes[0];e.metadata.trigger&&e.snaps?(Date.now()-e.metadata.trigger.timestamp<1e3&&e.metadata.trigger.offset+1===i.rangeOffset&&t(i),delete e.metadata.trigger):e.metadata.trigger={offset:e.changes[0].rangeOffset,timestamp:Date.now()}}else 2===e.changes.length&&0===e.changes[0].rangeLength&&0===e.changes[1].rangeLength&&e.changes[0].rangeOffset+1===e.changes[1].rangeOffset&&" "===e.changes[0].text&&" "===e.changes[1].text?(t(e.changes[1]),delete e.metadata.trigger):delete e.metadata.trigger}if(e.metadata.counters.misses>5&&!this._doChangesHaveSnapMarkersTraces(t,e.changes)&&!this._doesTextContainSnapMarkers(i))return void(e.changes=[])}this._statusUpdateTimeout=setTimeout(()=>{e.status="progress",this._updateStatusBarForActiveSession(e)},x),e.fileChangedInEditor(e.fileName,i,{start:c.chain(e.changes).map(e=>e.range.start.line).min().value()+1,end:c.chain(e.changes).map(e=>e.range.end.line).max().value()+1},!1,e.fileId,this._getLogpoints(e)),e.content=i,e.changes=[]}_resetStatusBar(){this._statusBarItem.command="quokka.selectAction",this._statusBarItem.text=`$(debug-disconnect)${V}`,this._statusBarItem.tooltip=this._makeStatusBarTooltip("reset")}_updateStatusBarForBackgroundSession(e){this._statusBarItem.command="quokka.selectAction";let t="$(eye)";switch(e){case"paused":t="$(eye-closed)";break;case"disabled":t="$(debug-disconnect)";break;default:t="$(eye)"}this._statusBarItem.text=`${t}${V}`,this._statusBarItem.tooltip=this._makeStatusBarTooltip(e)}_updateStatusBarForActiveSession(e,t=!0){if(!e.isDisposed()){if(clearTimeout(this._statusUpdateTimeout),e.metadata&&!e.metadata.permissive||e.stats&&e.stats.noSnapsFound){this._statusBarItem.text=`$(zap)${V}`,this._statusBarItem.command="quokka.selectAction";const t=e.metadata&&!e.metadata.permissive?"blocked":"empty";this._statusBarItem.tooltip=this._makeStatusBarTooltip(t)}else{this._statusBarItem.command=e.mode!==I.snapsOnly?"quokka.showOutput":"quokka.selectAction";let t,i=e.status;i||(i=c.isString(e.stats)?"failing":e.stats?e.stats.errors.length?"failing":"passing":"failing",t=e.mode!==I.snapsOnly&&e.stats&&e.stats.time),i&&(this._statusBarItem.text="progress"===i?`$(sync~spin)${V}`:`${"failing"===i?"$(warning)":"$(check-all)"}${V}${t?` ${t}ms`:""}`),this._statusBarItem.tooltip=this._makeStatusBarTooltip("running")}t&&this._checkAndSyncSession(e)}}_updateDocuments(e,t){if(e.isDisposed())return;if(e.changes.length&&!this._liveShareClientActive()){let t=!0;if(1===e.changes.length){const i=e.changes[0];if(1===i.text.length&&j.has(i.text)){const i=e.textDocument.getText();e.content&&e.content.length===i.length&&e.content===i&&(t=!1)}}if(t)return}e.documentUpdates=t,e.updateTs=Date.now(),e.hoverValues=Object.create(null);const i=b.activeTextEditor&&b.activeTextEditor.selection;let s=void 0,o=!1;i&&i.active&&(s=i.active.line);const n=e.preservedCursorPosition;delete e.preservedCursorPosition;const a=new Set;c.each(b.visibleTextEditors,l=>{if(!l)return;const d=l.document;if(d!==e.textDocument)return;e.hasRemovableMessages=!1,e.messages=Object.create(null);const u=t[e.fileName];if(!u)return;const h={1:[],2:[],3:[],4:[],5:[],6:[],7:[],8:[],9:[],10:[],systemLog:[],watchExpression:[]};if(c.each(u.lines||[],t=>{var i;const n=t.num-1;if(n<0||n>=d.lineCount)return;const a=d.lineAt(n);if(!a)return;const l=t.meta||{},c={range:new r.Range(a.lineNumber,a.firstNonWhitespaceCharacterIndex,a.lineNumber,a.range.end.character)};let u,p,_;if(e.selectedLines&&!e.selectedLines.has(a.lineNumber)||(u=t.err||t.log,p=t.longLog||u,_=l.log&&l.log.system),!p||_||!e.valuePeek&&(null===(i=t.meta)||void 0===i?void 0:i.peek)||(e.hoverValues[a.lineNumber]=Object.assign({log:t.longLog||t.log,error:t.err},l.peek?{peek:!0}:{})),h[_?"systemLog":t.state+(t.meta&&t.meta.system?5:0)].push(c),(!l.peek||l.error)&&u&&(c.renderOptions={after:{contentText:u}},t.log)){const t=l.log&&l.log.removable;e.messages[a.lineNumber]={removable:t},t&&(e.hasRemovableMessages=!0,a.lineNumber===s&&(o=!0))}if(l.watchExpression&&!this._prevGenGuiEnabled){const e=l.watchExpression.range,t={range:new r.Range(a.lineNumber,Math.max(a.firstNonWhitespaceCharacterIndex,e[1]),a.lineNumber,e[0]===e[2]?Math.min(a.range.end.character,e[3]):a.range.end.character)};if(!u){const e=Object.assign({},t);e.renderOptions={after:{contentText:"  n/a"}},h.systemLog.push(e)}t.range.start.line===t.range.end.line&&t.range.start.character===t.range.end.character||h.watchExpression.push(t)}}),(u.snaps||u.lines)&&c.each(h,(e,t)=>l.setDecorations(this._coverageDecorationTypes[t],e)),u.snaps&&u.snaps.length){e.snaps={lines:{},raw:u.snaps};for(const t of u.snaps){const i=t.body.range[0]-1,s=t.body.range[2]-1;for(let o=i;o<=s;o++)e.snaps.lines[o]=t;if(t.output&&t.output.range){const i=t.output.range[0]-1,s=t.output.range[2]-1;for(let o=i;o<=s;o++)e.snaps.lines[o]=t}}}else delete e.snaps;if(u.snaps&&u.snaps.length&&!u.noCodeChange&&!a.has(d)&&!this._liveShareClientActive()){let e=!1;const t=new r.WorkspaceEdit;for(const i of u.snaps){const s=this._validateSnapOutputRange(d,i);s&&(t.replace(d.uri,s,i.output.content),e=!0)}if(e){this._applyingInlineOutputEdits=!0;const e=n&&i&&i.active&&i.active.line===n.line&&i.active.character===n.character;r.workspace.applyEdit(t).then(()=>{e&&(b.activeTextEditor.selection=i)})}}a.add(d)}),b.activeTextEditor&&e.textDocument===b.activeTextEditor.document&&(this._setInlineValuesLineContext(o),this._setInlineValuesFileContext(e.hasRemovableMessages))}_navigate(e,t,{reveal:i=!0,select:s=!0,focus:o=!0}={reveal:!0,select:!0,focus:!0}){if(!e)return;if(this._activeSession&&e===this._activeSession.fileName)return this.goToLineInQuokkaFile(t,{reveal:i,select:s,focus:o});let n,a,l=this._absoluteFilePath(e);return c.isNumber(t)?n=t:c.isArray(t)?(n=t[0],a=t[1]):c.isString(t)&&(t=t.split(":"),n=t[0]&&parseInt(t[0],10),a=t[1]&&parseInt(t[1],10)),c.isNumber(n)?n-=1:n=0,c.isNumber(a)||(a=0),C.openTextDocument(l).then(e=>b.showTextDocument(e,{preserveFocus:!o})).then(e=>{if(!i)return e;if(!a){const t=e.document&&e.document.lineAt(n);t&&(a=t.firstNonWhitespaceCharacterIndex)}let t=new r.Position(n,a);return e.revealRange(new r.Range(t,t),2),s?(e.selection=new r.Selection(t,t),e):e})}_processTraceNavigation(e,t,i=!0,s=!1){t&&t.restart&&(i=!1),t&&t.broadcast&&(i=!1),c.each(b.visibleTextEditors,t=>e.traceExplorer.destroyStackTraceDecorations(t));const{decorationType:o,step:n}=e.traceExplorer.traceNavigated(t);if(this._updateStatusBarForActiveSession(e),o)return this._navigateWithTraceHighlight(e,n,o,{onlyHighlightRangeInVisibleEditors:i,preserveTimelineSelection:s,requestTimelineIfStepIsOutOfSight:!0})}_highlightActiveTraceStepIfRequired(e,t,{reveal:i=!1,onlyHighlightRangeInVisibleEditors:s=!0}){if(t&&e.traceExplorer.traceBeingNavigated()){const o=e.traceExplorer.lastActiveStep();o&&t.document&&this._navigateWithTraceHighlight(e,o,e.traceExplorer.activeTraceFrameDecorationType(),{reveal:i,onlyHighlightRangeInVisibleEditors:s})}}stopTraceNavigation(){const e=this._activeSession;e&&(e.traceExplorer.stopTraceNavigation(),e.traceExplorer.closeCodeStory(!0),this._updateStatusBarForActiveSession(e))}viewCallStack(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&e.traceExplorer.requestCallStack()}hideCallStack(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&(e.traceExplorer.hideCallStack(),e.stats&&e.stats.trace&&(delete e.stats.trace.callStack,this.processStats(e)))}openCallStackFrame(e){const t=this._activeSession;t&&t.traceExplorer.traceBeingNavigated()&&(c.each(b.visibleTextEditors,e=>t.traceExplorer.destroyStackTraceDecorations(e)),this._navigateWithTraceHighlight(t,e,t.traceExplorer.activeTraceCallStackFrameDecorationType(),{requestTimelineIfStepIsOutOfSight:!0}),t.traceExplorer.updateTraceContextCallStackFrame(e))}revealTraceStep(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&e.editors.forEach(t=>{this._highlightActiveTraceStepIfRequired(e,t,{reveal:!0,onlyHighlightRangeInVisibleEditors:!1})})}viewCodeStory(){return s(this,arguments,void 0,function*(e={},t){if(t=t||this._activeSession){if(!t.traceExplorer.traceBeingNavigated())return this._openCodeStoryOnTraceNavigationStarted(t,e),void this.debug();yield t.traceExplorer.viewCodeStory(e),t.traceExplorer.forEachVisibleCodeStoryEditor(e=>{this._highlightActiveTraceStepIfRequired(t,e,{reveal:!0,onlyHighlightRangeInVisibleEditors:!0})})}})}_openCodeStoryOnTraceNavigationStarted(e,t){const i=e.traceExplorer.onTraceNavigationStarted(()=>{i.dispose(),this.viewCodeStory(t,e)})}closeCodeStory(e){e.traceExplorer.closeCodeStory()}_updateCodeStoryIfRequired(e,t){if(e.traceExplorer.isActiveCodeStoryViewer(t)&&!e.traceExplorer.updateCodeStoryIfLoaded(t)&&e.traceExplorer.traceBeingNavigated()){const t=e.traceExplorer.lastActiveStep();this.viewCodeStory({before:t&&t.frame})}}autoPlayCode(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&(e.traceExplorer.autoPlayCode(),this._activeSessions.forEach(e=>{var t;return null===(t=e.output)||void 0===t?void 0:t.refreshHeaderCommands()}))}pauseCodeExecution(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&(e.traceExplorer.pauseCodeExecution(),this._activeSessions.forEach(e=>{var t;return null===(t=e.output)||void 0===t?void 0:t.refreshHeaderCommands()}))}_navigateWithTraceHighlight(e,t,i,{onlyHighlightRangeInVisibleEditors:s=!1,reveal:o=!0,requestTimelineIfStepIsOutOfSight:n=!1,preserveTimelineSelection:a=!1}){const l=(e,s)=>{const o=t.range[0]!==t.range[2],n=s>=0?s:t.range[0]-1,a=e.document&&e.document.lineAt(n),l=t.range[1],c=!l&&a?a.firstNonWhitespaceCharacterIndex:l;o?e.setDecorations(i,[new r.Range(n,c,n,1e4)]):e.setDecorations(i,[new r.Range(n,c,n,t.range[3])])};if(e.traceExplorer.anyVisibleCodeStoryEditors()){const i=e.traceExplorer.getCodeStoryLineByStep(t.frame);if(i>=0?(o&&e.traceExplorer.forEachVisibleCodeStoryEditor(s=>{let o=new r.Position(i,t.range[1]);s.revealRange(new r.Range(o,o),2),a||(s.selection=new r.Selection(o,o)),e.traceExplorer.updateTimelineEditorInlineValueDecorations(s,i+1,e.documentUpdates)}),e.traceExplorer.forEachVisibleCodeStoryEditor(e=>l(e,i))):(e.traceExplorer.forEachVisibleCodeStoryEditor(t=>e.traceExplorer.destroyStackTraceDecorations(t)),n&&this.viewCodeStory({before:t.frame,reveal:!0})),e.traceExplorer.isCodeStoryViewer(b.activeTextEditor))return this._navigate(t.file,t.loc,{reveal:o&&!s,select:!1,focus:!1}).then(l)}return this._navigate(t.file,t.loc,{reveal:o&&!s,select:!s}).then(l)}_absoluteFilePath(e){const t=this._activeSession&&this._activeSession.localRoot;return o.resolve(this._projectRoot()||t,e)}_setInlineValuesLineContext(e){e=!!e,this._previousInlineValuesLineContext!==e&&(this._previousInlineValuesLineContext=e,this._setContext("quokka.lineHasRemovableInlineValues",e))}_setInlineValuesFileContext(e){e=!!e,this._previousInlineValuesFileContext!==e&&(this._previousInlineValuesFileContext=e,this._setContext("quokka.fileHasRemovableInlineValues",e))}_setShowSingleInlineValueEnabledContext(e){this._setContext("quokka.showSingleInlineValueEnabled",e)}_setShowValueOnSelectionEnabledContext(e){this._setContext("quokka.showValueOnSelectionEnabled",e)}_setAutoLogEnabledContext(e){this._setContext("quokka.autoLogEnabled",e)}_setSnapsExecutionAllowed(e){this._setContext("quokka.snapsExecutionAllowed",e)}_setContext(e,t){r.commands.executeCommand("setContext",e,t)}selectAction(){return s(this,void 0,void 0,function*(){var e;const t=[];if(this._liveShareClientActive()||!r.window.tabGroups.all.flatMap(e=>e.tabs).length)return void this.openStartView();const i=b.activeTextEditor,s=this._activeSession;if(!i||A.has(i.document.languageId)||"file"!==i.document.uri.scheme&&"untitled"!==i.document.uri.scheme){if(s&&i&&s.textDocument===i.document&&s.mode===I.snapsOnly&&s.metadata&&!s.metadata.permissive&&t.push({label:"$(zap)  Allow snap(s) execution until file is closed",action:()=>this.allowFileSnapsExecution()}),i&&(!s||s.textDocument!==i.document)&&r.workspace.getConfiguration().get("quokka.snapsAutoDiscovery",!0)){const e=this._backgroundSessions.find(e=>e.document===i.document);let s=this._filesWithSnapsDiscoveryPaused.has(i.document.uri.toString());s||(s=e&&(e.paused||e.hibernated)),s||(s=this._isDocumentNotEligibleForSnapDiscovery(i.document)&&!e),s?t.push({label:"$(eye)  Resume snaps discovery in current file",action:()=>this.startFileSnapsDiscovery()}):"file"!==i.document.uri.scheme&&"untitled"!==i.document.uri.scheme||t.push({label:"$(eye-closed)  Pause snaps discovery in current file",action:()=>this.stopFileSnapsDiscovery()})}s&&i&&s.textDocument===i.document&&s.mode===I.snapsOnly&&(this.outputChannel&&t.push({label:"$(json)  Show output pane",action:()=>this._showOutput()}),t.push({label:"$(stop-circle)  Stop",action:()=>this.stopCurrent()})),(t.length||i&&"file"!==i.document.uri.scheme&&"untitled"!==i.document.uri.scheme)&&t.push({label:"$(home)  Open start view",action:()=>this.openStartView()}),0===t.length?this.openStartView():null===(e=yield r.window.showQuickPick(t,{placeHolder:"Select an action",title:"Quokka.js"}))||void 0===e||e.action()}else this.openStartView()})}allowFileSnapsExecution(){var e;if(this._liveShareClientActive())return;const t=this._activeSession;t&&t.mode===I.snapsOnly&&(null!==(e=t.metadata)&&void 0!==e&&e.permissive||(t.metadata.permissive=!0,this._setSnapsExecutionAllowed(!0),t.allowToRunSnaps({run:!0})))}insertSnapOutput(e){const t=b.activeTextEditor;if(!t)return;if(this._liveShareClientActive())return;const i=this._activeSession;if(!i)return;if(i.changeTs&&i.changeTs>i.updateTs)return;if(!i.snaps||i.metadata&&!i.metadata.permissive)return;const s=t.selection;if(!s&&!e)return;const o=i.snaps.lines[e||s.start.line];if(o&&!o.output){const e=new r.Position(o.body.range[2]-1,o.body.range[3]);M._addCode(t,e,"``")}}deleteSnapOutput(e){const t=b.activeTextEditor;if(!t)return;const i=t.document;if(!i)return;if(this._liveShareClientActive())return;const s=this._activeSession;if(!s)return;if(s.changeTs&&s.changeTs>s.updateTs)return;if(!s.snaps||s.metadata&&!s.metadata.permissive)return;const o=t.selection;if(!o&&!e)return;const n=s.snaps.lines[e||o.start.line];if(n&&n.output){const e=this._validateSnapOutputRange(i,n);if(e){const t=new r.WorkspaceEdit;t.delete(i.uri,e),r.workspace.applyEdit(t)}}}stopFileSnapsDiscovery(){const e=b.activeTextEditor;if(!e)return;const t=e.document;if(!t)return;"file"!==t.uri.scheme&&"untitled"!==t.uri.scheme||this._filesWithSnapsDiscoveryPaused.add(t.uri.toString());const i=this._backgroundSessions.find(e=>e.document===t);i&&(i.changes=[],i.paused=!0,this._updateStatusBarForBackgroundSession("paused"))}startFileSnapsDiscovery(){const e=b.activeTextEditor;if(!e)return;const t=e.document;t&&("file"!==t.uri.scheme&&"untitled"!==t.uri.scheme||(this._filesWithSnapsDiscoveryPaused.delete(t.uri.toString()),this._registerBackgroundSession(e,{resume:!0})))}_registerBackgroundSession(e,t){var i,s;if(!e)return;const o=e.document;if(o&&!this._liveShareClientActive())if(!A.has(o.languageId)||"file"!==o.uri.scheme&&"untitled"!==o.uri.scheme)"file"!==o.uri.scheme&&"untitled"!==o.uri.scheme&&r.window.tabGroups.all.flatMap(e=>e.tabs).length||this._resetStatusBar();else{if(this._activeSessions.find(e=>e.textDocument===o))return;if(!r.workspace.getConfiguration().get("quokka.snapsAutoDiscovery",!0))return void this._updateStatusBarForBackgroundSession("disabled");const n=o.uri.toString();if(this._filesWithSnapsDiscoveryPaused.has(n))return void this._updateStatusBarForBackgroundSession("paused");if(this._filesWithSnapsDiscoveryDisabled.has(n))return void this._updateStatusBarForBackgroundSession("disabled");if(!(null===t||void 0===t?void 0:t.resume)&&this._isDocumentNotEligibleForSnapDiscovery(o))return void this._updateStatusBarForBackgroundSession("paused");const a=this._backgroundSessions.find(e=>e.document===o);if(a)return void((null===t||void 0===t?void 0:t.resume)?(this._backgroundSessions=this._backgroundSessions.filter(e=>e!==a),a.disposable.dispose(),this._registerBackgroundSession(e)):a.hibernated?this._updateStatusBarForBackgroundSession("paused"):this._updateStatusBarForBackgroundSession(a.paused?"paused":"watching"));const l={disposable:new m,document:o,changes:[],hibernated:null===t||void 0===t?void 0:t.hibernated,fresh:!(null===(i=null===t||void 0===t?void 0:t.counters)||void 0===i?void 0:i.stops)||(null===t||void 0===t?void 0:t.resume),metadata:{sticky:null===t||void 0===t?void 0:t.sticky,permissive:!1,counters:{stops:(null===(s=null===t||void 0===t?void 0:t.counters)||void 0===s?void 0:s.stops)||0,misses:0}}};if(this._backgroundSessions.push(l),!(null===t||void 0===t?void 0:t.recovered)&&!l.hibernated&&(l.fresh=!0,this._upgradeBackgroundSession(l)))return;if(l.metadata.counters.stops<=3&&!l.hibernated){this._updateStatusBarForBackgroundSession("watching");const e=o.languageId;l.disposable.add(C.onDidChangeTextDocument(t=>{o===t.document&&(t.document.languageId!==e?(this._backgroundSessions=this._backgroundSessions.filter(e=>e!==l),l.disposable.dispose()):o.isClosed||l.paused||t.contentChanges.length>0&&(l.changes=l.changes.concat(t.contentChanges),this._upgradeBackgroundSession(l)))}))}else this._updateStatusBarForBackgroundSession("paused");l.disposable.add(C.onDidCloseTextDocument(e=>{o===e&&(this._backgroundSessions=this._backgroundSessions.filter(e=>e!==l),l.disposable.dispose(),this._resetStatusBar())}))}}_upgradeBackgroundSession(e){const t=e.document,i=e.changes,s=e.fresh;e.changes=[],e.fresh=!1;let o=!1;if(s){const i=t.getText();if(i.length>512e3||i.length>51200&&t.lineCount<100)return this._filesWithSnapsDiscoveryDisabled.add(t.uri.toString()),e.paused=!0,this._updateStatusBarForBackgroundSession("disabled"),!1;o=this._doesTextContainSnapMarkers(i)}else this._doChangesHaveSnapMarkersTraces(t,i)&&(o=this._doesTextContainSnapMarkers(t.getText()));if(o){const i=b.visibleTextEditors.find(e=>e.document===t);if(i)return e.metadata.permissive=!r.workspace.getConfiguration().get(s?"quokka.snapsAutoRunConfirmOnOpen":"quokka.snapsAutoRunConfirmOnEdit",!0),this._start(t,i,I.snapsOnly,void 0,!0),!0}return!1}_isDocumentNotEligibleForSnapDiscovery(e){const t=e.uri.toString();return!!(t.includes("node_modules")||t.includes(".cache")||t.includes(".next")||t.includes(".svelte-kit")||t.includes(".angular")||t.includes(".nuxt"))}_doChangesHaveSnapMarkersTraces(e,t){let i=0,s=0,o=!1;const n=[],a=new Set,l=e.lineCount;if(t.length>10)return!0;for(const r of t){const t=r.range.start.line,c=r.range.end.line,d=r.text;if(d.length>0){if(d.length>20)return!0;if(d.length>4&&(L.lastIndex=0,L.exec(d)))return!0;let e=!1;(d.startsWith("\n")||d.startsWith("\r"))&&(e=!0);for(let t=0;t<d.length&&(123===d.charCodeAt(t)&&(i++,e=!0),125===d.charCodeAt(t)&&(s++,e=!0),!(o=i>=2||s>=2));t++);if(o)break;e&&n.push(r)}else{let i=l>t?e.lineAt(t):void 0;if(i&&i.isEmptyOrWhitespace){o=!0;break}if(a.has(t)||a.add(t),t!==c&&l>c){if((i=e.lineAt(c))&&i.isEmptyOrWhitespace){o=!0;break}a.has(c)||a.add(c)}}}if(!o&&a.size>0)for(const t of a.values()){const i=l>t?e.lineAt(t):void 0;if(i){const e=i.text;if(e.indexOf("{{")>=0){o=!0;break}if(e.indexOf("}}")>=0){o=!0;break}}}if(!o&&n.length>0)for(const t of n){let i=t.range.start.line-3,s=t.range.end.line+3;i=i<0?0:i,s=s>e.lineCount?e.lineCount:s;const n=e.getText(new r.Range(new r.Position(i,0),new r.Position(s,0)));if(L.lastIndex=0,o=!!L.exec(n))break}return o}_doesTextContainSnapMarkers(e){return O.lastIndex=0,!!O.exec(e)&&(q.lastIndex=O.lastIndex+1,!!q.exec(e))}_validateSnapOutputRange(e,t){if(t&&t.output){const i=t.output;if(i&&i.range){const t=i.range[0]-1,s=i.range[1],o=i.range[2]-1,n=i.range[3],a=new r.Range(t,s,o,n),l="`",c=e.getText(new r.Range(t,s,t,s+1)),d=e.getText(new r.Range(o,n-1,o,n));if(c===l&&d===l){if(t===o&&n-s<2)return;return a}}}}_makeHoverIcon(e,t,i,s){return s=s||{},`<a href='${r.Uri.parse(`command:${e}?`+encodeURIComponent(JSON.stringify(s)))}' title='${t}'><span class='codicon codicon-${i}'></span></a>`}_makeStatusBarTooltip(e){this._statusBarTooltip||(this._statusBarTooltip={pro:{},community:{}});const t=this._pro?this._statusBarTooltip.pro:this._statusBarTooltip.community;if(t[e])return t[e];{let i="Quokka.js can't be started for the current file. Try to open a javascript or a typescript file.";switch(e){case"blocked":i="Quokka.js has found snaps in the current file. Press Spacebar twice inside <code>{{...}}</code> to activate snaps for the current file.";break;case"empty":i="Quokka.js is running but can't find any snaps. Add <code>{{ ⏎ }}</code> anywhere in your code to create a snap.";break;case"watching":i="Quokka.js snaps discovery is active. Add <code>{{ ⏎ }}</code> anywhere in your code to create a snap.";break;case"disabled":i="Quokka.js snaps discovery is disabled. Enable the <code>Snaps Auto Discovery</code> setting and restart VS Code to activate automatic snaps discovery.";break;case"paused":i="Quokka.js snaps discovery is paused for the current file. You may resume it by running the <code>Start Snaps Discovery in Current File</code> command.";break;case"running":i="Quokka.js is running for the current file."}const s=new r.MarkdownString(`<table width='100%'>\n  <tr>\n    <td width='50%'>\n      <h4>Quokka.js ${this._pro?'<span style="color:var(--vscode-editorLightBulb-foreground);">PRO</span>':"Community"}</h4>\n    </td>\n    <td width='50%' align='right'>\n      <a href='command:quokka.openStartView' title='Open Start View'><span class='codicon codicon-home'></span></a><span>&nbsp;&nbsp;</span><a href='https://quokkajs.com/docs' title='Open Docs'><span class='codicon codicon-book'></span></a><span>&nbsp;&nbsp;</span><a href='https://github.com/wallabyjs/quokka/issues' title='Report Bug or Request Feature'><span class='codicon codicon-feedback'></span></a>\n    </td>\n  </tr>\n</table>\n<table width='100%'>\n  <tr>\n    <td>\n      ${i}<br/>\n    </td>\n  </tr>\n</table>\n`);return s.supportHtml=!0,s.isTrusted=!0,t[e]=s,s}}static _outputResults(e,t,i){let s,o=e.lines();e.build(t);let n=e.lines();if(!(s=i||n.length!==o.length))for(let t=0,i=n.length;t<i;t++)if(e.areDifferent(n[t],o[t])){s=!0;break}s&&e.render()}showLogs(){return s(this,void 0,void 0,function*(){const e=this._projectRoot()||this._activeSession&&this._activeSession.localRoot;if(e){const t=o.join(a.homedir(),".quokka","logs",o.basename(e),"trace.log");try{const e=yield C.openTextDocument(t);yield b.showTextDocument(e,{preserveFocus:!0,viewColumn:r.ViewColumn.Beside})}catch(e){b.showErrorMessage("Error showing logs"+e.message)}}})}showQuokkaRemotePort(){if(!this._prevGenGuiEnabled){if(!this._activeSession||!this._activeSession.ui)return;b.showInformationMessage(`Quokka Remote Port: ${this._activeSession.remotePort}`)}}}t.exports=M},{"./InteractiveExamples":3,"./SalesEvent":4,"./checkOffers":5,"./compositeDisposable":6,"./outputBuilder":9,"./preferences":10,"./recentFilesExplorer":11,"./startViewPanel":12,"./traceExplorer":13,"./valueExplorer":14,"./webview":15,crypto:void 0,fs:void 0,http:void 0,os:void 0,path:void 0,querystring:void 0,"sql.js":void 0,uuid:void 0,vscode:void 0,vsls:void 0}],8:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.LicenseReader=void 0;const s=e("fs"),o=e("os"),n=e("path");class a{static getLicenseDetails(e){let t;try{t=s.statSync(a.startPage).mtimeMs}catch(e){t=(new Date).getTime()}const i={state:"demoLicense",productType:"",registeredTo:"",expiryDate:"",email:"",daysUntilExpiry:"",isBundle:!1,upgradeUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",purchaseUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",renewUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",previousVersionUrl:"https://quokkajs.com/docs/previous.html",newInstall:!1,installTime:t};try{JSON.parse(s.readFileSync(a.quokkaConfigPath).toString()).pro||(i.state="community")}catch(e){i.newInstall=!0,i.state="community"}if("community"===i.state)return i;try{const e=JSON.parse(Buffer.from(s.readFileSync(a.olp).toString(),"base64").toString());i.email=e.quokkaEmail||"",i.registeredTo=i.email,i.onlineLicense=!!e.quokkaEmail,i.state="activating"}catch(e){}try{const t=s.readFileSync(a.lkp).toString().split(":").reduce((e,t)=>t.trim());if(t.length<50){if(!i.onlineLicense)try{parseInt(t,10)+1314e6<+new Date&&(i.state="trialDemoOver")}catch(e){i.state="trialDemoOver"}}else{const s=Buffer.from(t,"base64").toString().split("\n"),[o,n,,,r,l]=s[1].split(",");i.registeredTo=s[0],i.email=i.email||o,i.isBundle=!!~n.indexOf("Wallaby.js");const c=!!~n.toLowerCase().indexOf("company")||!!~n.toLowerCase().indexOf("enterprise"),d="wallabyjs@gmail.com"===o||"1"===l;i.isBundle?i.productType="Wallaby.js + Quokka.js":i.productType="Quokka.js";const[u,h,p]=s[2].split("/").map(e=>parseInt(e,10));i.expiryDate=u+" "+a.monthNames[h-1]+", "+p;let _=!1;const g=new Date(Date.UTC(p,h-1,u)),m=new Date,v=Math.floor((g.getTime()-m.getTime())/864e5);i.daysUntilExpiry=`${v} day${1===v?"":"s"}`,v<0?d?i.state="trialDemoOver":(e.setHours(0,0,0,0),g.setHours(0,0,0,0),g<e?(i.previousVersionUrl="https://quokkajs.com/docs/previous.html?expirydate="+g.getUTCFullYear()+"-"+(g.getUTCMonth()+1)+"-"+g.getUTCDate(),i.state="expiredWrongVersion",i.key=t,_=!0):(i.state="expired",i.key=t,_=!0)):v<=14?d?i.state="trialLicense":(i.state="expiring",i.key=t,_=!0):d?i.state="trialLicense":(i.state="activated",i.key=t,_=!0),_&&!c&&(c?(i.purchaseUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka",r?(i.upgradeUrl=`https://wallabyjs.com/store/personal/?renewalOrder=${r}&upgrade=1&referrer=qsp`,i.renewUrl=`https://wallabyjs.com/store/personal/?renewalOrder=${r}&referrer=qsp`):(i.upgradeUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka",i.renewUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka")):(i.upgradeUrl=`https://wallabyjs.com/store/personal/?renewalEmail=${encodeURIComponent(o)}&upgrade=1&referrer=qsp`,i.renewUrl=`https://wallabyjs.com/store/personal/?renewalEmail=${encodeURIComponent(o)}&referrer=qsp`))}}catch(e){}return i}}i.LicenseReader=a,a.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],a.quokkaFolder=n.join(o.homedir(),".quokka"),a.wallabyFolder=n.join(o.homedir(),".wallaby"),a.lkp=n.join(a.quokkaFolder,".qlc"),a.quokkaConfigPath=n.join(a.quokkaFolder,"config.json"),a.olp=n.join(a.wallabyFolder,".ol"),a.startPage=n.join(a.quokkaFolder,"startPage.json")},{fs:void 0,os:void 0,path:void 0}],9:[function(e,t,i){"use strict";const s=e("vscode"),o=global._,n={none:"",link:Array(2).join("​"),empty:Array(6).join("​"),error:{start:"",end:" "},context:Array(4).join("​"),header:Array(5).join("​"),string:{start:"",end:" "},diff:Array(7).join("​"),diffIns:Array(2).join("⁠"),diffDel:Array(2).join("‍"),tmpDiffIns:{start:"wsDiffIns",end:"weDiffIns"},tmpDiffDel:{start:"wsDiffDel",end:"weDiffDel"}};t.exports=class{constructor(e,t,i,n,a,r,l,c,d,u,h,p,_,g,m,v,f,k){const S=this;this._prefix=t,this._lines=[],this._codeLens=[],this._links=[],this._quokkaFileName=i,this._displayedFileName=u,this._contentLimit=1048576,this._channel=e,this._absolutePathResolver=n,this._dmp=a,this._hasOpenedProject=c,this.render=o.debounce(o.bind(this.render,this),300),this._header="Quokka",this.isLiveShareClient=d,this.disposed=!1,this.channelEnabled=!0,this._messageSeparator=h?"":"\n",this._isProVersion=m,this._isCodeStoryEnabled=f,this._isProfilingEnabled=k,this._hasAnyEnabledBreakpointsInActiveEditor=g,this._isTraceBeingNavigated=p,this._isTraceBeingAutoPlayed=_,this._getShowCodeLensInOutputChannelSetting=v,this._onDidChangeCodeLenses=new s.EventEmitter,this._replaceApiAvailable=!0,this.useMarkup(),r.add(s.languages.registerDocumentLinkProvider(l,{provideDocumentLinks:e=>{if(!S.channelEnabled||S.disposed)return[];const t=e.lineAt(0);return t&&t.text&&~t.text.indexOf(this._header)?this._links:[]}}));let w=s.languages.registerCodeLensProvider(["quokka-output"],{onDidChangeCodeLenses:this._onDidChangeCodeLenses.event,provideCodeLenses:e=>(w&&S.disposed&&(w.dispose(),w=null),!S.channelEnabled||S.disposed?[]:S._activeCodeLens||[])})}enableChannel(){this.channelEnabled=!0,this._refreshCodeLens()}disableChannel(){this.channelEnabled=!1,this._refreshCodeLens(!0)}useMarkup(){this._markupTokens=o.extend({},n)}disableMarkup(){this._markupTokens.none=this._markupTokens.link=this._markupTokens.empty=this._markupTokens.error=this._markupTokens.context=this._markupTokens.header=this._markupTokens.string=this._markupTokens.diff=""}dispose(){this.clear(),this.disposed=!0}build(e){if(this._lines=[],this._links=[],this._codeLens=[],delete this._callStackDisplayed,this._appendLine("none",0,this._header),o.isString(e))this._appendLine("error",0,e);else if(o.isObject(e)){if(this._isTraceBeingNavigated()&&e.trace){const t=Math.floor((e.trace.currentFrame+1)/e.trace.length*100);if(this._traceNavigationProgress!==t&&(this._traceNavigationProgress=t,this._refreshCodeLens()),e.trace.callStack){const t=e.trace.callStack[e.trace.currentFrame];t&&t.stack&&(this._outputCallStack(t.stack),this._callStackDisplayed=!0)}}o.each(e.errors,e=>this._outputError(e)),o.each(e.messages,e=>this._outputMessage(e))}}_headerCodeLens(){const e=[];return this._isTraceBeingNavigated()?(e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:`Execution progress: ${o.pad(this._traceNavigationProgress,3,"ㅤ")}%ㅤ`,tooltip:"Reveal Active Frame",command:"quokka.revealTraceStep"})),this._isTraceBeingAutoPlayed()?e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-pause) Pause Code Execution",tooltip:"Pause Code Execution",command:"quokka.pauseCodeExecution"})):(e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-reverse-continue)ㅤ",tooltip:"Run Back to Active Line",command:"quokka.playTraceBackwardToSelection"})),this._hasAnyEnabledBreakpointsInActiveEditor()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(circle-filled)ㅤ",tooltip:"Run Back to Breakpoint",command:"quokka.playTraceBackwardToBreakpoint"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-out)ㅤ",tooltip:"Step Back Out",command:"quokka.playTracePrevStepOut"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-into)ㅤ",tooltip:"Step Back Into",command:"quokka.playTracePrevStep"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-back)ㅤ",tooltip:"Step Back Over",command:"quokka.playTracePrevStepOver"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-restart)ㅤ",tooltip:"Restart Time Machine From The First Executed Line",command:"quokka.debug",arguments:[{fromTheStart:!0}]})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-stop)ㅤ",tooltip:"Stop Time Machine",command:"quokka.stopTraceNavigation"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-alt)ㅤ",tooltip:"Auto Play Code",command:"quokka.autoPlayCode"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-over)ㅤ",tooltip:"Step Over",command:"quokka.playTraceNextStepOver"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-into)ㅤ",tooltip:"Step Into",command:"quokka.playTraceNextStep"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-out)ㅤ",tooltip:"Step Out",command:"quokka.playTraceNextStepOut"})),this._hasAnyEnabledBreakpointsInActiveEditor()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(circle-filled)ㅤ",tooltip:"Run to Breakpoint",command:"quokka.playTraceForwardToBreakpoint"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-continue)ㅤ",tooltip:"Run to Active Line",command:"quokka.playTraceForwardToSelection"})),this._callStackDisplayed||e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(list-selection)ㅤ",tooltip:"View Current Call Stack",command:"quokka.viewCallStack"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(organization)ㅤ",tooltip:"Share Current Quokka on codeclip.io",command:"quokka.share"})),this._isProVersion()&&this._isCodeStoryEnabled()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-line-by-line) View Code Story",tooltip:"View Code Story",command:"quokka.viewCodeStory"})))):(this._quokkaFileName.endsWith(".svelte")||this._quokkaFileName.endsWith(".vue")||(e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"$(debug-alt)ㅤ",tooltip:"Start Time Machine With Auto Play",command:"quokka.debugAutoPlay"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug)ㅤ",tooltip:"Start Time Machine",command:"quokka.debug"})),this._isProVersion()&&this._isCodeStoryEnabled()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-line-by-line)ㅤ",tooltip:"View Code Story",command:"quokka.viewCodeStory"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(organization)ㅤ",tooltip:"Share Current Quokka on codeclip.io",command:"quokka.share"}))),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(files)ㅤ",tooltip:"View Recent Quokka Files",command:"quokka.viewRecentFiles"})),this._isProVersion()&&(this._isProfilingEnabled()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(watch)ㅤ",tooltip:"View CPU Profile",command:"quokka.profile"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(settings)ㅤ",tooltip:"Edit Current Quokka Session Settings",command:"quokka.editSessionSettings"}))),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(stop-circle)ㅤ",tooltip:"Stop",command:"quokka.stopCurrent"}))),e}lines(){return this._lines}render(){this._doRender()}refreshHeaderCommands(){this._refreshCodeLens()}_doRender(e){if(this.disposed||!this.channelEnabled)return;let t="";(e=e||0)||(t+=this._prefix);for(let i=e,s=this._lines.length;i<s;i++)if((t+=this._lines[i]+"\n").length>this._contentLimit){t+="\n--- output truncated to "+this._contentLimit+" bytes ---\n";break}if(e)this._channel.append(t.replace(/\u0000/g,""));else if(this._channel.replace&&this._replaceApiAvailable)try{this._channel.replace(t.replace(/\u0000/g,""))}catch(e){this._channel.clear(),this._channel.append(t.replace(/\u0000/g,"")),this._replaceApiAvailable=!1}else this._channel.clear(),this._channel.append(t.replace(/\u0000/g,""));this._refreshCodeLens()}_refreshCodeLens(e){this.isLiveShareClient||(this._activeCodeLens=[],!e&&this._lines.length&&this._getShowCodeLensInOutputChannelSetting()&&(this._activeCodeLens=this._headerCodeLens().concat(this._codeLens.slice())),this._onDidChangeCodeLenses.fire())}clear(){this._lines=[],this._links=[],this._codeLens=[],this._activeCodeLens=[],this._onDidChangeCodeLenses.fire()}clearAndRenderHeader(){this.clear(),this._appendLine("none",0,this._header),this._doRender()}appendConsoleMessage(e){const t=this._lines.length;this._outputMessage(e),this._doRender(t)}show(){this.disposed||this._channel.show(!0)}areDifferent(e,t){return e!==t}setHeaderData(e){if(this.disposed)return;let t=e.plugins||[];e.builtInPlugins&&t.push(...e.builtInPlugins),t.sort((e,t)=>e.localeCompare(t));try{this._header=this._markupStartToken("header")+"Quokka"+(this._isProVersion()?" PRO":"")+(e.snapsOnlyMode?" {⚡}":"")+" '"+this._displayedFileName+"'"+` (node: ${e.nodeVersion}${e.ts?`, TypeScript: ${e.ts.version&&"v"+e.ts.version||"unknown version"}`:""}${e.babel?`, babel: ${e.babel.version&&"v"+e.babel.version||"unknown version"}`:""}${t.length?`, plugins: ${t.join(", ")}`:""})${this._markupStartToken("header")}`}catch(e){console.log(e)}}_markupStartToken(e){const t=this._markupTokens[e];return o.isObject(t)?t.start:t}_markupEndToken(e){const t=this._markupTokens[e];return o.isObject(t)?t.end:t}_markupAltEndToken(e){const t=this._markupTokens[e];return o.isObject(t)?t.altEnd||t.end:t}_outputMessage(e){if("diff"===e.type){if(!e.context&&!e.actual&&!e.expected)return;e.text=e.context,delete e.context}e.context&&e.context.replace&&(e.context=e.context.replace(/\r\n\s*/g," ").replace(/\n\s*/g," "));const t=e.text&&(e.text.length>20||~e.text.indexOf("\n"))&&"diff"!==e.type;let i="error"===e.type?"error":"warn"===e.type||"diff"===e.type?"context":"none";if(t)this._addRevealInValueExplorerLens(this._lines.length+1,e),this._appendLine("none"===i&&e.format?"string":i,0,this._messageSeparator+e.text),this._outputLink(e,1);else{"diff"===e.type&&this._outputDiff(0,e.expected,e.actual),e.format&&(i="string");let t="string"==typeof e.text?`${"diff"===e.type?o.pad("",2,"   "):this._messageSeparator}${this._markupStartToken(i)}${e.text||"[empty string]"}${this._markupAltEndToken(i)}`:"";if(e.file){"string"!==i&&(t+=" ");const s=this._markupStartToken("link")+e.file+this._displayLocation(e.loc)+this._markupEndToken("link");t+=this._buildStackEntryLineText(e.context)+s,this._addFileLink(e.file,e.loc,s,t.length-s.length,this._lines.length+(t.split(/\r\n|\r|\n/).length-1)),this._addRevealInValueExplorerLens(this._lines.length+1,e)}this._appendLine("none",0,t)}}_addRevealInValueExplorerLens(e,t){this._codeLens.push(new s.CodeLens(new s.Range(e,0,e,1),{title:"$(list-tree) Reveal in value explorer",tooltip:"Reveal in value explorer",command:"quokka.revealInValueExplorer",arguments:[t]}))}_outputCallStack(e){this._appendLine("none",0,""),this._codeLens.push(new s.CodeLens(new s.Range(this._lines.length,0,this._lines.length,1),{title:"$(eye-closed) Hide Call Stack",tooltip:"Hide Call Stack",command:"quokka.hideCallStack"}));for(let t of e){const e=this._buildStackEntryLineText(t.context),i=e+this._markupStartToken("link")+t.file+this._displayLocation(t.loc)+this._markupEndToken("link");this._appendLine("none",0,i);let o=this._lines.length-1;this._links.push({range:new s.Range(o,e.length,o,i.length),target:s.Uri.parse("command:quokka.openCallStackFrame?"+encodeURIComponent(JSON.stringify(t)))})}}_outputError({message:e,stack:t,expected:i,actual:s,missingPackage:n,missingBrowserGlobal:a}){let r=this;this._outputDiff(0,i,s),n&&!this.isLiveShareClient&&(this._addEmptyLine(),this._addCustomLinkLine(`Install "${n}" package for the current quokka file`,"command:quokka.installMissingPackageToQuokka",0),this._hasOpenedProject&&this._addCustomLinkLine(`Install "${n}" package into the project`,"command:quokka.installMissingPackageToProject",0)),a&&!this.isLiveShareClient&&(this._addEmptyLine(),this._appendLine("context",0,`"${a}" looks like a browser global`),this._addCustomLinkLine("Install and use quokka browser plugin",`command:quokka.installQuokkaPlugin?${encodeURIComponent(JSON.stringify(["jsdom","jsdom-quokka-plugin"]))}`,0),this._addCustomLinkLine("Open quokka browser plugin documentation","https://quokkajs.com/docs/configuration.html#jsdom",0)),this._appendLine("error",0,this._messageSeparator+e),o.each(t,e=>r._outputLink(e,1))}_outputDiff(e,t,i){if(this._dmp&&(t||i)){this._appendLine("none",0,"");let s=this._dmp.diff_prettyHtml(this._dmp.diff_wordMode(t||"",i||"")).replace(/&para;<br>/g,"\n").replace(/<br>/g,"\n").replace(/<\/?span[^>]*>/g,"").replace(/<ins[^>]*>/g,this._markupStartToken("tmpDiffIns")).replace(/<del[^>]*>/g,this._markupStartToken("tmpDiffDel")).replace(/<\/ins[^>]*>/g,this._markupEndToken("tmpDiffIns")).replace(/<\/del[^>]*>/g,this._markupEndToken("tmpDiffDel")).replace(/style="background:#e6ffe6;"/g,"").replace(/style="background:#ffe6e6;"/g,"").replace(/&lt;/g,"<").replace(/&amp;/g,"&").replace(/&gt;/g,">"),o=0,n=0;this._appendLine("diff",e,s,void 0,void 0,e=>{if(!e)return e;o>0&&(e=this._markupStartToken("diffIns")+e),n>0&&(e=this._markupStartToken("diffDel")+e);let t=(e.match(new RegExp(this._markupStartToken("tmpDiffIns"),"g"))||[]).length,i=(e.match(new RegExp(this._markupEndToken("tmpDiffIns"),"g"))||[]).length;o+=t-i;let s=(e.match(new RegExp(this._markupStartToken("tmpDiffDel"),"g"))||[]).length,a=(e.match(new RegExp(this._markupEndToken("tmpDiffDel"),"g"))||[]).length;return n+=s-a,o>0&&(e+=this._markupEndToken("diffIns")),n>0&&(e+=this._markupEndToken("diffDel")),e.replace(new RegExp(this._markupStartToken("tmpDiffIns"),"g"),this._markupStartToken("diffIns")).replace(new RegExp(this._markupEndToken("tmpDiffIns"),"g"),this._markupEndToken("diffIns")).replace(new RegExp(this._markupStartToken("tmpDiffDel"),"g"),this._markupStartToken("diffDel")).replace(new RegExp(this._markupEndToken("tmpDiffDel"),"g"),this._markupEndToken("diffDel"))})}}_outputLink(e,t){if(e.file){const i=e.file+this._displayLocation(e.loc);this._appendLine("link",t,i,void 0,e.context,(t,s)=>{this._addFileLink(e.file,e.loc,i,s)})}}_addCustomLinkLine(e,t,i){let o=this._lines.length;this._appendLine("none",i,this._markupStartToken("link")+e+this._markupEndToken("link")),this._links.push({range:new s.Range(o,this._markupStartToken("link").length,o,e.length+this._markupEndToken("link").length),target:s.Uri.parse(t)})}_addFileLink(e,t,i,o,n){"."!==e[0]&&e!==this._quokkaFileName||(n=n||this._lines.length,this._links.push({range:new s.Range(n,o,n,o+i.length),target:0===e.indexOf("quokka")?s.Uri.parse("command:quokka.goToLineInQuokkaFile?"+JSON.stringify(this._location(t).substring(1))):s.Uri.parse(s.Uri.file(this._absolutePathResolver(e)).toString()+this._location(t,0))}))}_location(e){let[t,i]=this._locationArray(e);return"#"+(o.isNumber(i)?`${t},${i}`:t)}_locationArray(e){let t,i;return o.isNumber(e)?t=e:o.isArray(e)?(t=e[0],i=e[1]):o.isString(e)&&(t=(e=e.split(":"))[0]&&parseInt(e[0],10),i=e[1]&&parseInt(e[1],10)),o.isNumber(i)&&i<0&&(i=0),[t,i]}_displayLocation(e){if(!e)return"";let[t,i]=this._locationArray(e);return`:${t}${o.isNumber(i)?":"+(i+1):""}`}_addEmptyLine(){this._appendLine("none",0,"")}_appendLine(e,t,i,s,n,a){let r=this,l=i.split("\n"),c=[this._markupStartToken(e)||"",this._markupEndToken(e)||""];o.each(l,(i,d)=>{const u=(s?`[${s}] `:"")+o.pad("",2*t,"   ")+("link"===e?this._buildStackEntryLineText(n):"")+("diff"===e?0===d?c[0]:"":c[0]);let h=u+i+("diff"===e?"":c[1]);if(a){let e=a(h,u.length);e&&(h=e)}"diff"===e&&(h+=d===l.length-1?c[1]:""),r._lines.push(h)})}_buildStackEntryLineText(e){return this._markupStartToken("empty")+"at "+this._markupEndToken("empty")+(e?this._markupStartToken("context")+e+this._markupEndToken("context")+" ":"")}}},{vscode:void 0}],10:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.setTheme=function(e){l=e},i.loadTheme=function(e){e||(e=l);if(!e)return;try{let t;for(const i of r.extensions.all){const s=i.packageJSON.contributes&&i.packageJSON.contributes.themes,n=s&&s.find(t=>t.id===e||t.label===e);if(n){t=(0,o.join)(i.extensionPath,n.path);break}}const i=[],l=new Map;if(t){i.push(t);let e=t;for(;e;){const t=n.parse((0,s.readFileSync)(e).toString());l.set(e,t),t&&(t.include?(e=(0,o.join)((0,o.dirname)(e),t.include),i.push(e)):e=void 0)}}i.reverse();const d=new Map,u=new Map,h=e=>{if(e)for(const t in e)d.set(t,e[t])},p=(e,t)=>{if(t)if(u.has(e)){const i=u.get(e);t.background&&(i.background=t.background),t.foreground&&(i.foreground=t.foreground),t.fontStyle&&(i.style=t.fontStyle)}else u.set(e,{foreground:t.foreground,background:t.background,style:t.fontStyle})},_=e=>{null===e||void 0===e||e.forEach(e=>{var t;if(e.scope)if("string"==typeof e.scope){const t=",";e.scope.includes(t)?e.scope.split(t).map(e=>e.trim()).filter(e=>""!==e).forEach(t=>{p(t,e.settings)}):p(e.scope,e.settings)}else null===(t=e.scope)||void 0===t||t.forEach(t=>{p(t,e.settings)});else p("",e.settings)})},g=e=>{switch(e){case"variables":return["variable"];case"functions":return["entity.name.function"];case"keywords":return["storage.type"];case"strings":return["string"];case"comments":return["comment"];case"types":return["support.type"];case"numbers":return["constant.numeric"];default:return["constant"]}};for(const e of i){const t=l.get(e);if(t.tokenColors){if("string"==typeof t.tokenColors){const i=(0,s.readFileSync)((0,o.resolve)((0,o.dirname)(e),t.tokenColors)).toString();t.tokenColors=a.parse(i).settings}_(t.tokenColors)}t.colors&&h(t.colors)}const m=r.workspace.getConfiguration().get("workbench.colorCustomizations");m&&h(m);const v=r.workspace.getConfiguration().get("editor.tokenColorCustomizations");for(let e in v)if(!e.startsWith("[")&&"textMateRules"!==e){const t=v[e];"string"==typeof t?g(e).forEach(e=>p(e,{foreground:t})):g(e).forEach(e=>p(e,t))}const f=v.textMateRules;f&&_(f);for(let t in v)if(t===`[${e}]`){const e=v[t];for(let t in e)if("textMateRules"!==t){const i=e[t];"string"==typeof i?g(t).forEach(e=>p(e,{foreground:i})):g(t).forEach(e=>p(e,i))}e.textMateRules&&_(e.textMateRules)}return{ui:Object.fromEntries(d),code:Object.fromEntries(u),name:e,type:c(r.window.activeColorTheme.kind)}}catch(t){return console.error(t),{name:e,type:c(r.window.activeColorTheme.kind)}}},i.loadConfiguration=function(e){return{"custom.kind":e===r.ExtensionKind.UI?"local":"remote","editor.fontSize":r.workspace.getConfiguration().get("editor.fontSize"),"editor.fontFamily":r.workspace.getConfiguration().get("editor.fontFamily"),"editor.fontWeight":r.workspace.getConfiguration().get("editor.fontWeight"),"editor.fontLigatures":r.workspace.getConfiguration().get("editor.fontLigatures"),"editor.cursorStyle":r.workspace.getConfiguration().get("editor.cursorStyle"),"editor.cursorBlinking":r.workspace.getConfiguration().get("editor.cursorBlinking"),"editor.cursorSmoothCaretAnimation":r.workspace.getConfiguration().get("editor.cursorSmoothCaretAnimation"),"editor.scrollbar.horizontalScrollbarSize":r.workspace.getConfiguration().get("editor.scrollbar.horizontalScrollbarSize"),"editor.scrollbar.verticalScrollbarSize":r.workspace.getConfiguration().get("editor.scrollbar.verticalScrollbarSize"),"workbench.sash.size":r.workspace.getConfiguration().get("workbench.sash.size"),"wallaby.fontSize":r.workspace.getConfiguration().get("quokka.fontSize","13")}};const s=e("fs"),o=e("path"),n=e("jsonc-parser"),a=e("plist"),r=e("vscode");let l=r.workspace.getConfiguration("workbench").get("colorTheme");function c(e){switch(e){case r.ColorThemeKind.Light:return"light";case r.ColorThemeKind.Dark:return"dark";case r.ColorThemeKind.HighContrast:return"hc-dark";case r.ColorThemeKind.HighContrastLight:return"hc-light";default:return"dark"}}},{fs:void 0,"jsonc-parser":void 0,path:void 0,plist:void 0,vscode:void 0}],11:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,n){function a(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,r)}l((s=s.apply(e,t||[])).next())})};const o=e("vscode"),n=e("path"),a=e("util"),r=e("fs"),l=e("os"),c=a.promisify(r.readFile),d=a.promisify(r.writeFile),u=e=>c(e).then(e=>e.toString()),h=e=>u(e).catch(()=>""),p=e("./compositeDisposable").default,_="quokka-recent",g=o.Uri.parse("quokka-recent:Recent Quokka Files");class m{constructor(e){this._disposables=new p,this._onDidChange=new o.EventEmitter,this._quokkaFolder=e,this._quokkaRecentFilesMetadataPath=n.join(e,"recentFiles.json"),this._quokkaRecentFilesFolderPath=n.join(e,"recentFiles"),this._disposables.add(o.languages.registerCodeLensProvider([_],this)),this._disposables.add(o.workspace.registerTextDocumentContentProvider(_,this)),this.reset()}findRecentScratchFileIdByContent(e){return s(this,void 0,void 0,function*(){if(!e)return;e=e.trim();const t=yield this._getMetadata();if(!t||!t.projects)return;const i=Object.keys(t.projects);let s=0;for(;i.length;){const o=t.projects[i.pop()];if(o){const t=Object.values(o);for(let i of t)if(i.scratchFile){if((i.content&&i.content.trim())===e)return i.fileId;if(++s>=5)return}}}})}reset(){delete this._metadata}dispose(){this._disposed||(this._disposables.dispose(),this._disposed=!0)}show(e){return s(this,void 0,void 0,function*(){if(this.reset(),this._content=yield this._buildContent(e||this._quokkaFolder),!this._content)return;this._onDidChange.fire(g);const t=yield o.window.showTextDocument(g);t.options.lineNumbers=o.TextEditorLineNumbersStyle.Off,o.languages.setTextDocumentLanguage(t.document,_)})}get onDidChange(){return this._onDidChange.event}static prepareContentText(e){return e.replace(/ /g," ")}static formatProjectDir(e){let t=l.homedir();return t.endsWith(n.sep)||(t+=n.sep),e.replace(t,"~")}static pathToMetadataKey(e){return e&&"win32"===process.platform?e.toLowerCase():e}removeRecentFiles(e){return s(this,void 0,void 0,function*(){let t;try{t=JSON.parse(yield u(this._quokkaRecentFilesMetadataPath))}catch(e){}if(!t||!t.projects)return;const i=Object.keys(t.projects);for(;i.length;){const s=i.pop(),o=t.projects[s];if(o)for(let t of e)m.pathToMetadataKey(t.projectRoot)===s&&delete o[t.id]}try{yield d(this._quokkaRecentFilesMetadataPath,JSON.stringify(t))}catch(e){}})}_buildContent(e){return s(this,void 0,void 0,function*(){const t=yield this._getMetadata();if(!t||!t.projects)return;this._lenses=[];const i=m.pathToMetadataKey(e);let s=[];const a=e=>{const t=`${e.modificationDate.toLocaleDateString()} ${e.modificationDate.toLocaleTimeString()}`;let n,a;i===e.projectRootKey||m.pathToMetadataKey(this._quokkaFolder)===e.projectRootKey?n=e.path:(n=e.resolvedPath,a=!0),s.push({text:`⁠${m.formatProjectDir(n)}⁠  ${t} `});const r=(()=>s.length-1)();if(this._lenses.push(new o.CodeLens(new o.Range(r,0,r,0),{title:"Run",tooltip:"Run",command:"quokka.runRecentFile",arguments:[e]})),e.scratchFile&&this._lenses.push(new o.CodeLens(new o.Range(r,0,r,0),{title:"Clone and Run",tooltip:"Clone and Run",command:"quokka.runRecentFile",arguments:[Object.assign({clone:!0},e)]})),a){const t=m.formatProjectDir(e.projectRoot);this._lenses.push(new o.CodeLens(new o.Range(r,0,r,0),{title:"Run in "+t,tooltip:"Run in "+t,command:"quokka.runRecentFile",arguments:[Object.assign({runInParentProject:!0},e)]})),e.scratchFile&&this._lenses.push(new o.CodeLens(new o.Range(r,0,r,0),{title:"Clone and Run in "+t,tooltip:"Clone and Run in "+t,command:"quokka.runRecentFile",arguments:[Object.assign({clone:!0,runInParentProject:!0},e)]}))}this._lenses.push(new o.CodeLens(new o.Range(r,0,r,0),{title:"Remove from recent files",tooltip:"Remove from recent files",command:"quokka.removeRecentFiles",arguments:[{files:[e],reloadRecentFilesView:!0}]})),s.push({text:"​"})},r=t.projects[i];r&&(delete t.projects[i],t.projects[i]=r);const l=Object.keys(t.projects),c=[];for(;l.length;){const e=l.pop(),i=t.projects[e];if(i){const t=Object.values(i).reverse();for(let i of t){i.scratchFile&&(i.path=i.path.replace("quokka","scratch")),i.projectRootKey=e,i.resolvedPath=n.resolve(i.projectRoot,i.path),i.id=i.fileId||m.pathToMetadataKey(i.path);const t=i.content||(yield h(i.scratchFile?n.join(this._quokkaRecentFilesFolderPath,i.fileId):i.resolvedPath));if(!t){c.push(i);continue}i.content=t.trim(),i.modificationDate=new Date(i.ts),a(i);const o=i.content.split(/\r\n|\r|\n/).map(e=>({text:`  ${e}`}));(s=s.concat(o)).push({text:"​"})}}}return c.length&&o.commands.executeCommand("quokka.removeRecentFiles",{files:c}),{lines:s,text:s.map(e=>e.text).join("\n"),annotationDecorations:[]}})}provideTextDocumentContent(){return this._content&&this._content.text||""}provideCodeLenses(e){return this._lenses||[]}_getMetadata(){return s(this,void 0,void 0,function*(){if(this._metadata)return this._metadata;try{this._metadata=JSON.parse(yield u(this._quokkaRecentFilesMetadataPath))}catch(e){this._metadata={projects:{}}}return this._metadata})}}t.exports=m},{"./compositeDisposable":6,fs:void 0,os:void 0,path:void 0,util:void 0,vscode:void 0}],12:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,n){function a(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,r)}l((s=s.apply(e,t||[])).next())})};const o=e("vscode"),n=e("util"),a=e("path"),r=e("fs"),l=e("os"),c=e("./licenseReader").LicenseReader;class d{static setController(e){d.controller=e}static getStartViewWhatsNewVersion(e){return s(this,void 0,void 0,function*(){const t=o.Uri.joinPath(e.extensionUri,"media","index.html"),i=[...new n.TextDecoder("utf8").decode(yield o.workspace.fs.readFile(t)).matchAll(/data-whats-new-version=["|']([a-zA-Z0-9\-\!\,]+)["|']/gm)],s=e.globalState.get("quokka.country","US");return Math.max(...i.map(e=>{const[,t]=e,[i,o]=t.split("-");return{version:parseInt(i,10),country:o||s}}).filter(e=>e.country===s).map(e=>e.version))})}static showWhatsNewIfRequired(e){return s(this,void 0,void 0,function*(){if(o.env.remoteName)return!1;if(!o.workspace.getConfiguration().get("quokka.showStartViewOnFeatureRelease",!0))return!1;try{const t=yield d.getStartViewWhatsNewVersion(e);if(t>d._getUserWhatsNewVersion())return d._saveUserWhatsNewVersion(t)&&d.createOrShow(e,{type:"whatsnew"}),!0}catch(e){console.log(e)}return!1})}static createOrShow(e,t){const i=o.window.activeTextEditor?o.window.activeTextEditor.viewColumn:void 0;if(d.currentPanel)return d.currentPanel._panel.reveal(i),void d.currentPanel._processAction(e,t);const s=o.window.createWebviewPanel(d.viewType,"Quokka",i||o.ViewColumn.One,{enableScripts:!0,localResourceRoots:[o.Uri.joinPath(e.extensionUri)]});d.currentPanel=new d(s,e),d.currentPanel._processAction(e,t)}_processAction(e,t){return s(this,void 0,void 0,function*(){if(t)switch(t.type){case"activate":d.currentPanel.activateLicense(t);break;case"trial":d.currentPanel.requestTrial(t);break;case"goToLicenseSection":d.currentPanel.goToLicenseSection(t);break;case"showAllWhatsNew":d.currentPanel.showWhatsNew(!0),d.currentPanel._panel.title="Quokka: What's New";break;case"whatsnew":d.currentPanel.showWhatsNew(!1),d.currentPanel._panel.title="Quokka: What's New";break;case"firstInstall":const i=yield d.getStartViewWhatsNewVersion(e);d.controller&&d.controller._salesEvent&&d.controller._salesEvent.setLastUrlOpenedTime(),d._saveUserWhatsNewVersion(i),d.currentPanel.firstInstall(t)}})}static revive(e,t){d.currentPanel&&d.currentPanel.dispose(),d.currentPanel=new d(e,t)}constructor(e,t){this._disposables=[],this._checkOffersResults=void 0,this._panel=e,this._context=t,this._extensionUri=t.extensionUri,this._pendingMessages=[],this._initialized=!1,this._panel.iconPath=o.Uri.file(t.asAbsolutePath("media/logo.svg")),this._load()}activateLicense(){this._pendingMessages.push({command:"activateLicense"}),this.processPendingMessages()}firstInstall(e){this._pendingMessages.push(Object.assign({command:"firstInstall"},e)),this.processPendingMessages()}goToLicenseSection(){this._pendingMessages.push({command:"goToLicenseSection"}),this.processPendingMessages()}requestTrial(){this._pendingMessages.push({command:"requestTrial"}),this.processPendingMessages()}showWhatsNew(e){const t=e?0:d._getUserWhatsNewVersion();this._pendingMessages.push({command:"showWhatsNew",previousWhatsNewVersion:t}),this.processPendingMessages()}processPendingMessages(){if(this._initialized){const e=this._pendingMessages;this._pendingMessages=[],e.forEach(e=>{this._panel.webview.postMessage(e)})}}_getGlobalConfigSettings(){try{return Object.assign(Object.assign({},d.globalDefaults),JSON.parse(r.readFileSync(d.quokkaConfigPath)))}catch(e){return Object.assign({},d.globalDefaults)}}_saveGlobalConfigSettings(e){e=Object.assign({},e),Object.keys(d.globalDefaults).forEach(t=>{e[t]===d.globalDefaults[t]&&delete e[t]}),r.writeFileSync(d.quokkaConfigPath,JSON.stringify(e)),this._panel.webview.postMessage({command:"globalConfig",globalConfig:this._getGlobalConfigSettings()})}_load(){this._update().then(()=>{this._panel.onDidDispose(()=>this.dispose(),null,this._disposables),this._panel.onDidChangeViewState(()=>{this._panel.visible?this._update():this._initialized=!1},null,this._disposables);const e=e=>{const t=o.workspace.getConfiguration().inspect(e);return void 0!==t.globalValue?t.globalValue:t.defaultValue};this._panel.webview.onDidReceiveMessage(t=>{switch(t.command){case"requestInitialState":const i=e("quokka.compactMessageOutput"),s=e("quokka.showOutputOnStart"),n=e("quokka.startViewStatusBar"),a=e("quokka.suppressExpirationNotifications"),l=e("quokka.showStartViewOnFeatureRelease"),c=e("quokka.automaticRestart"),u=e("quokka.automaticStartRegex"),h=this._context.globalState.get("quokka.country","US"),p=d.controller&&d.controller._buildDate||new Date;return p.setHours(0,0,0),this._panel.webview.postMessage({command:"initialState",settings:{compactMessageOutput:i,showOutputOnStart:s,startViewStatusBar:n,suppressExpirationNotifications:a,showStartViewOnFeatureRelease:l,automaticRestart:c,automaticStartRegex:u},globalConfig:this._getGlobalConfigSettings(),licenseDetails:d.getLicenseDetails(),whatsNewVersion:d._getUserWhatsNewVersion(),buildDate:p,country:h}),this._initialized=!0,void this.processPendingMessages();case"saveGlobalConfig":this._saveGlobalConfigSettings(t.globalConfig);break;case"updateSetting":o.workspace.getConfiguration().update("quokka."+t.setting,t.value,o.ConfigurationTarget.Global);break;case"otherSettings":o.commands.executeCommand("workbench.action.openSettings","quokka");break;case"configJson":r.existsSync(d.quokkaConfigPath)||r.writeFileSync(d.quokkaConfigPath,JSON.stringify({})),o.workspace.openTextDocument(d.quokkaConfigPath).then(e=>o.window.showTextDocument(e));break;case"useCommunityEdition":this._useCommunityEdition();break;case"switchToPro":this._usePro();break;case"launchDemo":this._launchDemo();case"trialRequest":this._requestTrialLicense(t.email);break;case"activateLicense":this._activateLicense(t);break;case"updateWhatsNewVersion":d._saveUserWhatsNewVersion(d.getStartViewWhatsNewVersion(this._context));break;case"log":console.log(t)}},null,this._disposables)})}_launchDemo(){return s(this,void 0,void 0,function*(){if(d.controller){const e=o.Uri.joinPath(this._extensionUri,"media",`interactive-demo-v${d.controller._prevGenGuiEnabled?"1":"2"}.js`);let t=new n.TextDecoder("utf8").decode(yield o.workspace.fs.readFile(e));"darwin"===process.platform&&(t=t.replace(/`Ctrl/gm,"`⌘")),d.controller._createLanguageFile("JavaScript",t,"interactive-demo").then(e=>s(this,void 0,void 0,function*(){if(!d.controller._prevGenGuiEnabled&&e)try{o.debug.removeBreakpoints(o.debug.breakpoints.filter(t=>t.location.uri.path===e.document.uri.path)),o.debug.addBreakpoints([new o.SourceBreakpoint(new o.Location(e.document.uri,new o.Position(16,0)))]),o.commands.executeCommand("editor.fold",{selectionLines:[43,112]})}catch(e){console.error(e)}}))}})}_useCommunityEdition(){try{let e;try{e=JSON.parse(r.readFileSync(d.quokkaConfigPath))}catch(t){e={}}e.pro=!1,r.writeFileSync(d.quokkaConfigPath,JSON.stringify(e))}catch(e){}this._panel.webview.postMessage({command:"switchToCommunityEdition",licenseDetails:d.getLicenseDetails()})}_usePro(){try{let e;try{e=JSON.parse(r.readFileSync(d.quokkaConfigPath))}catch(t){e={}}e.pro=!0,r.writeFileSync(d.quokkaConfigPath,JSON.stringify(e))}catch(e){}this._panel.webview.postMessage({command:"switchToPro",licenseDetails:d.getLicenseDetails()})}_activateLicense({email:e,key:t}){if(!d.controller)return void this._panel.webview.postMessage({command:"activationError",message:"VS Code has not finished loading, please try and activate again later."});const i=new Date;let s=!1;d.controller.processLicenseChange(e||t,e=>{if(!s){s=!0;const t=new Date-i,o=e=>t<500?setTimeout(e,500-t):e();"notification"===e.type&&(e=e.text),"info"===e.type||"warning"===e.type?o(()=>this._panel.webview.postMessage({command:"activationSuccess",message:e.text,licenseDetails:d.getLicenseDetails()})):o(()=>this._panel.webview.postMessage({command:"activationError",message:e.text}))}}),e&&setTimeout(()=>{s||(s=!0,this._panel.webview.postMessage({command:"activationError",message:"A timeout occurred while attempting to validate your email address."}))},25e3)}_requestTrialLicense(t){const i=e("https"),s=JSON.stringify({email:t,type:"quokka",referrer:"qsp"}),o={hostname:"x55r2pae4l.execute-api.us-east-1.amazonaws.com",port:443,path:"/Prod/bc88894221b34ae4adac5c39a51547a2",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(s)}},n=i.request(o,e=>{200===e.statusCode?this._panel.webview.postMessage({command:"trialRequestSuccess"}):this._panel.webview.postMessage({command:"trialRequestError"})});n.on("error",e=>{this._panel.webview.postMessage({command:"trialRequestError"}),console.error(e)}),n.write(s),n.end()}static _checkForOffers(t){if(d.controller&&d.controller._salesEvent&&d.controller._salesEvent.saleInProgress())return void t({displayDiscount:!1,sale:!0,saleDiscount:d.controller._salesEvent.discountAmount()});if(void 0!==d._checkOffersResults)return void(d._checkOffersResults.discount&&d._checkOffersResults.discount>5?t(d._checkOffersResults):t({displayDiscount:!1}));let i=!1;e("./checkOffers").checkForOffers(e=>{i||(i=!0,e.offer_price&&e.list_price?(e.discount=Math.floor(100-100*e.offer_price/e.list_price),e.displayDiscount=e.discount>5,e.displayDiscount||(e.discount=0),d.controller&&d.controller._salesEvent&&d.controller._salesEvent.saleInProgress()&&(e.sale=!0,e.saleDiscount=d.controller._salesEvent.discountAmount()),d._checkOffersResults=e,t(e)):t({displayDiscount:!1}))}),setTimeout(()=>{i||(i=!0,d._checkOffersResults={},t({displayDiscount:!1}))},15e3)}static _getUserWhatsNewVersion(){if(void 0===d.userWhatsNewVersion)try{d.userWhatsNewVersion=JSON.parse(Buffer.from(r.readFileSync(d.startPage).toString())).version}catch(e){d.userWhatsNewVersion=0}return d.userWhatsNewVersion}static _saveUserWhatsNewVersion(e){try{return r.writeFileSync(d.startPage,JSON.stringify({version:e})),!0}catch(e){console.error(e)}return!1}static getLicenseDetails(){const e=d.controller&&d.controller._buildDate||new Date,t=c.getLicenseDetails(e);var i;return"community"===t.state&&d._checkForOffers(e=>{e&&d.currentPanel&&d.currentPanel._panel&&d.currentPanel._panel.webview.postMessage({command:"countryDiscount",offer:{discount:e.discount,country:(i=e.country,{AF:"Afghanistan",AL:"Albania",DZ:"Algeria",AS:"American Samoa",AD:"Andorra",AO:"Angola",AI:"Anguilla",AG:"Antigua and Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BS:"Bahamas",BH:"Bahrain",BD:"Bangladesh",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia",BA:"Bosnia and Herzegovina",BW:"Botswana",BV:"Bouvet Island",BR:"Brazil",IO:"Brit. Indian Ocean",VG:"British Virgin Islands",BN:"Brunei Darussalam",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",CF:"Central African Republic",TD:"Chad",CL:"Chile",CN:"China",CX:"Christmas Island",CC:"Cocos Islands",CO:"Colombia",KM:"Comoros",CG:"Congo",CK:"Cook Islands",CR:"Costa Rica",CI:"Cote D’Ivoire",HR:"Croatia",CU:"Cuba",CW:"Curaçao",CY:"Cyprus",CZ:"Czech Republic",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",GQ:"Equatorial Guinea",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FK:"Falkland Islands",FO:"Faroe Islands",FJ:"Fiji",FI:"Finland",FR:"France",GF:"French Guiana",PF:"French Polynesia",TF:"French Southern Terr.",GA:"Gabon",GM:"Gambia",GE:"Georgia",DE:"Germany",GH:"Ghana",GI:"Gibraltar",GR:"Greece",GL:"Greenland",GD:"Grenada",GP:"Guadeloupe",GU:"Guam",GT:"Guatemala",GG:"Guernsey",GN:"Guinea",GW:"Guinea-Bissau",GY:"Guyana",HT:"Haiti",HM:"Heard/ Mcdonald Islands",VA:"Holy See/ Vatican City",HN:"Honduras",HK:"Hong Kong",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IR:"Iran",IQ:"Iraq",IE:"Ireland",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JE:"Jersey",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KW:"Kuwait",KG:"Kyrgyzstan",LA:"Lao People’s DR",LV:"Latvia",LB:"Lebanon",LS:"Lesotho",LR:"Liberia",LY:"Libyan Arab Jamahiriya",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MO:"Macao",MK:"Macedonia",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MQ:"Martinique",MR:"Mauritania",MU:"Mauritius",YT:"Mayotte",MX:"Mexico",FM:"Micronesia",MD:"Moldova",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",MM:"Myanmar",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",AN:"Netherlands Antilles",NC:"New Caledonia",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NU:"Niue",NF:"Norfolk Island",KP:"North Korea",MP:"Northern Mariana Islands",NO:"Norway",OM:"Oman",PK:"Pakistan",PW:"Palau",PS:"Palestinian Territory",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn",PL:"Poland",PT:"Portugal",PR:"Puerto Rico",QA:"Qatar",RS:"Republic of Serbia",RE:"Reunion",RO:"Romania",RU:"Russian Federation",RW:"Rwanda",GS:"S. Georgia/ Sandwich Islands",SH:"Saint Helena",KN:"Saint Kitts and Nevis",LC:"Saint Lucia",PM:"Saint Pierre and Miquelon",VC:"Saint Vincent/ Grenadines",WS:"Samoa",SM:"San Marino",ST:"Sao Tome and Principe",SA:"Saudi Arabia",SN:"Senegal",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",KR:"South Korea",ES:"Spain",LK:"Sri Lanka",SD:"Sudan",SR:"Suriname",SJ:"Svalbard and Jan Mayen",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",SY:"Syrian Arab Republic",TW:"Taiwan",TJ:"Tajikistan",TZ:"Tanzania",TH:"Thailand",TL:"Timor-Leste",TG:"Togo",TK:"Tokelau",TO:"Tonga",TT:"Trinidad and Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks and Caicos Islands",TV:"Tuvalu",VI:"U.S. Virgin Islands",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States",UM:"United States (M.O.I.)",UY:"Uruguay",UZ:"Uzbekistan",VU:"Vanuatu",VE:"Venezuela",VN:"Vietnam",WF:"Wallis and Futuna",EH:"Western Sahara",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"}[i]),display:e.displayDiscount,sale:!!e.sale,saleDiscount:e.saleDiscount}})}),t}dispose(){for(d.currentPanel=void 0,this._panel.dispose(),this._panel=void 0;this._disposables.length;){const e=this._disposables.pop();e&&e.dispose()}}_update(){return s(this,void 0,void 0,function*(){const e=this._panel.webview;this._panel.webview.html=yield this._getHtmlForWebview(e)})}_getHtmlForWebview(e){return s(this,void 0,void 0,function*(){const t=o.Uri.joinPath(this._extensionUri,"media","index.html"),i=new n.TextDecoder("utf8").decode(yield o.workspace.fs.readFile(t)),s={nonce:function(){let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let i=0;i<32;i++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}(),cspSource:e.cspSource,root:e.asWebviewUri(this._extensionUri).toString()};return Object.keys(s).reduce((e,t)=>e.replace(new RegExp(("${"+t+"}").replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),"g"),s[t]),i)})}}d.quokkaFolder=a.join(l.homedir(),".quokka"),d.wallabyFolder=a.join(l.homedir(),".wallaby"),d.lkp=a.join(d.quokkaFolder,".qlc"),d.quokkaConfigPath=a.join(d.quokkaFolder,"config.json"),d.olp=a.join(d.wallabyFolder,".ol"),d.startPage=a.join(d.quokkaFolder,"startPage.json"),d.globalDefaults={autoLog:!1,showValueOnSelection:!1,showSingleInlineValue:!0,delay:0,logLimit:100,recycle:!1},d.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],d.viewType="quokkaStartPage",t.exports=d},{"./checkOffers":5,"./licenseReader":8,fs:void 0,https:void 0,os:void 0,path:void 0,util:void 0,vscode:void 0}],13:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,n){function a(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,r)}l((s=s.apply(e,t||[])).next())})};const o=e("vscode"),n=global._,a=o.window,r=e("./compositeDisposable").default;let l;class c{constructor(e,t){this._ts=+new Date,this._disposables=new r,this._quokkaFileUri=e,this._quokkaFileName=t,this._opacityMultiplier=o.workspace.getConfiguration().get("quokka.dimmedTextOpacity",50),this._onDidChange=new o.EventEmitter,this._onDidChangeCodeLenses=new o.EventEmitter;const i=new o.ThemeColor("editorCodeLens.foreground");this._annotationDecorationType=o.window.createTextEditorDecorationType({rangeBehavior:o.DecorationRangeBehavior.ClosedOpen,textDecoration:"none",before:{height:"100%",margin:"0 26px 0 0"}}),this._subtleDecorationType=o.window.createTextEditorDecorationType({rangeBehavior:o.DecorationRangeBehavior.ClosedOpen,textDecoration:"none",opacity:this._getOpacity(.3)}),this._logDecorationType=o.window.createTextEditorDecorationType({isWholeLine:!0,light:{after:{color:"#0000ff"}},dark:{after:{color:"rgba(86, 156, 214, 1)"}}}),this._systemLogDecorationType=o.window.createTextEditorDecorationType({isWholeLine:!0,after:{color:i}}),this._errorDecorationType=o.window.createTextEditorDecorationType({isWholeLine:!0,light:{after:{color:"#c80000"}},dark:{after:{color:"#fe536a"}}}),this._lineNumberStyle={color:i,opacity:this._getOpacity(.6)},this._fileContentSeparatorStyle={color:i,opacity:this._getOpacity(.5)},this._content={},this._disposables.add(()=>{this._annotationDecorationType.dispose(),this._subtleDecorationType.dispose(),this._logDecorationType.dispose(),this._systemLogDecorationType.dispose(),this._errorDecorationType.dispose()})}_getOpacity(e){if(50===this._opacityMultiplier)return e.toFixed(2);if(this._opacityMultiplier<50)return Math.max(0,e-e*(50-this._opacityMultiplier)/50).toFixed(2);{const t=1-e;return Math.min(1,e+t*(this._opacityMultiplier-50)/50).toFixed(2)}}get onDidChange(){return this._onDidChange.event}get onDidChangeCodeLenses(){return this._onDidChangeCodeLenses.event}_initialize(){this._initialized||(this._definitionProvider=o.languages.registerDefinitionProvider({scheme:"quokka-code-timeline",language:"quokka-timeline"},this),this._codeLensProvider||(this._codeLensProvider=o.languages.registerCodeLensProvider({scheme:"quokka-code-timeline",language:"quokka-timeline"},this)),this._changeRevealIfOpenSetting(),this._initialized=!0)}clear(e){this._initialized&&(this._definitionProvider.dispose(),delete this._content,delete this._expectingTimelineLoad,e.forEach(e=>this._resetAllDecorations(e)),this._uri&&this._onDidChange.fire(this._uri),this._restoreRevealIfOpenSetting(),delete this._uri,delete this._initialized)}uri(){return this._uri}dispose(){this.clear([]),this._codeLensProvider&&(this._codeLensProvider.dispose(),delete this._codeLensProvider)}expectingTimelineLoad(){this._expectingTimelineLoad=!0}isExpectingTimelineLoad(){return this._expectingTimelineLoad}provideTextDocumentContent(){return this._providedTextDocumentContent=l===this._uri?(this._content||{}).text||"":null,this._providedTextDocumentContent}provideDefinition(e,t){if(!this._content||this._updating)return;const i=this._content.lines[t.line];return i&&i.file&&i.num?new o.Location(this._quokkaFileUri,new o.Position(i.num-1,t.character)):void 0}provideCodeLenses(e){if(this._initialized&&(this._onCodeLensProvided&&(this._onCodeLensProvided(),delete this._onCodeLensProvided),this._content&&this._content.codeLens&&!this._updating))return this._content.codeLens}static prepareContentText(e){return e.replace(/ /g," ")}getLineByStep(e){if(this._content)return this._content.lineByStep[e]}getOriginalLocationByLine(e){if(!this._content)return;const t=this._content.lines[e-1];if(!t||!t.file||!t.num)return;let i=t.step;if(!(i>=0))for(let t=e;t<this._content.lines.length&&!((i=this._content.lines[t].step)>=0);t++);return{file:t.file,line:t.num,step:i}}_changeRevealIfOpenSetting(){try{const e=o.workspace.getConfiguration();this._revealIfOpenSetting=(e.inspect("workbench.editor.revealIfOpen")||{}).globalValue,e.update("workbench.editor.revealIfOpen",!0,!0)}catch(e){}}_restoreRevealIfOpenSetting(){try{o.workspace.getConfiguration().update("workbench.editor.revealIfOpen",this._revealIfOpenSetting,!0),delete this._revealIfOpenSetting}catch(e){}}closing(){this._closing=new Promise(e=>{this._closed=e})}isClosing(){return!!this._closing}closed(){this._closed(),delete this._closing,delete this._closed}isActive(){return!this.isClosing()&&this._initialized}show(e,t){return s(this,void 0,void 0,function*(){try{if(!e)return;this._closing&&(t.length=0,yield this._closing);const i=!!t.length;if(this._content=this._generateDecoratedContent(e),this._initialize(),l=this._uri=o.Uri.parse(`quokka-code-timeline://authority/${this._ts}/Quokka Code Story`),!t.length){yield this._updateTimelineDocument();const e={preview:!1,viewColumn:-2,preserveFocus:!0},i=yield o.window.showTextDocument(this._uri,e);i.options.lineNumbers=o.TextEditorLineNumbersStyle.Off,o.languages.setTextDocumentLanguage(i.document,"quokka-timeline"),t=[i]}yield Promise.all(t.map(e=>this._updateEditor(e,i)))}finally{delete this._expectingTimelineLoad}})}_updateTimelineDocument(){return s(this,void 0,void 0,function*(){void 0!==this._providedTextDocumentContent&&this._content.text!==this._providedTextDocumentContent&&(yield new Promise(e=>{const t=o.workspace.onDidChangeTextDocument(s=>{s.document&&s.document.uri&&"quokka-code-timeline"===s.document.uri.scheme&&(clearTimeout(i),t.dispose(),e())}),i=setTimeout(()=>{t.dispose(),e()},2e3);this._onDidChange.fire(this._uri)}))})}_updateEditor(e,t){return s(this,void 0,void 0,function*(){if(this._updating=!0,t){const e=new Promise(e=>{const t=setTimeout(()=>{e()},500);this._onCodeLensProvided=(()=>{clearTimeout(t),setImmediate(e)})});this._onDidChangeCodeLenses.fire(),yield e}yield this._updateTimelineDocument(),delete this._updating,this._onDidChangeCodeLenses.fire(),this._resetAllDecorations(e),this._updateDecorations(e)})}update(e){e.options.lineNumbers=o.TextEditorLineNumbersStyle.Off,this._updateDecorations(e)}isTimelineLoaded(){return!!this._content}_updateDecorations(e){if(!e)return;if(!e.document||!e.document.uri||"quokka-code-timeline"!==e.document.uri.scheme)return;const t=this._content;t?(e.setDecorations(this._annotationDecorationType,t.annotationDecorations),e.setDecorations(this._subtleDecorationType,t.subtleDecorations),e.setDecorations(this._errorDecorationType,t.errorDecorations)):this._resetAllDecorations(e)}_resetAllDecorations(e){e.setDecorations(this._logDecorationType,[]),e.setDecorations(this._systemLogDecorationType,[]),e.setDecorations(this._errorDecorationType,[]),e.setDecorations(this._annotationDecorationType,[]),e.setDecorations(this._subtleDecorationType,[])}updateTimelineEditorInlineValueDecorations(e,t,i){if(!e||!t||!i)return;if(!e.document||!e.document.uri||"quokka-code-timeline"!==e.document.uri.scheme)return;const s=this.getOriginalLocationByLine(t);if(!s)return;const n=i[s.file];if(!n||!n.lines||!n.lines.length)return;const a=n.lines.find(e=>e.num===s.line);if(!a)return;const r=e.document.lineAt(t-1);if(!r)return;const l={range:new o.Range(r.lineNumber,r.firstNonWhitespaceCharacterIndex,r.lineNumber,r.range.end.character)},c=a.log||"",d=a.longLog||c;d&&(l.hoverMessage=o.MarkdownString?new o.MarkdownString("```js\n"+d+"\n```"):d),l.renderOptions={after:{contentText:" ".repeat(2)+c}};const u=a.meta&&a.meta.system?this._systemLogDecorationType:this._logDecorationType;e.setDecorations(this._logDecorationType,[]),e.setDecorations(this._systemLogDecorationType,[]),c&&e.setDecorations(u,[l])}_generateDecoratedContent(e){const t=[],i=[],s=[],n=[];let a,r,l,d;const u=[],h={},p=()=>u.length-1,_=e.maxLineNumber.toString().length,g=e=>{const i=p();t.push({range:new o.Range(i,0,i,1),renderOptions:{before:Object.assign({contentText:c.prepareContentText((e=>`${" ".repeat(_-e.toString().length)}${e}`)(e))},this._lineNumberStyle)}})},m=()=>{const e=p();t.push({range:new o.Range(e,0,e,1),renderOptions:{after:Object.assign({contentText:c.prepareContentText("…")},this._fileContentSeparatorStyle)}})},v=(e,t,n)=>{for(const l of t){const t=l.n||"",c=l.content?`${l.content}`:l.separator?"​​":" ",d={text:c,num:t,file:e};u.push(d),l.separator&&m();const _=p();if(l.executedLine){l.steps=l.steps||[n];for(const e of l.steps)h[e]=_;if(l.error){const e={range:new o.Range(_,0,_,c.length)},t=l.error;e.renderOptions={after:{contentText:" ".repeat(2)+t}},s.push(e)}d.step=l.steps[0],void 0===a&&(a=d.step),r=l.steps[l.steps.length-1]}if((!l.executedLine||l.contextRanges)&&!l.separator)if(l.contextRanges)for(const[e,t]of l.contextRanges)i.push({range:new o.Range(_,e,_,t)});else i.push({range:new o.Range(_,0,_,c.length)});g(t)}};e.truncatedStart&&(u.unshift({text:"​"}),l=new o.CodeLens(new o.Range(1,0,1,1),{title:"Load previous entries",command:"quokka.viewCodeStory"}),u.push({text:"​"}));for(const t of e.entries)t.file&&(t.file,u.push({text:"​"}),t.hideable&&n.push(new o.CodeLens(new o.Range(u.length-2,0,u.length-2,1),{title:"Hide repeated entries like this",command:"quokka.viewCodeStory",arguments:[{hide:t}]}))),v(t.file,t.lines,t.step),u.push({text:"​"});return e.truncatedEnd&&(u.push({text:" "}),u.push({text:" "}),d=new o.CodeLens(new o.Range(u.length-1,0,u.length-1,1),{title:"Load next entries",command:"quokka.viewCodeStory"})),l&&(l.command.arguments=[{before:a}],n.push(l)),d&&(d.command.arguments=[{after:r}],n.push(d)),{lines:u,lineByStep:h,text:u.map(e=>e.text).join("\n"),annotationDecorations:t,subtleDecorations:i,errorDecorations:s,codeLens:n}}}class d{constructor(e,t,i){this._traceContext={},this._onUpdate=[],this._extensionContext=e,this._session=i,this.id=i.id}asAbsolutePath(e){return this._extensionContext.asAbsolutePath(e)}scheduleOnUpdate(e){this._onUpdate.push(e)}runPendingUpdates(){n.each(this._onUpdate,e=>{try{return e()}catch(e){}}),this._onUpdate.length=0}requestTrace(e){return new Promise(t=>this._session.requestTrace(e,e=>t(e)))}updateTraceContextCurrentFrame(e,t=!0){this._session.isDisposed()||this._session.traceContext({currentFrame:e,captureCallStackFrame:t?this._traceContext.frame:void 0})}requestCallStack(){this._session.isDisposed()||(this._session.traceContext({captureCallStackFrame:this._traceContext.frame}),this._session.runTests({file:this._session.fileName,evaluateExpression:!0}))}stopTraceNavigation(){var e;this._session.isDisposed()||(null===(e=this._session.output)||void 0===e||e.refreshHeaderCommands(),this._session.traceContext({stopNavigation:!0}))}traceNavigationStarted(){var e;null===(e=this._session.output)||void 0===e||e.refreshHeaderCommands()}requestTestTimeline(e,t){return this._session.requestTestTimeline(e,t)}}t.exports=class{constructor(e,t,i){this._disposables=new r,this._activeTraceFrameWithNowhereToGoDecorationType=a.createTextEditorDecorationType({rangeBehavior:1,borderStyle:"solid",borderRadius:"2px",borderWidth:"1px",dark:{backgroundColor:"rgba(255, 0, 0, 0.2)",borderColor:"rgba(255, 0, 0, 0.2)"},light:{backgroundColor:"rgba(255, 0, 52, 0.35)",borderColor:"rgba(255, 0, 52, 0.35)"}}),this._activeTraceFrameDecorationType=a.createTextEditorDecorationType({rangeBehavior:1,borderStyle:"solid",borderRadius:"2px",borderWidth:"1px",dark:{backgroundColor:"rgba(255, 255, 0, 0.2)",borderColor:"rgba(255, 255, 0, 0.2)"},light:{backgroundColor:"rgba(255, 255, 102, 0.45)",borderColor:"rgba(255, 255, 102, 0.45)"}}),this._activeTraceCallStackFrameDecorationType=a.createTextEditorDecorationType({rangeBehavior:1,borderStyle:"solid",borderRadius:"2px",borderWidth:"1px",dark:{backgroundColor:"rgba(122, 189, 122, 0.3)",borderColor:"rgba(122, 189, 122, 0.3)"},light:{backgroundColor:"rgba(206, 231, 206, 0.45)",borderColor:"rgba(206, 231, 206, 0.45)"}}),this._codeStoryContentProvider=new c(i.textDocument.uri,i.fileName),this._disposables.add(o.workspace.registerTextDocumentContentProvider("quokka-code-timeline",this._codeStoryContentProvider)),this._disposables.add(()=>{this._activeTraceFrameWithNowhereToGoDecorationType.dispose(),this._activeTraceFrameDecorationType.dispose(),this._activeTraceCallStackFrameDecorationType.dispose(),this._codeStoryContentProvider.dispose(),this._setTraceBeingNavigatedContext(!1)}),this._sessionContext=new d(e,t,i),this._onTraceNavigationStarted=new o.EventEmitter,this.onTraceNavigationStarted=this._onTraceNavigationStarted.event}requestTrace(e={}){return this._sessionContext.requestTrace(e)}traceNavigated(e){const t={};return e&&(this._currentStep=e,this._sessionContext._traceContext.frame=e.frame),!this.traceBeingNavigated()&&this._autoPlayCodeOnStart&&(this.autoPlayCode(),delete this._autoPlayCodeOnStart),this._setTraceBeingNavigatedContext(!0),this._sessionContext.traceNavigationStarted(),!e&&this.lastActiveStep()&&(t.decorationType=this._activeTraceFrameWithNowhereToGoDecorationType,t.step=this.lastActiveStep(),this.traceBeingAutoPlayed()&&o.commands.executeCommand("quokka.pauseCodeExecution")),e&&(t.decorationType=this._activeTraceFrameDecorationType,t.step=e),t}activeTraceFrameDecorationType(){return this._activeTraceFrameDecorationType}activeTraceCallStackFrameDecorationType(){return this._activeTraceCallStackFrameDecorationType}lastActiveStep(){return this._currentStep}dispose(){this._disposed||(this.closeCodeStory(!0),this._disposables.dispose(),this._disposed=!0,delete this._currentStep,clearTimeout(this._autoPlayTimeout),delete this._autoPlayTimeout)}destroyStackTraceDecorations(e){if(e)try{e.setDecorations(this._activeTraceFrameDecorationType,[]),e.setDecorations(this._activeTraceCallStackFrameDecorationType,[]),e.setDecorations(this._activeTraceFrameWithNowhereToGoDecorationType,[])}catch(e){}}anyVisibleCodeStoryEditors(){return!!a.visibleTextEditors.find(e=>this.isCodeStoryViewer(e))}isCodeStoryViewer(e){return e&&e.document&&e.document.uri&&"quokka-code-timeline"===e.document.uri.scheme}isActiveCodeStoryViewer(e){return this.isCodeStoryViewer(e)&&this._codeStoryContentProvider.isActive()}getCodeStoryLineByStep(e){return this._codeStoryContentProvider.getLineByStep(e)}getOriginalLocationByCodeStoryLine(e){return this._codeStoryContentProvider.getOriginalLocationByLine(e)}forEachVisibleCodeStoryEditor(e){return a.visibleTextEditors.filter(e=>this.isCodeStoryViewer(e)).forEach(e)}_visibleCodeStoryEditors(){return a.visibleTextEditors.filter(e=>this.isCodeStoryViewer(e))}viewCodeStory(){return s(this,arguments,void 0,function*(e={reveal:!0}){if(!this._codeStoryContentProvider.isExpectingTimelineLoad())return this._codeStoryContentProvider.expectingTimelineLoad(),new Promise(t=>this._sessionContext.requestTestTimeline(e,e=>s(this,void 0,void 0,function*(){yield this._codeStoryContentProvider.show(e,this._visibleCodeStoryEditors()),t()})))})}closeCodeStory(e){return s(this,void 0,void 0,function*(){const t=this._codeStoryContentProvider.uri();if(this._codeStoryContentProvider.clear(this._visibleCodeStoryEditors()),t&&!this._codeStoryContentProvider.isClosing())try{this._codeStoryContentProvider.closing(),e&&(yield a.showTextDocument(t,{preserveFocus:!1}),yield new Promise(e=>setTimeout(()=>e(),100)),this.isCodeStoryViewer(a.activeTextEditor)&&(yield o.commands.executeCommand("workbench.action.closeActiveEditor")))}catch(e){}finally{this._codeStoryContentProvider.closed()}})}updateTimelineEditorInlineValueDecorations(e,t,i){return this._codeStoryContentProvider.updateTimelineEditorInlineValueDecorations(e,t,i)}isClosingCodeStory(){return this._codeStoryContentProvider.isClosing()}updateCodeStoryIfLoaded(e){if(this._codeStoryContentProvider.isTimelineLoaded())return this._codeStoryContentProvider.update(e),!0}traceBeingNavigated(){return this._traceBeingNavigated}traceBeingAutoPlayed(){return!!this._autoPlayTimeout}stopTraceNavigation(){n.each(a.visibleTextEditors,e=>this.destroyStackTraceDecorations(e)),this._setTraceBeingNavigatedContext(!1),this.pauseCodeExecution(),this._sessionContext.stopTraceNavigation()}requestCallStack(){this._sessionContext.requestCallStack()}updateTraceContextCallStackFrame(e){this._sessionContext.updateTraceContextCurrentFrame(e.frame)}hideCallStack(){this._sessionContext.updateTraceContextCurrentFrame(this._currentStep&&this._currentStep.frame,!1)}autoPlayCodeOnStart(){this._autoPlayCodeOnStart=!0}autoPlayCode(){o.commands.executeCommand("setContext","quokka.traceBeingAutoPlayed",!0),this._autoPlayCode()}_autoPlayCode(e=!0){const t=o.workspace.getConfiguration().get("quokka.codeAutoPlayDelay",1e3),i=Math.max(t-50,50);this._autoPlayTimeout=setTimeout(()=>{e?n.each(a.visibleTextEditors,e=>this.destroyStackTraceDecorations(e)):o.commands.executeCommand("quokka.playTraceNextStep"),this._autoPlayCode(!e)},e?i:50)}pauseCodeExecution(){o.commands.executeCommand("setContext","quokka.traceBeingAutoPlayed",!1),clearTimeout(this._autoPlayTimeout),delete this._autoPlayTimeout}_setTraceBeingNavigatedContext(e){o.commands.executeCommand("setContext","quokka.traceBeingNavigated",e);const t=!!this._traceBeingNavigated;this._traceBeingNavigated=e,e&&!t&&this._onTraceNavigationStarted.fire()}}},{"./compositeDisposable":6,vscode:void 0}],14:[function(e,t,i){"use strict";const s=e("vscode"),o=global._;class n{constructor(e){this._context=e,this._docsNode=this._createDocsNode(),this._treeDataProvider=new l(this._docsNode),this._treeDataProvider._rootNodes={},this._treeView=s.window.createTreeView("quokkaValueExplorer",{treeDataProvider:this._treeDataProvider}),this._treeView.onDidExpandElement(e=>e.element.uiCollapsibleState=2),this._treeView.onDidCollapseElement(e=>e.element.uiCollapsibleState=1)}_createDocsNode(e){return{label:"No logged values, click to see the feature docs",iconPath:this._context.asAbsolutePath("images/question.svg"),command:{command:"vscode.open",arguments:[s.Uri.parse("https://quokkajs.com/docs/#value-explorer")]},getParent:()=>e,getLine:()=>void 0}}remove(e){const t=this._treeDataProvider._rootNodes,i=t[e.id];delete t[e.id],i&&i._context.cancelPendingUpdates(),this._treeDataProvider.refresh()}update(e,t){let i=this._treeDataProvider._rootNodes[e.id];if(!i){const t=new a(this._context,e);i=new r(t,{label:{name:`${e.id}`},id:e.id,sessionNode:!0,disallowToCopyPath:!0,disallowToCopyData:!0}),this._treeDataProvider._rootNodes[e.id]=i}i._children=o.chain(t).map(e=>{let t=(e.valueBag||{}).data;if(!t)return;t.name||n.removeExcessiveSpacesTabsLineBreaks(e.text||"").startsWith(n.removeExcessiveSpacesTabsLineBreaks(e.context||"").replace(/\.\.\.$/g,""))||(t.name=n.removeExcessiveSpacesTabsLineBreaks(e.context||""));const i=(e.loc||"").split(":")[0];return i&&(t.name=`line ${i}${t.name?`: ${t.name}`:""}`,t.line=parseInt(i,10)),t.label=t.label||{},t.label.name=t.name,t.context=e.context,t.rootValueNode=!0,t}).filter(e=>!!e).map(e=>new r(i._context,e,i,e.autoExpand)).value(),i._context.runPendingUpdates(),i._children&&i._children.length||(i._children=[this._createDocsNode(i)]),this._treeDataProvider.refresh()}reveal(e,t){const i=this._treeDataProvider._rootNodes[e];if(!i)return this._reveal(this._docsNode,{expand:!1,focus:!1,select:!1});const s={expand:!0,focus:!0},o=i.getChildren();if(o)if("function"==typeof o[Symbol.iterator]){for(const e of o)if(e.getLine()===t)return void this._reveal(e,s);this._reveal(i,s)}else o.then(()=>{const i=this._treeDataProvider._rootNodes[e];if(i){const e=i.getChildren();if(e)for(const i of e)if(i.getLine()===t)return void this._reveal(i,s);this._reveal(i,s)}});else this._reveal(i,s)}_reveal(e,t){return this._treeView.reveal(e,t).catch(()=>this._treeView.reveal(e,t).catch(e=>console.error(e)))}static removeExcessiveSpacesTabsLineBreaks(e){return e&&e.replace(/\r\n\s*/g," ").replace(/\n\s*/g," ")}}class a{constructor(e,t){this._expressionsToEvaluate={},this._onUpdate=[],this._extensionContext=e,this._session=t,this.id=t.id}asAbsolutePath(e){return this._extensionContext.asAbsolutePath(e)}getPathData(e){let t=this._expressionsToEvaluate;return o.each(e,e=>{t[e]=t[e]||{},t=t[e]}),t}isPathRequested(e,t){let i=this._expressionsToEvaluate;const s=o.every(e,e=>!!i[e]&&(i=i[e],!0));return s&&t?JSON.stringify(t)===JSON.stringify(i):s}requestNodes(e,t){let i=this._expressionsToEvaluate;o.each(e,e=>{i[e]=i[e]||{},i=i[e]}),t&&(i.props=t.props,i.strLength=t.strLength,i.ranges=t.ranges),this._session.isDisposed()||(this._session.expressionsToEvaluate(this._expressionsToEvaluate),this._session.runTests({file:this._session.fileName}))}scheduleOnUpdate(e){this._onUpdate.push(e)}copyToClipboard(e){!this._session.isDisposed()&&this._session.copyToClipboard(e)}cancelPendingUpdates(){this._onUpdate=[]}runPendingUpdates(){o.each(this._onUpdate,e=>e()),this._onUpdate.length=0}}class r{constructor(e,t,i,o){this._context=e,this._parent=i,this._data=t;const{label:n,description:a}=this._createLabelAndDescription();this.label=n,this.description=a,this._queryPath=t.queryPath,this.id=(o?"A":"")+this._context.id+"."+t.id,this.iconPath=this._getIconPath(),t.disallowToCopyPath||(this.contextValue+="QuokkaAllowToCopyPath"),t.disallowToCopyData||(this.contextValue+="QuokkaAllowToCopyData"),this._autoExpand=o&&!this._data.cappedProps&&!this._data.capped&&!this._data.loadActionNode&&!this._data.rangeNode&&"string"!==this._data.type&&!this._data.getter&&!this._data.setter,t.sessionNode?this.collapsibleState=2:this.collapsibleState=t.expandable?this._autoExpand?2:1:0,t.rangeNode&&(this._parentArray=i._parentArray||i,this._queryPath=this._parentArray._queryPath),t.sessionNode&&(this.iconPath=s.ThemeIcon.File,this.resourceUri=s.Uri.file(this.id))}getChildren(){if(this._children)return this._children;if("string"===this._data.type)return this._getChildren({strLength:Number.MAX_VALUE});if(this._data.loadActionNode)return this._getChildren({props:Number.MAX_VALUE});const e=(this._data.props&&this._data.props.length?this._data.props:[]).map(e=>new r(this._context,e,this,this._autoExpand)),t=e=>e._data.functionsNode||e._data.loadActionNode||e._data.callStackNode;if(this._data.rangeNode||"array"===this._data.type||"Map"===this._data.type||"Set"===this._data.type||e.sort(function(e,i){if(t(e)||t(i))return 0;const s=((e._data.label||{}).name||"").toLowerCase(),o=((i._data.label||{}).name||"").toLowerCase();return s<o?-1:s>o?1:0}),e.length)return Promise.resolve(e);if(this._data.rangeNode){let e=this._context.getPathData(this._queryPath);const t=new Set((e.ranges&&e.ranges.props||[]).filter(e=>!0===e.props||e.props.length&&!e.props[0].rangeNode).map(e=>e.id));return this._getChildren({ranges:{props:JSON.parse(JSON.stringify(this._parentArray._data.props,(e,i)=>(i.props&&(!i.props.length&&i===this._data||i.props.length&&!i.props[0].rangeNode||t.has(i.id))&&(i.props=!0),i))),length:this._parentArray._data.length}})}return this._getChildren()}getParent(){return this._parent}getLine(){return this._data.line}copyExpressionPath(){(this._data||{}).expressionPath&&this._context.copyToClipboard(this._data.expressionPath.join(""))}copyExpressionData(){this._data&&this._context.copyToClipboard(this._data)}_getChildren(e){return this._context.isPathRequested(this._queryPath,e)?[]:(this._context.requestNodes(this._queryPath,e),new Promise((e,t)=>{this._context.scheduleOnUpdate(e)}))}_getIconPath(){if(this._data.getter)return this._context.asAbsolutePath("images/getter.svg");if(this._data.functionsNode)return this._context.asAbsolutePath("images/function.svg");if(this._data.loadActionNode)return this._context.asAbsolutePath("images/more.svg");if(this._data.error)return this._context.asAbsolutePath("images/error.svg");if(this._data.rangeNode)return this._context.asAbsolutePath("images/range.svg");if(!this._data.sessionNode){if(this._data.type)switch(this._data.type.toLowerCase()){case"string":if(this._data.capped)return this._context.asAbsolutePath("images/cappedString.svg");case"object":case"array":case"number":case"function":case"boolean":case"date":case"regexp":case"symbol":case"null":case"undefined":return this._context.asAbsolutePath(`images/${this._data.type.toLowerCase()}.svg`)}return this._context.asAbsolutePath("images/object.svg")}}_createLabelAndDescription(){const e=this._parent&&this._parent._data&&this._parent._data.sessionNode,t={label:"",description:""},i=this._data.label;return e?(t.label=i.value||"",t.description=(i.name||"")+(i.type?` ${i.type}`:"")):(i.name&&(t.label+=i.name),i.value&&(t.label+=(i.name?": ":"")+i.value),i.type&&(t.description=`${i.type}`)),t}}class l{constructor(e){this._onDidChangeTreeData=new s.EventEmitter,this.onDidChangeTreeData=this._onDidChangeTreeData.event,this._docsNode=e}refresh(){this._onDidChangeTreeData.fire()}getTreeItem(e){return e}getParent(e){if(e)return e.getParent()}getChildren(e){return e?e.getChildren():o.isEmpty(this._rootNodes)?Promise.resolve([this._docsNode]):Promise.resolve(o.chain(this._rootNodes).values().sortBy(e=>e._data.name).value())}}t.exports=n},{vscode:void 0}],15:[function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(o,n){function a(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,r)}l((s=s.apply(e,t||[])).next())})};Object.defineProperty(i,"__esModule",{value:!0}),i.IntegratedWebviewViewProvider=void 0;const o=e("path"),n=e("fs"),a=e("vscode"),r=e("lodash"),l=e("fs");function c(e,t,i,c,d){return s(this,void 0,void 0,function*(){if("quokka.output"===i.context){i.editor="vscode";const u=c?(0,o.join)(t.fsPath,"node_modules/wallaby-ui/dist"):(0,o.join)(d,"ui"),h=(0,o.join)(u,"index.html"),p=e.webview,_=p.asWebviewUri(a.Uri.file(u)),g=()=>s(this,void 0,void 0,function*(){(0,l.existsSync)(h)?p.html=(0,n.readFileSync)(h).toString().replace('<script id="editor-integration"><\/script>',`<script id="editor-integration">window["wallaby-bootstrapper"] = ${JSON.stringify(i)};<\/script>`).replace(/\.\/assets\//g,`${_}/assets/`):console.warn(`Wallaby: entry point file not found: ${h}`)});yield(()=>s(this,void 0,void 0,function*(){if(c)try{const t="http://localhost:3001",s=yield(yield fetch(t)).text(),o=e=>e.replace(/(?<=<script[^>]*\ssrc=["'])(?!http:\/\/|https:\/\/)/g,t);p.html=o(s).toString().replace('<script id="editor-integration"><\/script>',`\n  <script type="text/javascript">\n  (function(originalFetch) {\n    window.fetch = function(url, config) {\n      return originalFetch('${t}' + url, config);\n    };\n  })(fetch);\n  <\/script>\n  <style type="text/css">\n  @font-face {\n    font-family: "codicon";\n    font-display: block;\n    src: url("${t}/node_modules/@vscode/codicons/dist/codicon.ttf") format("truetype");\n  }\n  </style>\n  <script id="editor-integration">window["wallaby-bootstrapper"] = ${JSON.stringify(i)};<\/script>`).replace(/\.\/assets\//g,`${_}/assets/`)}catch(t){console.error("Failed to load webview from local server, attempting to load from file system",t),g();const i=(0,n.watch)(h,(0,r.debounce)(()=>g(),750));e.onDidDispose(()=>i.close())}else g()}))()}})}i.IntegratedWebviewViewProvider=class{constructor(e,t,i,s,o=!1,n){this._name=e,this._webviewViewHandle=t,this._context=i,this._args=s,this._debug=o,this._coreFolder=n}resolveWebviewView(e,t,i){return s(this,void 0,void 0,function*(){this._webviewViewHandle.webviewView=e,this._webviewViewHandle.activate=this.activate.bind(this),this._webviewViewHandle.remove=this.remove.bind(this),e.webview.options={enableScripts:!0,enableCommandUris:!0,localResourceRoots:[this._context.extensionUri,a.Uri.file((0,o.join)(this._coreFolder(),"ui"))]};const t=Object.assign({context:this._name,checkTimers:!0},this._args()||{});yield c(e,this._context.extensionUri,t,this._debug,this._coreFolder()),e.onDidDispose(()=>{i.dispose(),this._webviewViewHandle.webviewView=void 0});const i=function(e,t,i,s,o){let n,r;const l=e.webview.onDidReceiveMessage(a=>{"firstPing"===a.type&&(n=!0,r=setTimeout(()=>{l.dispose(),i.checkTimers=!1,c(e,t,i,s,o)},10)),"secondPing"===a.type&&n&&(clearTimeout(r),e.webview.postMessage({type:"allowedToStart"}))});return new a.Disposable(()=>{l.dispose(),clearTimeout(r)})}(e,this._context.extensionUri,t,this._debug,this._coreFolder())})}activate(e){var t;null===(t=this._webviewViewHandle.webviewView)||void 0===t||t.webview.postMessage({type:"activate",address:e})}remove(e){var t;null===(t=this._webviewViewHandle.webviewView)||void 0===t||t.webview.postMessage({type:"remove",address:e})}}},{fs:void 0,lodash:void 0,path:void 0,vscode:void 0}]},{},[2]);